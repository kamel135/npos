var no=Object.defineProperty,ao=Object.defineProperties;var lo=Object.getOwnPropertyDescriptors;var jt=Object.getOwnPropertySymbols;var ro=Object.prototype.hasOwnProperty,io=Object.prototype.propertyIsEnumerable;var Bt=(o,p,a)=>p in o?no(o,p,{enumerable:!0,configurable:!0,writable:!0,value:a}):o[p]=a,Be=(o,p)=>{for(var a in p||(p={}))ro.call(p,a)&&Bt(o,a,p[a]);if(jt)for(var a of jt(p))io.call(p,a)&&Bt(o,a,p[a]);return o},Qe=(o,p)=>ao(o,lo(p));var U=(o,p,a)=>new Promise((l,f)=>{var x=u=>{try{r(a.next(u))}catch(d){f(d)}},w=u=>{try{r(a.throw(u))}catch(d){f(d)}},r=u=>u.done?l(u.value):Promise.resolve(u.value).then(x,w);r((a=a.apply(o,p)).next())});import{c as n,o as s,f as e,g as T,t,i as C,P as De,z as be,l as X,m as We,w as W,d as se,u as B,G as pe,e as we,F as me,B as ve,q as xe,H as Ce,J as Re,K as Ve,$ as dt,I as Et,M as Ze,y as Fe,W as nt,x as et,a as xt,L as Tt,j as Dt,N as uo,a0 as st,V as fe,a1 as Vt,E as co,a2 as mo,A as ut,a3 as zt,D as Nt,a4 as Lt,k as fo,U as Rt,a5 as po,v as pt}from"./index-CLcWQdf2.js";import{f as Ut,g as vo,a as Ft,h as go,_ as vt,i as _o,s as ho,j as yo,k as xo}from"./posUI-DTgWktYq.js";const bo={class:"flex-1 flex items-center justify-center bg-gray-50"},wo={class:"text-center"},ko={key:0,class:"mt-4 text-sm text-gray-500"},dp={__name:"LoadingSpinner",props:{text:{type:String,default:__("Loading...")}},setup(o){return(p,a)=>(s(),n("div",bo,[e("div",wo,[a[0]||(a[0]=e("div",{class:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"},null,-1)),o.text?(s(),n("p",ko,t(o.text),1)):T("",!0)])]))}},$o={class:"flex flex-col gap-4"},Co={key:0,class:"bg-blue-50 rounded-lg p-3"},So={class:"flex items-center gap-3"},Po={class:"w-12 h-12 bg-gray-100 rounded-md flex-shrink-0 flex items-center justify-center overflow-hidden"},Mo=["src","alt"],Io={key:1,class:"h-6 w-6 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Eo={class:"flex-1"},Do={class:"text-sm font-semibold text-gray-900"},Vo={class:"text-xs text-gray-600"},Ao={key:0},jo={class:"text-sm font-bold text-gray-900"},Bo={key:1},To={class:"block text-sm font-medium text-gray-700 mb-2"},zo={class:"flex flex-col gap-2 max-h-80 overflow-y-auto"},Lo=["onClick"],Ro={class:"flex items-start justify-between"},Oo={class:"flex-1"},No={class:"text-sm font-semibold text-gray-900"},Uo={class:"flex items-center gap-3 mt-1"},Fo={class:"text-xs text-gray-600"},qo={key:0,class:"text-xs text-gray-600"},Ho={key:0,class:"flex-shrink-0"},Wo={key:2},Go={class:"flex items-center justify-between mb-2"},Qo={class:"block text-sm font-medium text-gray-700"},Ko={key:0,class:"ms-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"},Jo={class:"flex gap-2"},Yo={class:"relative mb-3"},Xo=["placeholder"],Zo={key:0,class:"flex items-center justify-center py-8"},es={class:"ms-2 text-sm text-gray-600"},ts={key:1,class:"text-center py-8"},os={class:"mt-2 text-sm text-gray-600"},ss={key:2,class:"text-center py-8"},ns={class:"mt-2 text-sm text-gray-600"},as={key:3,class:"flex flex-col gap-2 max-h-80 overflow-y-auto"},ls=["onClick"],rs={class:"flex items-center gap-3"},is={key:0,class:"flex-shrink-0 inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-600 text-white text-xs font-medium"},us={class:"flex-1 min-w-0 text-start"},cs={class:"text-sm font-semibold text-gray-900"},ds={key:0,class:"text-xs text-gray-600"},ms={key:0,class:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20"},fs={class:"flex gap-2"},mp={__name:"BatchSerialDialog",props:{modelValue:Boolean,item:Object,quantity:{type:Number,default:1},warehouse:String},emits:["update:modelValue","batch-serial-selected"],setup(o,{emit:p}){const a=o,l=p,f=Ut(),x=C(a.modelValue),w=C([]),r=C([]),u=C(null),d=C([]),k=C(""),y=De({url:"frappe.client.get_list",makeParams(){var L;return{doctype:"Batch",filters:{item:(L=a.item)==null?void 0:L.item_code,disabled:0},fields:["name as batch_no","expiry_date"],limit_page_length:100}},auto:!1,onSuccess(L){return U(this,null,function*(){L&&Array.isArray(L)&&(w.value=L.map(F=>Qe(Be({},F),{qty:999})))})},onError(L){console.error("Error loading batches:",L)}});be(()=>a.modelValue,L=>{x.value=L,L&&a.item&&_()}),be(x,L=>{l("update:modelValue",L),L||b()});const I=X(()=>d.value.length),P=X(()=>{if(!k.value.trim())return r.value;const L=k.value.toLowerCase().trim();return r.value.filter(F=>F.serial_no.toLowerCase().includes(L))}),S=X(()=>{var L,F;return(L=a.item)!=null&&L.has_batch_no?u.value!==null:(F=a.item)!=null&&F.has_serial_no?I.value>=1:!0}),E=X(()=>f.loading);function _(){return U(this,null,function*(){var L,F;if((L=a.item)!=null&&L.has_batch_no)y.reload();else if((F=a.item)!=null&&F.has_serial_no){f.setWarehouse(a.warehouse);const oe=yield f.fetchSerials(a.item.item_code);r.value=oe}})}function j(L){u.value=L}function $(L){const F=d.value.findIndex(oe=>oe.serial_no===L.serial_no);F>-1?d.value.splice(F,1):d.value.push(L)}function g(L){return d.value.some(F=>F.serial_no===L)}function i(L){return d.value.findIndex(F=>F.serial_no===L)+1}function c(){P.value.forEach(L=>{g(L.serial_no)||d.value.push(L)})}function m(){d.value=[]}function M(){var F,oe;const L={};if((F=a.item)!=null&&F.has_batch_no&&u.value&&(L.batch_no=u.value.batch_no),(oe=a.item)!=null&&oe.has_serial_no){const re=d.value.map(ye=>ye.serial_no);L.serial_no=re.join(`
`),L.quantity=re.length,f.consumeSerials(a.item.item_code,re)}l("batch-serial-selected",L),x.value=!1}function b(){u.value=null,d.value=[],k.value="",w.value=[]}function O(L){return L?new Date(L).toLocaleDateString():""}return(L,F)=>{var oe;return s(),We(B(Ve),{modelValue:x.value,"onUpdate:modelValue":F[2]||(F[2]=re=>x.value=re),options:{title:(oe=o.item)!=null&&oe.has_batch_no?L.__("Select Batch Numbers"):L.__("Select Serial Numbers"),size:"lg"}},{"body-content":W(()=>{var re,ye,Pe;return[e("div",$o,[o.item?(s(),n("div",Co,[e("div",So,[e("div",Po,[o.item.image?(s(),n("img",{key:0,src:o.item.image,alt:o.item.item_name,loading:"lazy",class:"w-full h-full object-cover"},null,8,Mo)):(s(),n("svg",Io,F[3]||(F[3]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"},null,-1)])))]),e("div",Eo,[e("h3",Do,t(o.item.item_name),1),e("p",Vo,t(o.item.item_code),1)]),(re=o.item)!=null&&re.has_batch_no?(s(),n("div",Ao,[e("p",jo,t(L.__("Qty"))+": "+t(o.quantity),1)])):T("",!0)])])):T("",!0),(ye=o.item)!=null&&ye.has_batch_no?(s(),n("div",Bo,[e("label",To,t(L.__("Select Batch Number")),1),e("div",zo,[(s(!0),n(me,null,ve(w.value,ne=>{var le,Z;return s(),n("div",{key:ne.batch_no,onClick:ue=>j(ne),class:xe(["border rounded-lg p-3 cursor-pointer transition-all",((le=u.value)==null?void 0:le.batch_no)===ne.batch_no?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-blue-300"])},[e("div",Ro,[e("div",Oo,[e("h4",No,t(ne.batch_no),1),e("div",Uo,[e("span",Fo,t(L.__("Qty: {0}",[ne.qty])),1),ne.expiry_date?(s(),n("span",qo,t(L.__("Exp: {0}",[O(ne.expiry_date)])),1)):T("",!0)])]),((Z=u.value)==null?void 0:Z.batch_no)===ne.batch_no?(s(),n("div",Ho,F[4]||(F[4]=[e("svg",{class:"w-5 h-5 text-blue-600",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})],-1)]))):T("",!0)])],10,Lo)}),128))])])):T("",!0),(Pe=o.item)!=null&&Pe.has_serial_no?(s(),n("div",Wo,[e("div",Go,[e("label",Qo,[we(t(L.__("Select Serial Numbers"))+" ",1),I.value>0?(s(),n("span",Ko,t(L.__("{0} selected",[I.value])),1)):T("",!0)]),e("div",Jo,[d.value.length>0?(s(),n("button",{key:0,type:"button",onClick:m,class:"text-xs text-gray-600 hover:text-gray-800 font-medium"},t(L.__("Clear All")),1)):T("",!0),P.value.length>0&&d.value.length<P.value.length?(s(),n("button",{key:1,type:"button",onClick:c,class:"text-xs text-blue-600 hover:text-blue-800 font-medium"},t(L.__("Select All")),1)):T("",!0)])]),e("div",Yo,[Ce(e("input",{"onUpdate:modelValue":F[0]||(F[0]=ne=>k.value=ne),type:"text",placeholder:L.__("Search serial numbers..."),class:"w-full px-3 py-2 ps-9 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"},null,8,Xo),[[Re,k.value]]),F[5]||(F[5]=e("svg",{class:"absolute start-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1))]),E.value?(s(),n("div",Zo,[F[6]||(F[6]=e("svg",{class:"animate-spin h-6 w-6 text-blue-600",fill:"none",viewBox:"0 0 24 24"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1)),e("span",es,t(L.__("Loading serial numbers...")),1)])):r.value.length===0?(s(),n("div",ts,[F[7]||(F[7]=e("svg",{class:"mx-auto h-12 w-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})],-1)),e("p",os,t(L.__("No serial numbers available")),1)])):P.value.length===0?(s(),n("div",ss,[F[8]||(F[8]=e("svg",{class:"mx-auto h-12 w-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1)),e("p",ns,t(L.__("No serial numbers match your search")),1)])):(s(),n("div",as,[(s(!0),n(me,null,ve(P.value,ne=>(s(),n("div",{key:ne.serial_no,onClick:le=>$(ne),class:xe(["border rounded-lg p-3 cursor-pointer transition-all",g(ne.serial_no)?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-blue-300"])},[e("div",rs,[g(ne.serial_no)?(s(),n("span",is,t(i(ne.serial_no)),1)):T("",!0),e("div",us,[e("h4",cs,t(ne.serial_no),1),ne.warehouse?(s(),n("p",ds,t(ne.warehouse),1)):T("",!0)]),e("div",{class:xe(["flex-shrink-0 w-5 h-5 rounded border-2 flex items-center justify-center transition-all ms-auto",g(ne.serial_no)?"bg-blue-600 border-blue-600":"border-gray-300 bg-white"])},[g(ne.serial_no)?(s(),n("svg",ms,F[9]||(F[9]=[e("path",{"fill-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z","clip-rule":"evenodd"},null,-1)]))):T("",!0)],2)])],10,ls))),128))]))])):T("",!0)])]}),actions:W(()=>[e("div",fs,[se(B(pe),{variant:"subtle",onClick:F[1]||(F[1]=re=>x.value=!1)},{default:W(()=>[we(t(L.__("Cancel")),1)]),_:1}),se(B(pe),{variant:"solid",onClick:M,disabled:!S.value},{default:W(()=>[we(t(L.__("Confirm")),1)]),_:1},8,["disabled"])])]),_:1},8,["modelValue","options"])}}};function qt(o){const p={EGP:"EÂ£",SAR:"Ãª",AED:"Ø¯.Ø¥",INR:"â‚¹",EUR:"â‚¬",GBP:"Â£",JPY:"Â¥",CNY:"Â¥",USD:"$"};if(p[o])return p[o];try{const l=new Intl.NumberFormat("en-US",{style:"currency",currency:o,currencyDisplay:"narrowSymbol"}).formatToParts(0).find(f=>f.type==="currency");return l?l.value:o}catch(a){return o}}function tt(o,p="USD",a="en-US"){if(typeof o!="number"||isNaN(o))return"";const l=Math.abs(o),f=qt(p),x=new Intl.NumberFormat(a,{minimumFractionDigits:2,maximumFractionDigits:2}).format(l),w=`${f} ${x}`;return o<0?`-${w}`:w}function Ht(o="USD"){return qt(o)}const ps={class:"flex flex-col gap-4"},vs={class:"bg-blue-50 border border-blue-200 rounded-lg p-3"},gs={class:"flex items-start gap-2"},_s={class:"flex-1"},hs={class:"text-xs font-medium text-blue-900"},ys={class:"text-xs text-blue-700 mt-0.5"},xs={key:0},bs={class:"block text-sm font-medium text-gray-700 mb-2 text-start"},ws={class:"flex gap-2"},ks={class:"text-xs text-gray-500 mt-1"},$s={key:1},Cs={class:"block text-sm font-medium text-gray-700 mb-2 text-start"},Ss={class:"flex items-center gap-2"},Ps={class:"flex flex-col gap-2 max-h-60 overflow-y-auto pe-1"},Ms=["onClick"],Is={class:"flex items-center justify-between"},Es={class:"flex-1"},Ds={class:"flex items-center gap-2"},Vs={class:"flex-1"},As={class:"text-sm font-bold text-gray-900"},js={class:"text-xs text-gray-600"},Bs={key:2,class:"bg-green-50 border-2 border-green-500 rounded-lg p-4"},Ts={class:"flex items-center gap-2 mb-3"},zs={class:"text-sm font-bold text-green-900"},Ls={class:"bg-white rounded-lg p-3"},Rs={class:"flex justify-between items-center mb-2"},Os={class:"text-xs text-gray-600"},Ns={class:"text-sm font-bold text-gray-900"},Us={class:"flex justify-between items-center"},Fs={class:"text-xs text-gray-600"},qs={class:"text-lg font-bold text-green-600"},Hs={key:3,class:"bg-red-50 border border-red-200 rounded-lg p-3"},Ws={class:"flex items-start gap-2"},Gs={class:"text-xs text-red-800"},Qs={class:"flex justify-between items-center w-full gap-2"},Ks={class:"flex gap-2 ms-auto"},fp={__name:"CouponDialog",props:{modelValue:Boolean,subtotal:{type:Number,required:!0,note:__("Cart subtotal BEFORE tax - used for discount calculations")},items:Array,posProfile:String,customer:String,company:String,currency:{type:String,default:"USD"},appliedCoupon:{type:Object,default:null}},emits:["update:modelValue","discount-applied","discount-removed"],setup(o,{emit:p}){const{calculateDiscountAmount:a}=vo(),{showSuccess:l,showError:f,showWarning:x}=Ze(),w=o,r=p,u=C(w.modelValue),d=C(""),k=C([]),y=C(null),I=C(!1),P=C(""),S=De({url:"pos_next.api.offers.get_active_coupons",makeParams(){return{customer:w.customer,company:w.company}},auto:!1,onSuccess(c){k.value=(c==null?void 0:c.message)||c||[]}}),E=De({url:"pos_next.api.offers.validate_coupon",makeParams(){return{coupon_code:d.value,customer:w.customer,company:w.company}},auto:!1});be(()=>w.modelValue,c=>{u.value=c,c&&(_(),P.value="",d.value="",y.value=w.appliedCoupon)}),be(u,c=>{r("update:modelValue",c)}),be(()=>w.appliedCoupon,c=>{y.value=c});function _(){return U(this,null,function*(){if(!(!w.customer||!w.company))try{yield S.reload()}catch(c){console.error("Error loading gift cards:",c)}})}function j(c){d.value=c.coupon_code,$()}function $(){return U(this,null,function*(){var c;if(!d.value.trim()){P.value=__("Please enter a coupon code");return}I.value=!0,P.value="";try{yield E.reload();const m=((c=E.data)==null?void 0:c.message)||E.data,M=typeof m=="object"&&m.valid!==void 0?m:E.data;if(!M||!M.valid){P.value=(M==null?void 0:M.message)||__("The coupon code you entered is not valid"),f(P.value);return}const b=M.coupon;if(b.min_amount&&w.subtotal<b.min_amount){P.value=__("This coupon requires a minimum purchase of ",[i(b.min_amount)]),x(P.value);return}const O={percentage:b.discount_type==="Percentage"?b.discount_percentage:0,amount:b.discount_type==="Amount"?b.discount_amount:0};let K=a(O,w.subtotal);b.max_amount&&K>b.max_amount&&(K=b.max_amount),K=Math.min(K,w.subtotal),y.value={name:b.coupon_name||b.coupon_code,code:d.value.toUpperCase(),percentage:b.discount_percentage||0,amount:K,type:b.discount_type,coupon:b,apply_on:b.apply_on},r("discount-applied",y.value),l(__("{0} applied successfully",[d.value.toUpperCase()])),P.value=""}catch(m){console.error("Error applying coupon:",m),P.value=__("Failed to apply coupon. Please try again."),f(P.value)}finally{I.value=!1}})}function g(){y.value=null,r("discount-removed"),l(__("Discount has been removed"))}function i(c){return tt(Number.parseFloat(c||0),w.currency)}return(c,m)=>(s(),We(B(Ve),{modelValue:u.value,"onUpdate:modelValue":m[2]||(m[2]=M=>u.value=M),options:{title:c.__("Apply"),size:"md"}},{"body-content":W(()=>[e("div",ps,[e("div",vs,[e("div",gs,[m[3]||(m[3]=e("svg",{class:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z","clip-rule":"evenodd"})],-1)),e("div",_s,[e("p",hs,t(c.__("Have a coupon code?")),1),e("p",ys,t(c.__("Enter your promotional or gift card code below")),1)])])]),y.value?T("",!0):(s(),n("div",xs,[e("label",bs,t(c.__("Coupon Code")),1),e("div",ws,[se(B(dt),{modelValue:d.value,"onUpdate:modelValue":m[0]||(m[0]=M=>d.value=M),type:"text",placeholder:c.__("ENTER-CODE-HERE"),class:"flex-1 uppercase",onKeyup:Et($,["enter"]),disabled:I.value},null,8,["modelValue","placeholder","disabled"]),se(B(pe),{onClick:$,loading:I.value,theme:"blue",variant:"solid",class:"flex-shrink-0"},{default:W(()=>m[4]||(m[4]=[e("svg",{class:"w-3.5 h-3.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})],-1)])),_:1},8,["loading"])]),e("p",ks,t(c.__("Code is case-insensitive")),1)])),k.value.length>0&&!y.value?(s(),n("div",$s,[e("label",Cs,[e("div",Ss,[m[5]||(m[5]=e("svg",{class:"w-4 h-4 text-purple-600",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{d:"M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"}),e("path",{"fill-rule":"evenodd",d:"M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z","clip-rule":"evenodd"})],-1)),e("span",null,t(c.__("My Gift Cards ({0})",[k.value.length])),1)])]),e("div",Ps,[(s(!0),n(me,null,ve(k.value,M=>(s(),n("div",{key:M.coupon_code,onClick:b=>j(M),class:"bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg p-3 cursor-pointer hover:shadow-md hover:border-purple-400 transition-all"},[e("div",Is,[e("div",Es,[e("div",Ds,[m[6]||(m[6]=e("div",{class:"w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center"},[e("svg",{class:"w-4 h-4 text-purple-600",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{d:"M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"}),e("path",{"fill-rule":"evenodd",d:"M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z","clip-rule":"evenodd"})])],-1)),e("div",Vs,[e("h4",As,t(M.coupon_code),1),e("p",js,t(M.coupon_name),1)])])]),m[7]||(m[7]=e("svg",{class:"w-5 h-5 text-purple-600",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z","clip-rule":"evenodd"})],-1))])],8,Ms))),128))])])):T("",!0),y.value?(s(),n("div",Bs,[e("div",Ts,[m[8]||(m[8]=e("div",{class:"w-8 h-8 bg-green-100 rounded-full flex items-center justify-center"},[e("svg",{class:"w-5 h-5 text-green-600",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})])],-1)),e("h4",zs,t(c.__("Coupon Applied Successfully!")),1)]),e("div",Ls,[e("div",Rs,[e("span",Os,t(c.__("Coupon Code")),1),e("span",Ns,t(y.value.code),1)]),e("div",Us,[e("span",Fs,t(c.__("Discount Amount")),1),e("span",qs," -"+t(i(y.value.amount)),1)])])])):T("",!0),P.value?(s(),n("div",Hs,[e("div",Ws,[m[9]||(m[9]=e("svg",{class:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z","clip-rule":"evenodd"})],-1)),e("p",Gs,t(P.value),1)])])):T("",!0)])]),actions:W(()=>[e("div",Qs,[y.value?(s(),We(B(pe),{key:0,variant:"subtle",theme:"red",onClick:g,class:"flex-shrink-0"},{prefix:W(()=>m[10]||(m[10]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])),default:W(()=>[we(" "+t(c.__("Remove")),1)]),_:1})):T("",!0),e("div",Ks,[se(B(pe),{variant:"subtle",onClick:m[1]||(m[1]=M=>u.value=!1)},{default:W(()=>[we(t(c.__("Close")),1)]),_:1})])])]),_:1},8,["modelValue","options"]))}},wt=C({});function Js(){function o(x,w="create",r=null){return U(this,null,function*(){try{const u=`${x}:${w}`;if(wt.value[u]!==void 0)return wt.value[u];const d=yield Fe("frappe.client.has_permission",{doctype:x,docname:r||"",perm_type:w}),k=!!(d!=null&&d.has_permission);return wt.value[u]=k,k}catch(u){return console.error(`Error checking permission for ${x}:${w}`,u),!1}})}function p(x){return U(this,null,function*(){const w={};return yield Promise.all(x.map(d=>U(this,[d],function*({doctype:r,permType:u="create"}){const k=`${r}:${u}`;w[k]=yield o(r,u)}))),w})}function a(x,w="create"){const r=C(!1),u=C(!1),d=()=>U(this,null,function*(){u.value=!0;try{r.value=yield o(x,w)}finally{u.value=!1}});return d(),{hasPermission:X(()=>r.value),loading:X(()=>u.value),refresh:d}}function l(){wt.value={}}function f(){return U(this,null,function*(){yield p([{doctype:"Customer",permType:"create"},{doctype:"Customer",permType:"write"},{doctype:"Promotional Scheme",permType:"create"},{doctype:"Promotional Scheme",permType:"write"},{doctype:"Promotional Scheme",permType:"delete"},{doctype:"POS Coupon",permType:"create"},{doctype:"POS Coupon",permType:"write"},{doctype:"Sales Invoice",permType:"create"},{doctype:"Sales Invoice",permType:"submit"}])})}return{checkPermission:o,checkMultiplePermissions:p,usePermissionCheck:a,clearCache:l,preloadCommonPermissions:f}}function Ys(){const{checkPermission:o,preloadCommonPermissions:p}=Js();return{canCreateCustomer:()=>U(this,null,function*(){return yield o("Customer","create")}),canEditCustomer:()=>U(this,null,function*(){return yield o("Customer","write")}),canCreatePromotion:()=>U(this,null,function*(){return yield o("Promotional Scheme","create")}),canEditPromotion:()=>U(this,null,function*(){return yield o("Promotional Scheme","write")}),canDeletePromotion:()=>U(this,null,function*(){return yield o("Promotional Scheme","delete")}),canCreateCoupon:()=>U(this,null,function*(){return yield o("POS Coupon","create")}),canApplyCoupon:()=>U(this,null,function*(){return yield o("POS Coupon","write")}),canCreateInvoice:()=>U(this,null,function*(){return yield o("Sales Invoice","create")}),canSubmitInvoice:()=>U(this,null,function*(){return yield o("Sales Invoice","submit")}),canEditSettings:()=>U(this,null,function*(){return yield o("POS Settings","write")}),preloadCommonPermissions:p}}const kt=et.create("CountriesStore"),Xs=nt("countries",()=>{const o=C([]),p=C(!1),a=C(!1),l=De({url:"frappe.geo.country_info.get_country_timezone_info",auto:!1,onSuccess(S){S!=null&&S.country_info&&(o.value=f(S.country_info),a.value=!0,kt.info(`Loaded ${o.value.length} countries`))},onError(S){kt.error("Error loading country codes",S)}});function f(S){return Object.entries(S).filter(([E,_])=>_.isd).map(([E,_])=>{var j;return{name:E,code:((j=_.code)==null?void 0:j.toUpperCase())||"",isd:_.isd,flagUrl:`https://flagcdn.com/h24/${_.code}.png`,flagUrlSvg:`https://flagcdn.com/${_.code}.svg`,flagEmoji:x(_.code)}}).sort((E,_)=>E.name.localeCompare(_.name))}function x(S){if(!S)return"ðŸ³ï¸";const _=[...S.toUpperCase()].map(j=>127397+j.charCodeAt(0));return String.fromCodePoint(..._)}function w(){return U(this,null,function*(){if(a.value)return kt.debug("Countries already loaded from cache"),o.value;if(p.value)return kt.debug("Countries already loading, waiting..."),yield new Promise(S=>{const E=setInterval(()=>{p.value||(clearInterval(E),S())},50)}),o.value;p.value=!0;try{yield l.fetch()}finally{p.value=!1}return o.value})}function r(S){return S?o.value.find(E=>E.isd===S):null}function u(S){return S?o.value.find(E=>E.name===S):null}function d(S){if(!S)return null;const E=S.toUpperCase();return o.value.find(_=>_.code===E)}function k(S,E){if(!E)return"";const _=E.replace(/\D/g,"");return S?`${S}-${_}`:_}function y(S){if(!S)return{isd:"",number:""};if(S.includes("-")){const[E,..._]=S.split("-");return{isd:E,number:_.join("-")}}return{isd:"",number:S}}function I(S){if(!S)return!0;const E=S.replace(/\D/g,"");return E.length>=7&&E.length<=15}const P=X(()=>Object.fromEntries(o.value.map(S=>[S.name,S.isd])));return{countries:X(()=>o.value),loading:X(()=>p.value),loaded:X(()=>a.value),countryNameToISDMap:P,loadCountries:w,findCountryByISD:r,findCountryByName:u,findCountryByCode:d,formatPhoneNumber:k,parsePhoneNumber:y,validatePhoneNumber:I,getCountryFlagEmoji:x}}),Zs={class:"flex flex-col gap-6"},en={class:"block text-start text-sm font-medium text-gray-700 mb-2"},tn={class:"block text-start text-sm font-medium text-gray-700 mb-2"},on={class:"flex gap-2"},sn=["src","alt"],nn={class:"flex-1 text-start"},an={key:0,class:"absolute start-0 z-50 mt-1 w-80 max-h-80 bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden"},ln={class:"sticky top-0 bg-white border-b border-gray-200 p-2"},rn=["placeholder"],un={class:"overflow-y-auto max-h-64"},cn=["onClick"],dn=["src","alt"],mn={class:"flex-1 text-sm font-medium text-gray-700"},fn={class:"text-sm text-gray-500"},pn={key:0,class:"px-4 py-8 text-center text-sm text-gray-500"},vn=["placeholder"],gn={class:"block text-start text-sm font-medium text-gray-700 mb-2"},_n={class:"block text-start text-sm font-medium text-gray-700 mb-2"},hn={value:""},yn=["value"],xn={class:"block text-start text-sm font-medium text-gray-700 mb-2"},bn={value:""},wn=["value"],kn={class:"flex flex-col gap-2"},$n={key:0,class:"px-3 py-2 bg-amber-50 border border-amber-200 rounded-lg"},Cn={class:"flex items-start gap-2"},Sn={class:"flex-1"},Pn={class:"text-sm font-medium text-amber-900"},Mn={class:"text-xs text-amber-700 mt-0.5"},In={class:"flex gap-2"},En={__name:"CreateCustomerDialog",props:{modelValue:Boolean,posProfile:String,initialName:String},emits:["update:modelValue","customer-created"],setup(o,{emit:p}){const a=et.create("CreateCustomerDialog"),l=Xs(),{canCreateCustomer:f}=Ys(),{showSuccess:x,showError:w}=Ze(),r=o,u=p,d=C(!0),k=C(!1),y=C(""),I=C(""),P=C(!1),S=C(""),E=C(null),_=C(null),j=C(["Commercial","Individual","Non Profit","Government"]),$=C(["All Territories"]),g=C({customer_name:"",mobile_no:"",email_id:"",customer_group:"Individual",territory:"All Territories"}),i=X({get:()=>r.modelValue,set:z=>u("update:modelValue",z)}),c=X(()=>{const z=l.countries.find(J=>J.isd===y.value);return(z==null?void 0:z.code.toLowerCase())||"eg"}),m=X(()=>{if(!S.value)return l.countries;const z=S.value.toLowerCase();return l.countries.filter(J=>J.name.toLowerCase().includes(z)||J.isd.includes(z)||J.code.toLowerCase().includes(z))}),M=z=>z.target.style.display="none",b=z=>{y.value=z.isd,P.value=!1,S.value="",O()},O=()=>{g.value.mobile_no=I.value?`${y.value}-${I.value}`:""},K=z=>{E.value&&!E.value.contains(z.target)&&(P.value=!1,S.value="")},L=z=>{const J=l.countryNameToISDMap[z];J?(y.value=J,a.info(`Set country code to ${J} for ${z}`)):(a.warn(`Country "${z}" not found`),y.value="+20")},F=()=>{if(!$.value.length)return;const z=l.countries.find(Y=>Y.isd===y.value);if(!z)return;if($.value.includes(z.name)){g.value.territory=z.name,a.info(`Territory set to: ${z.name}`);return}const J=$.value.find(Y=>Y.toLowerCase().includes(z.name.toLowerCase())||z.name.toLowerCase().includes(Y.toLowerCase()));J&&(g.value.territory=J,a.info(`Territory set to fuzzy match: ${J}`))},oe=De({url:"frappe.client.insert",makeParams:()=>({doc:{doctype:"Customer",customer_name:g.value.customer_name,customer_type:"Individual",customer_group:g.value.customer_group||__("Individual"),territory:g.value.territory||__("All Territories"),mobile_no:g.value.mobile_no||"",email_id:g.value.email_id||""}}),onSuccess:z=>{x(__("Customer {0} created successfully",[z.customer_name])),u("customer-created",z),i.value=!1},onError:z=>{a.error("Error creating customer",z),w(z.message||__("Failed to create customer"))}}),re=(z,J)=>De({url:"frappe.client.get_list",makeParams:()=>({doctype:z,fields:["name"],filters:z==="Customer Group"?{is_group:0}:{},limit_page_length:500}),auto:!1,onSuccess:Y=>(Y==null?void 0:Y.length)&&J(Y.map(R=>R.name)),onError:Y=>a.error(`Error loading ${z}`,Y)}),ye=re("Customer Group",z=>j.value=z),Pe=re("Territory",z=>$.value=z),ne=De({url:"frappe.client.get_value",makeParams:()=>({doctype:"POS Profile",filters:{name:r.posProfile},fieldname:["country"]}),auto:!1,onSuccess:z=>L((z==null?void 0:z.country)||"Egypt"),onError:z=>{a.error("Error loading POS Profile",z),y.value="+20"}}),le=()=>U(this,null,function*(){l.loadCountries(),yield Pe.reload(),ye.reload(),Z(),r.posProfile?yield ne.reload():y.value="+20"}),Z=()=>U(this,null,function*(){k.value=!0;try{d.value=yield f()}catch(z){a.error("Permission check failed",z),d.value=!1}finally{k.value=!1}}),ue=()=>U(this,null,function*(){if(!g.value.customer_name)return w(__("Customer Name is required"));yield oe.submit()}),Me=()=>{Object.assign(g.value,{customer_name:"",mobile_no:"",email_id:"",customer_group:"Individual",territory:"All Territories"}),y.value="",I.value=""};return be(()=>r.initialName,z=>z&&(g.value.customer_name=z)),be(()=>g.value.mobile_no,z=>{if(z!=null&&z.includes("-")){const[J,...Y]=z.split("-");y.value=J,I.value=Y.join("-")}}),be(y,()=>U(this,null,function*(){yield Tt(),F()})),be(P,z=>U(this,null,function*(){var J;z&&(yield Tt(),(J=_.value)==null||J.focus())})),be(()=>r.modelValue,z=>U(this,null,function*(){i.value=z,z?yield le():Me()})),be(i,z=>u("update:modelValue",z)),Dt(()=>{le(),document.addEventListener("click",K)}),uo(()=>{document.removeEventListener("click",K)}),(z,J)=>(s(),We(B(Ve),{modelValue:i.value,"onUpdate:modelValue":J[10]||(J[10]=Y=>i.value=Y),options:{title:z.__("Create New Customer"),size:"md"}},{"body-content":W(()=>[e("div",Zs,[e("div",null,[e("label",en,[we(t(z.__("Customer Name"))+" ",1),J[11]||(J[11]=e("span",{class:"text-red-500"},"*",-1))]),se(B(dt),{modelValue:g.value.customer_name,"onUpdate:modelValue":J[0]||(J[0]=Y=>g.value.customer_name=Y),type:"text",placeholder:z.__("Enter customer name"),required:""},null,8,["modelValue","placeholder"])]),e("div",null,[e("label",tn,t(z.__("Mobile Number")),1),e("div",on,[e("div",{class:"relative",ref_key:"dropdownRef",ref:E},[e("button",{type:"button",onClick:J[1]||(J[1]=Y=>P.value=!P.value),class:"flex items-center gap-1 w-24 ps-2 pe-1 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white hover:bg-gray-50"},[e("img",{src:`https://flagcdn.com/h24/${c.value}.png`,alt:c.value,class:"w-6 h-auto rounded-sm",onError:M},null,40,sn),e("span",nn,t(y.value||"+20"),1),J[12]||(J[12]=e("svg",{class:"w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"})],-1))]),P.value?(s(),n("div",an,[e("div",ln,[Ce(e("input",{ref_key:"countrySearchRef",ref:_,"onUpdate:modelValue":J[2]||(J[2]=Y=>S.value=Y),type:"text",placeholder:z.__("Search country or code..."),class:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",onKeydown:J[3]||(J[3]=Et(Y=>P.value=!1,["escape"]))},null,40,rn),[[Re,S.value]])]),e("div",un,[(s(!0),n(me,null,ve(m.value,Y=>(s(),n("button",{key:Y.code,type:"button",onClick:R=>b(Y),class:xe(["w-full flex items-center gap-3 px-3 py-2.5 hover:bg-gray-50 transition-colors text-start",{"bg-blue-50":y.value===Y.isd}])},[e("img",{src:`https://flagcdn.com/h24/${Y.code.toLowerCase()}.png`,alt:Y.name,class:"w-6 h-auto rounded-sm shadow-sm",onError:J[4]||(J[4]=R=>R.target.style.display="none")},null,40,dn),e("span",mn,t(Y.name),1),e("span",fn,t(Y.isd),1)],10,cn))),128)),m.value.length===0?(s(),n("div",pn,t(z.__("No countries found")),1)):T("",!0)])])):T("",!0)],512),Ce(e("input",{"onUpdate:modelValue":J[5]||(J[5]=Y=>I.value=Y),type:"tel",placeholder:z.__("Enter phone number"),class:"flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-start",onInput:O},null,40,vn),[[Re,I.value]])])]),e("div",null,[e("label",gn,t(z.__("Email")),1),se(B(dt),{modelValue:g.value.email_id,"onUpdate:modelValue":J[6]||(J[6]=Y=>g.value.email_id=Y),type:"email",placeholder:z.__("Enter email address")},null,8,["modelValue","placeholder"])]),e("div",null,[e("label",_n,t(z.__("Customer Group")),1),Ce(e("select",{"onUpdate:modelValue":J[7]||(J[7]=Y=>g.value.customer_group=Y),class:"w-full px-8 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"},[e("option",hn,t(z.__("Select Customer Group")),1),(s(!0),n(me,null,ve(j.value,Y=>(s(),n("option",{key:Y,value:Y},t(Y),9,yn))),128))],512),[[st,g.value.customer_group]])]),e("div",null,[e("label",xn,t(z.__("Territory")),1),Ce(e("select",{"onUpdate:modelValue":J[8]||(J[8]=Y=>g.value.territory=Y),class:"w-full px-8 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"},[e("option",bn,t(z.__("Select Territory")),1),(s(!0),n(me,null,ve($.value,Y=>(s(),n("option",{key:Y,value:Y},t(Y),9,wn))),128))],512),[[st,g.value.territory]])])])]),actions:W(()=>[e("div",kn,[d.value?T("",!0):(s(),n("div",$n,[e("div",Cn,[J[13]||(J[13]=e("svg",{class:"w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),e("div",Sn,[e("p",Pn,t(z.__("Permission Required")),1),e("p",Mn,t(z.__("You don't have permission to create customers. Contact your administrator.")),1)])])])),e("div",In,[se(B(pe),{variant:"solid",onClick:ue,loading:B(oe).loading||k.value,disabled:!g.value.customer_name||!d.value},{default:W(()=>[we(t(z.__("Create Customer")),1)]),_:1},8,["loading","disabled"]),se(B(pe),{variant:"subtle",onClick:J[9]||(J[9]=Y=>i.value=!1)},{default:W(()=>[we(t(z.__("Cancel")),1)]),_:1})])])]),_:1},8,["modelValue","options"]))}},Dn=xt(En,[["__scopeId","data-v-5ed6fb70"]]),Vn=nt("customerSearch",()=>{const o=C([]),p=C(""),a=C(!1),l=C(-1),f=C([]),x=C([]),w=C(new Map),r=C(new Map);function u(g,i){const c=g.toLowerCase();let m=w.value.get(i.name);if(m||(m={name:(i.customer_name||"").toLowerCase(),mobile:(i.mobile_no||"").toLowerCase(),email:(i.email_id||"").toLowerCase(),id:(i.name||"").toLowerCase(),nameWords:(i.customer_name||"").toLowerCase().split(" ")},w.value.set(i.name,m)),m.name===c)return 300;if(m.name.startsWith(c))return 270;for(const M of m.nameWords)if(M.startsWith(c))return 240;return m.name.includes(c)?180:m.mobile===c?250:m.mobile.startsWith(c)?225:m.mobile.includes(c)?150:m.email.startsWith(c)?200:m.email.includes(c)?120:m.id.startsWith(c)?135:m.id.includes(c)?90:0}const d=X(()=>{const g=performance.now(),i=p.value.trim();if(!i){const F="empty";let oe=r.value.get(F);if(!oe){const ye=new Set(f.value),Pe=new Set(x.value),ne=[],le=[],Z=[];for(const ue of o.value)ye.has(ue.name)?ne.push(ue):Pe.has(ue.name)?le.push(ue):Z.push(ue);oe=[...ne,...le,...Z].slice(0,50),r.value.set(F,oe)}const re=performance.now()-g;return console.log(`âš¡âš¡ Showing ${oe.length} customers in ${re.toFixed(3)}ms (CACHED)`),oe}const c=i.toLowerCase(),m=r.value.get(c);if(m){const F=performance.now()-g;return console.log(`âš¡âš¡âš¡ INSTANT ${m.length} results in ${F.toFixed(3)}ms (FROM CACHE: "${i}")`),m}const M=[],b=50;let O=0;for(const F of o.value){O++;const oe=u(i,F);if(oe>=240&&(M.push({customer:F,score:oe}),M.length>=b))break}if(M.length<b&&O<o.value.length)for(let F=O;F<o.value.length;F++){const oe=o.value[F],re=u(i,oe);if(re>0&&re<240&&(M.push({customer:oe,score:re}),M.length>=b))break}M.sort((F,oe)=>oe.score-F.score);const K=M.map(F=>F.customer);if(r.value.set(c,K),r.value.size>100){const F=r.value.keys().next().value;r.value.delete(F)}const L=performance.now()-g;return console.log(`âš¡âš¡ Ultra-fast ${K.length} results in ${L.toFixed(3)}ms (search: "${i}")`),K}),k=X(()=>{const g=p.value.trim().toLowerCase();if(!g||g.length<2)return[];const i=[];return/^\d+$/.test(g)&&i.push({type:"phone",text:__("Search by phone: {0}",[g]),icon:"ðŸ“±"}),g.includes("@")&&i.push({type:"email",text:__("Search by email: {0}",[g]),icon:"âœ‰ï¸"}),!o.value.some(m=>{var M;return((M=m.customer_name)==null?void 0:M.toLowerCase())===g})&&d.value.length<5&&i.push({type:"create",text:__("Create new customer: {0}",[g]),icon:"âž•"}),i});function y(g){return U(this,null,function*(){if(g){a.value=!0;try{const i=yield fe.searchCachedCustomers("",0);if(i&&i.length>0)o.value=i,console.log(`âœ“ Loaded ${i.length} customers from cache`);else if(Vt())console.warn("âš ï¸ Offline mode: No cached customers available. Please sync data when online."),o.value=[];else{const c=yield Fe("pos_next.api.customers.get_customers",{pos_profile:g,search_term:"",start:0,limit:0}),m=(c==null?void 0:c.message)||c||[];o.value=m,m.length&&(yield fe.cacheCustomers(m)),console.log(`âœ“ Loaded ${m.length} customers from server`)}w.value.clear(),r.value.clear()}catch(i){console.error("Error loading customers:",i),o.value=[]}finally{a.value=!1}}})}function I(g){return U(this,null,function*(){try{const i=o.value.filter(c=>c.name!==g.name);o.value=[g,...i],yield fe.cacheCustomers([g]),r.value.clear(),console.log("âœ“ New customer cached for instant search")}catch(i){console.error("Error caching newly created customer:",i)}})}function P(g){p.value=g,l.value=-1}function S(){p.value="",l.value=-1}function E(g){l.value=g}function _(){l.value=-1}function j(g){f.value=[g,...f.value.filter(c=>c!==g)].slice(0,10);const i=x.value.indexOf(g);i>-1&&x.value.splice(i,1),x.value=[g,...x.value].slice(0,20);try{localStorage.setItem("pos_recent_customers",JSON.stringify(f.value)),localStorage.setItem("pos_frequent_customers",JSON.stringify(x.value))}catch(c){console.warn("Failed to persist customer history:",c)}}function $(){try{const g=localStorage.getItem("pos_recent_customers"),i=localStorage.getItem("pos_frequent_customers");g&&(f.value=JSON.parse(g)),i&&(x.value=JSON.parse(i))}catch(g){console.warn("Failed to load customer history:",g)}}return{allCustomers:o,searchTerm:p,loading:a,selectedIndex:l,recentSearches:f,frequentCustomers:x,filteredCustomers:d,recommendations:k,loadAllCustomers:y,addCustomerToCache:I,setSearchTerm:P,clearSearch:S,setSelectedIndex:E,resetSelectedIndex:_,trackCustomerSelection:j,loadCustomerHistory:$}}),An={class:"sr-only"},jn={class:"flex flex-col gap-4"},Bn={class:"relative"},Tn=["value","placeholder","aria-label"],zn={key:0,class:"text-start text-xs text-gray-500 mt-0"},Ln={key:0,class:"text-blue-600 font-medium"},Rn={key:1},On={key:2,class:"text-gray-400 ms-1"},Nn={key:1,class:"flex flex-wrap gap-2 -mt-2"},Un={class:"max-h-96 overflow-y-auto",style:{"will-change":"scroll-position"}},Fn={key:0,class:"text-center py-8"},qn={class:"mt-2 text-sm text-gray-500"},Hn={key:1,class:"text-center py-8"},Wn={class:"mt-2 text-sm text-gray-500"},Gn={class:"text-xs text-gray-400 mt-1"},Qn={key:2,class:"text-center py-8"},Kn={class:"mt-2 text-sm font-medium text-gray-700"},Jn={class:"text-xs text-gray-500 mt-1"},Yn={key:3,class:"flex flex-col gap-2"},Xn={class:"flex items-start justify-between"},Zn={class:"flex-1 min-w-0"},ea={class:"font-semibold text-sm text-gray-900 truncate"},ta={class:"text-xs text-gray-600 mt-1 gap-2"},oa={key:0},sa={key:1},na={key:0,class:"text-xs text-gray-500 mt-1"},aa={key:0,class:"ms-2 flex-shrink-0"},la={class:"pt-4 border-t border-gray-200"},ra={__name:"CustomerDialog",props:{modelValue:Boolean,posProfile:String},emits:["update:modelValue","customer-selected"],setup(o,{emit:p}){const a=o,l=p,f=Vn(),{filteredCustomers:x,loading:w,selectedIndex:r,searchTerm:u,allCustomers:d,recommendations:k}=co(f),y=C(!1),I=X({get:()=>a.modelValue,set:i=>l("update:modelValue",i)}),P=X(()=>x.value),S=X(()=>!u.value&&P.value.length>0);be(I,i=>{i&&(f.clearSearch(),d.value.length===0&&f.loadAllCustomers(a.posProfile))});function E(i){const c=i.target.value;console.log("ðŸ” Search input:",c),f.setSearchTerm(c)}function _(i){P.value.length!==0&&(i.key==="ArrowDown"?(i.preventDefault(),f.setSelectedIndex(Math.min(r.value+1,P.value.length-1))):i.key==="ArrowUp"?(i.preventDefault(),f.setSelectedIndex(Math.max(r.value-1,-1))):i.key==="Enter"?(i.preventDefault(),r.value>=0&&r.value<P.value.length?j(P.value[r.value]):P.value.length===1&&j(P.value[0])):i.key==="Escape"&&(I.value=!1))}Dt(()=>{a.posProfile&&(f.loadAllCustomers(a.posProfile),f.loadCustomerHistory())});function j(i){f.trackCustomerSelection(i.name),l("customer-selected",i),I.value=!1}function $(){y.value=!0}function g(i){return U(this,null,function*(){a.posProfile&&(yield f.addCustomerToCache(i)),f.trackCustomerSelection(i.name),l("customer-selected",i),I.value=!1})}return(i,c)=>(s(),n(me,null,[se(B(Ve),{modelValue:I.value,"onUpdate:modelValue":c[4]||(c[4]=m=>I.value=m),options:{title:i.__("Select Customer"),size:"md"}},{"body-title":W(()=>[e("span",An,t(i.__("Search and select a customer for the transaction")),1)]),"body-content":W(()=>[e("div",jn,[e("div",Bn,[c[7]||(c[7]=e("div",{class:"absolute inset-y-0 start-0 ps-1 flex items-center pointer-events-none"},[e("svg",{class:"h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})])],-1)),e("input",{id:"customer-search",name:"customer-search",value:B(u),onInput:E,type:"text",placeholder:i.__("Search customers by name, mobile, or email..."),class:"w-full border border-gray-300 rounded-md ps-6 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",onKeydown:_,autofocus:"","aria-label":i.__("Search customers")},null,40,Tn),B(u)?(s(),n("button",{key:0,onClick:c[0]||(c[0]=m=>B(f).clearSearch()),class:"absolute inset-y-0 end-0 text-gray-400 hover:text-gray-600"},c[6]||(c[6]=[e("svg",{class:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))):T("",!0)]),!B(w)&&B(d).length>0?(s(),n("p",zn,[S.value?(s(),n("span",Ln,t(i.__("â­ Recent & Frequent")),1)):(s(),n("span",Rn,t(i.__("{0} of {1} customers",[P.value.length,B(d).length])),1)),P.value.length>0?(s(),n("span",On,t(i.__("â€¢ Use â†‘â†“ to navigate, Enter to select")),1)):T("",!0)])):T("",!0),B(k).length>0?(s(),n("div",Nn,[(s(!0),n(me,null,ve(B(k),m=>(s(),n("div",{key:m.type,class:"inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-700 rounded-md text-xs"},[e("span",null,t(m.icon),1),e("span",null,t(m.text),1)]))),128))])):T("",!0),e("div",Un,[B(w)?(s(),n("div",Fn,[c[8]||(c[8]=e("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"},null,-1)),e("p",qn,t(i.__("Loading customers...")),1)])):B(d).length===0&&!B(w)?(s(),n("div",Hn,[c[9]||(c[9]=e("svg",{class:"mx-auto h-12 w-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"})],-1)),e("p",Wn,t(i.__("No customers available")),1),e("p",Gn,t(i.__("Create your first customer to get started")),1)])):P.value.length===0&&B(u).trim().length>0?(s(),n("div",Qn,[c[10]||(c[10]=e("svg",{class:"mx-auto h-12 w-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1)),e("p",Kn,t(i.__('No results for "{0}"',[B(u)])),1),e("p",Jn,t(i.__("Try a different search term or create a new customer")),1)])):(s(),n("div",Yn,[(s(!0),n(me,null,ve(P.value,(m,M,b,O)=>{const K=[m.name,M===B(r)];if(O&&O.key===m.name&&mo(O,K))return O;const L=(s(),n("button",{key:m.name,onClick:F=>j(m),class:xe(["w-full text-start p-3 rounded-lg border transition-all duration-75",M===B(r)?"border-blue-500 bg-blue-50 shadow-sm":"border-gray-200 hover:border-blue-400 hover:bg-blue-50"])},[e("div",Xn,[e("div",Zn,[e("div",ea,t(m.customer_name),1),e("div",ta,[m.mobile_no?(s(),n("span",oa,"ðŸ“± "+t(m.mobile_no),1)):T("",!0),m.email_id?(s(),n("span",sa,"âœ‰ï¸ "+t(m.email_id),1)):T("",!0)]),m.customer_group?(s(),n("div",na,t(m.customer_group),1)):T("",!0)]),M===B(r)?(s(),n("div",aa,c[11]||(c[11]=[e("svg",{class:"h-5 w-5 text-blue-500",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})],-1)]))):T("",!0)])],10,["onClick"]));return L.memo=K,L},c,1),128))]))]),e("div",la,[e("button",{onClick:$,class:"w-full py-2 px-4 text-sm font-medium text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition-colors"},t(i.__("+ Create New Customer")),1)])])]),actions:W(()=>[se(B(pe),{variant:"subtle",onClick:c[3]||(c[3]=m=>I.value=!1)},{default:W(()=>[we(t(i.__("Cancel")),1)]),_:1})]),_:1},8,["modelValue","options"]),se(Dn,{modelValue:y.value,"onUpdate:modelValue":c[5]||(c[5]=m=>y.value=m),"pos-profile":o.posProfile,onCustomerCreated:g},null,8,["modelValue","pos-profile"])],64))}},pp=xt(ra,[["__scopeId","data-v-05ca6388"]]),ia="pos_next_drafts",ua=1,Oe="invoices";let $t=null;function ca(o){if(o==null)return o;try{return JSON.parse(JSON.stringify(o))}catch(p){throw console.warn("Failed to sanitize draft data for IndexedDB storage",p),p}}function mt(){return U(this,null,function*(){return $t||new Promise((o,p)=>{const a=indexedDB.open(ia,ua);a.onerror=()=>p(a.error),a.onsuccess=()=>{$t=a.result,o($t)},a.onupgradeneeded=l=>{const f=l.target.result;if(!f.objectStoreNames.contains(Oe)){const x=f.createObjectStore(Oe,{keyPath:"id",autoIncrement:!0});x.createIndex("draft_id","draft_id",{unique:!0}),x.createIndex("created_at","created_at",{unique:!1}),x.createIndex("customer","customer",{unique:!1})}}})})}function da(o){return U(this,null,function*(){const p=yield mt(),a=ca(o)||{},l=Qe(Be({draft_id:`DRAFT-${Date.now()}-${Math.random().toString(36).substr(2,9)}`},a),{created_at:new Date().toISOString(),updated_at:new Date().toISOString()});return new Promise((f,x)=>{const u=p.transaction([Oe],"readwrite").objectStore(Oe).add(l);u.onsuccess=()=>f(l),u.onerror=()=>x(u.error)})})}function ma(){return U(this,null,function*(){const o=yield mt();return new Promise((p,a)=>{const x=o.transaction([Oe],"readonly").objectStore(Oe).getAll();x.onsuccess=()=>{const w=x.result.sort((r,u)=>new Date(u.created_at)-new Date(r.created_at));p(w)},x.onerror=()=>a(x.error)})})}function fa(o){return U(this,null,function*(){const p=yield mt();return new Promise((a,l)=>{const r=p.transaction([Oe],"readonly").objectStore(Oe).index("draft_id").get(o);r.onsuccess=()=>a(r.result),r.onerror=()=>l(r.error)})})}function Wt(o){return U(this,null,function*(){const p=yield mt();return new Promise((a,l)=>U(this,null,function*(){try{const f=yield fa(o);if(!f)return l(new Error("Draft not found"));const r=p.transaction([Oe],"readwrite").objectStore(Oe).delete(f.id);r.onsuccess=()=>a(!0),r.onerror=()=>l(r.error)}catch(f){l(f)}}))})}function pa(){return U(this,null,function*(){const o=yield mt();return new Promise((p,a)=>{const x=o.transaction([Oe],"readwrite").objectStore(Oe).clear();x.onsuccess=()=>p(!0),x.onerror=()=>a(x.error)})})}function va(){return U(this,null,function*(){const o=yield mt();return new Promise((p,a)=>{const x=o.transaction([Oe],"readonly").objectStore(Oe).count();x.onsuccess=()=>p(x.result),x.onerror=()=>a(x.error)})})}const ga={class:"flex flex-col gap-3"},_a={key:0,class:"text-center py-8"},ha={class:"text-sm font-medium text-gray-900"},ya={class:"text-xs text-gray-500 mt-1"},xa={key:1,class:"flex flex-col gap-2 max-h-96 overflow-y-auto"},ba=["onClick"],wa={class:"flex items-start justify-between mb-2"},ka={class:"flex-1"},$a={class:"text-sm font-semibold text-gray-900"},Ca={key:0,class:"text-xs text-gray-500 mt-0.5"},Sa={class:"text-xs text-gray-400 mt-0.5"},Pa=["onClick","title"],Ma={class:"flex items-center justify-between text-xs"},Ia={class:"text-gray-600"},Ea={class:"font-bold text-blue-600"},Da={key:0,class:"mt-2 pt-2 border-t border-gray-100"},Va={class:"flex flex-wrap gap-1"},Aa={key:0,class:"text-[10px] text-gray-500 px-1.5 py-0.5"},ja={class:"flex justify-between items-center w-full"},Ba={class:"py-3"},Ta={class:"text-sm text-gray-600"},za={class:"flex gap-2 w-full"},La={class:"py-3"},Ra={class:"text-sm text-gray-600"},Oa={class:"flex gap-2 w-full"},vp={__name:"DraftInvoicesDialog",props:{modelValue:Boolean,currency:{type:String,default:"USD"}},emits:["update:modelValue","load-draft","drafts-updated"],setup(o,{emit:p}){const{showSuccess:a,showError:l}=Ze(),f=o,x=p,w=C(f.modelValue),r=C([]),u=C(!1),d=C(!1),k=C(null);be(()=>f.modelValue,$=>{w.value=$,$&&y()}),be(w,$=>{x("update:modelValue",$)}),Dt(()=>{y()});function y(){return U(this,null,function*(){try{r.value=yield ma()}catch($){console.error("Error loading drafts:",$),l(__("Failed to load draft invoices"))}})}function I($){k.value=$,u.value=!0}function P(){return U(this,null,function*(){try{yield Wt(k.value),yield y(),u.value=!1,k.value=null,x("drafts-updated"),a(__("Draft invoice deleted"))}catch($){console.error("Error deleting draft:",$),l(__("Failed to delete draft"))}})}function S(){return U(this,null,function*(){try{yield pa(),yield y(),d.value=!1,x("drafts-updated"),a(__("All draft invoices deleted"))}catch($){console.error("Error clearing drafts:",$),l(__("Failed to clear drafts"))}})}function E($){return new Date($).toLocaleString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function _($){return tt(Number.parseFloat($||0),f.currency)}function j($){return!$||$.length===0?0:$.reduce((g,i)=>{const c=i.quantity||i.qty||1,m=i.rate||0;return g+c*m},0)}return($,g)=>(s(),n(me,null,[se(B(Ve),{modelValue:w.value,"onUpdate:modelValue":g[2]||(g[2]=i=>w.value=i),options:{title:$.__("Draft Invoices"),size:"lg"}},{"body-content":W(()=>[e("div",ga,[r.value.length===0?(s(),n("div",_a,[g[7]||(g[7]=e("div",{class:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3"},[e("svg",{class:"h-8 w-8 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})])],-1)),e("p",ha,t($.__("No draft invoices")),1),e("p",ya,t($.__("Save invoices as drafts to continue later")),1)])):(s(),n("div",xa,[(s(!0),n(me,null,ve(r.value,i=>{var c,m,M;return s(),n("div",{key:i.draft_id,class:"bg-white border border-gray-200 rounded-lg p-3 hover:border-blue-400 transition-all cursor-pointer",onClick:b=>$.$emit("load-draft",i)},[e("div",wa,[e("div",ka,[e("h4",$a,t(i.draft_id),1),i.customer?(s(),n("p",Ca,t($.__("Customer: {0}",[((c=i.customer)==null?void 0:c.customer_name)||((m=i.customer)==null?void 0:m.name)||i.customer])),1)):T("",!0),e("p",Sa,t(E(i.created_at)),1)]),e("button",{onClick:ut(b=>I(i.draft_id),["stop"]),class:"text-gray-400 hover:text-red-600 transition-colors p-1",title:$.__("Delete draft")},g[8]||(g[8]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})],-1)]),8,Pa)]),e("div",Ma,[e("span",Ia,t($.__("{0} item(s)",[((M=i.items)==null?void 0:M.length)||0])),1),e("span",Ea,t(_(j(i.items))),1)]),i.items&&i.items.length>0?(s(),n("div",Da,[e("div",Va,[(s(!0),n(me,null,ve(i.items.slice(0,3),(b,O)=>(s(),n("span",{key:O,class:"text-[10px] bg-gray-100 text-gray-700 px-1.5 py-0.5 rounded"},t(b.item_name)+" ("+t(b.quantity||b.qty)+") ",1))),128)),i.items.length>3?(s(),n("span",Aa,t($.__("+{0} more",[i.items.length-3])),1)):T("",!0)])])):T("",!0)],8,ba)}),128))]))])]),actions:W(()=>[e("div",ja,[r.value.length>0?(s(),We(B(pe),{key:0,variant:"subtle",theme:"red",onClick:g[0]||(g[0]=i=>d.value=!0)},{default:W(()=>[we(t($.__("Clear All")),1)]),_:1})):T("",!0),se(B(pe),{variant:"subtle",onClick:g[1]||(g[1]=i=>w.value=!1)},{default:W(()=>[we(t($.__("Close")),1)]),_:1})])]),_:1},8,["modelValue","options"]),se(B(Ve),{modelValue:u.value,"onUpdate:modelValue":g[4]||(g[4]=i=>u.value=i),options:{title:$.__("Delete Draft?"),size:"xs"}},{"body-content":W(()=>[e("div",Ba,[e("p",Ta,t($.__("Permanently delete this draft invoice?")),1)])]),actions:W(()=>[e("div",za,[se(B(pe),{class:"flex-1",variant:"subtle",onClick:g[3]||(g[3]=i=>u.value=!1)},{default:W(()=>[we(t($.__("Cancel")),1)]),_:1}),se(B(pe),{class:"flex-1",variant:"solid",theme:"red",onClick:P},{default:W(()=>[we(t($.__("Delete")),1)]),_:1})])]),_:1},8,["modelValue","options"]),se(B(Ve),{modelValue:d.value,"onUpdate:modelValue":g[6]||(g[6]=i=>d.value=i),options:{title:$.__("Clear All Drafts?"),size:"xs"}},{"body-content":W(()=>[e("div",La,[e("p",Ra,t($.__("Permanently delete all {0} draft invoices?",[r.value.length])),1)])]),actions:W(()=>[e("div",Oa,[se(B(pe),{class:"flex-1",variant:"subtle",onClick:g[5]||(g[5]=i=>d.value=!1)},{default:W(()=>[we(t($.__("Cancel")),1)]),_:1}),se(B(pe),{class:"flex-1",variant:"solid",theme:"red",onClick:S},{default:W(()=>[we(t($.__("Clear All")),1)]),_:1})])]),_:1},8,["modelValue","options"])],64))}},Je=et.create("PerformanceConfig"),Se={LOW:"low",MEDIUM:"medium",HIGH:"high"};function Na(){const o=navigator.hardwareConcurrency||2,p=navigator.deviceMemory||4,a=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);let l=0;return o>=8?l+=3:o>=4?l+=2:l+=1,p>=8?l+=3:p>=4?l+=2:l+=1,a&&(l=Math.max(1,l-1)),l>=5?Se.HIGH:l>=3?Se.MEDIUM:Se.LOW}function lt(o){const p={[Se.LOW]:{searchDebounce:500,searchBatchSize:100,itemsPerPage:20,backgroundSyncBatchSize:100,backgroundSyncInterval:2e4,statsUpdateFrequency:5,stockBatchDelay:800,stockMaxBatchSize:50,lazyLoadRootMargin:"50px",virtualScrollThreshold:30,indexedDBBatchSize:50,cacheWriteDelay:1e3},[Se.MEDIUM]:{searchDebounce:300,searchBatchSize:200,itemsPerPage:50,backgroundSyncBatchSize:200,backgroundSyncInterval:15e3,statsUpdateFrequency:3,stockBatchDelay:500,stockMaxBatchSize:100,lazyLoadRootMargin:"100px",virtualScrollThreshold:50,indexedDBBatchSize:200,cacheWriteDelay:500},[Se.HIGH]:{searchDebounce:150,searchBatchSize:300,itemsPerPage:100,backgroundSyncBatchSize:300,backgroundSyncInterval:1e4,statsUpdateFrequency:2,stockBatchDelay:300,stockMaxBatchSize:200,lazyLoadRootMargin:"200px",virtualScrollThreshold:100,indexedDBBatchSize:300,cacheWriteDelay:300}};return p[o]||p[Se.MEDIUM]}class Ua{constructor(){if(typeof window=="undefined"||typeof navigator=="undefined"){this.tier=Se.MEDIUM,this.config=lt(this.tier),this.cpuCores=4,this.deviceMemory=4,this.isMobile=!1,this.autoDetectedTier=Se.MEDIUM,Je.info("SSR mode detected, using medium tier defaults");return}this.cpuCores=navigator.hardwareConcurrency||2,this.deviceMemory=navigator.deviceMemory||4,this.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),this.autoDetectedTier=Na();const p=this.getStoredTier();p&&Se[p.toUpperCase()]?(this.tier=p,Je.info(`Using manual performance tier override: ${p}`)):this.tier=this.autoDetectedTier,this.config=lt(this.tier)}getStoredTier(){if(typeof window=="undefined"||!window.localStorage)return null;try{return localStorage.getItem("pos_performance_tier")}catch(p){return Je.error("Failed to read performance tier from localStorage",p),null}}setTier(p){const a=p==null?void 0:p.toLowerCase();if(!a||!Se[a.toUpperCase()])return Je.error(`Invalid performance tier: ${p}. Must be one of: low, medium, high`),!1;if(this.tier=a,this.config=lt(a),typeof window!="undefined"&&window.localStorage)try{localStorage.setItem("pos_performance_tier",a),Je.info(`Performance tier set to: ${a}`)}catch(l){Je.error("Failed to save performance tier to localStorage",l)}return typeof window!="undefined"&&window.dispatchEvent(new CustomEvent("performanceConfigChanged",{detail:{tier:a,config:this.config,autoDetected:this.autoDetectedTier}})),!0}resetTier(){if(typeof window!="undefined"&&window.localStorage)try{localStorage.removeItem("pos_performance_tier"),Je.info("Removed manual performance tier override")}catch(p){Je.error("Failed to remove performance tier from localStorage",p)}return this.tier=this.autoDetectedTier,this.config=lt(this.tier),typeof window!="undefined"&&window.dispatchEvent(new CustomEvent("performanceConfigChanged",{detail:{tier:this.tier,config:this.config,autoDetected:this.autoDetectedTier}})),!0}getTier(){return this.tier}getAutoDetectedTier(){return this.autoDetectedTier}isManualOverride(){return this.tier!==this.autoDetectedTier}get(p){return this.config[p]}getAll(){return Be({},this.config)}getCPUCores(){return this.cpuCores}getDeviceMemory(){return this.deviceMemory}isMobileDevice(){return this.isMobile}isLowEnd(){return this.tier===Se.LOW}isHighEnd(){return this.tier===Se.HIGH}getRecommendedWorkerCount(){return Math.max(1,Math.min(4,Math.floor(this.cpuCores/2)))}getThrottlingMultiplier(){switch(this.tier){case Se.HIGH:return 1;case Se.MEDIUM:return 2;case Se.LOW:return 4;default:return 2}}getDynamicBatchSize(p,a="default"){let l=this.config.backgroundSyncBatchSize;const x={search:.5,sync:1,cache:1.5,render:.3}[a]||1;let w=Math.floor(l*x);return w=Math.max(10,w),p&&p<w?p:w}}const it=(()=>{try{return new Ua}catch(o){return Je.error("Failed to initialize PerformanceConfig, using defaults",o),{tier:Se.MEDIUM,autoDetectedTier:Se.MEDIUM,config:lt(Se.MEDIUM),cpuCores:4,deviceMemory:4,isMobile:!1,getStoredTier:()=>null,setTier:()=>!1,resetTier:()=>!1,getTier:()=>Se.MEDIUM,getAutoDetectedTier:()=>Se.MEDIUM,isManualOverride:()=>!1,get:p=>lt(Se.MEDIUM)[p],getAll:()=>Be({},lt(Se.MEDIUM)),getCPUCores:()=>4,getDeviceMemory:()=>4,isMobileDevice:()=>!1,isLowEnd:()=>!1,isHighEnd:()=>!1,getRecommendedWorkerCount:()=>2,getThrottlingMultiplier:()=>2,getDynamicBatchSize:p=>Math.min(p||200,200)}}})(),Ye=et.create("POSEvents"),Fa=Array.from({length:256},(o,p)=>p.toString(16).padStart(2,"0"));function qa(){var a;const o=typeof globalThis!="undefined"&&globalThis.crypto?globalThis.crypto:typeof window!="undefined"?window.crypto:void 0;if(o!=null&&o.randomUUID)try{return o.randomUUID()}catch(l){Ye.warn("crypto.randomUUID failed, falling back to manual generation",l)}const p=(a=o==null?void 0:o.getRandomValues)==null?void 0:a.bind(o);if(p&&typeof Uint8Array!="undefined"){const l=p(new Uint8Array(16));l[6]=l[6]&15|64,l[8]=l[8]&63|128;const f=Array.from(l,x=>Fa[x]).join("");return`${f.slice(0,8)}-${f.slice(8,12)}-${f.slice(12,16)}-${f.slice(16,20)}-${f.slice(20)}`}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,l=>{const f=Math.random()*16|0;return(l==="x"?f:f&3|8).toString(16)})}const Ha=nt("posEvents",()=>{const o=C([]),p=C(new Map),a=C(100),l=C(null),f=C(new Set),x=X(()=>o.value.slice(0,20)),w=X(()=>f.value.size>0);function r(m,M){return p.value.has(m)||p.value.set(m,new Set),p.value.get(m).add(M),Ye.debug(`Listener registered for: ${m}`),()=>u(m,M)}function u(m,M){p.value.has(m)&&(p.value.get(m).delete(M),Ye.debug(`Listener removed for: ${m}`))}function d(m,M={}){const b={type:m,payload:M,timestamp:Date.now(),id:qa()};o.value.unshift(b),o.value.length>a.value&&(o.value=o.value.slice(0,a.value)),p.value.has(m)&&p.value.get(m).forEach(K=>{try{K(b.payload,b)}catch(L){Ye.error(`Error in listener for ${m}:`,L)}}),p.value.has("*")&&p.value.get("*").forEach(K=>{try{K(b.payload,b)}catch(L){Ye.error("Error in wildcard listener:",L)}}),Ye.debug(`Event emitted: ${m}`,M)}function k(m){m.forEach(({type:M,payload:b})=>d(M,b))}function y(m){l.value=Be({},m)}function I(m,M=null){const b=M||l.value;if(!b){y(m);return}const O={},K=[];for(const Z in m)m[Z]!==b[Z]&&(O[Z]={old:b[Z],new:m[Z]});if(Object.keys(O).length===0)return;"warehouse"in O&&K.push({type:"settings:warehouse-changed",payload:{oldWarehouse:O.warehouse.old,newWarehouse:O.warehouse.new,requiresStockRefresh:!0}});const F=["allow_negative_stock"].filter(Z=>Z in O);F.length>0&&(K.push({type:"settings:stock-policy-changed",payload:{changes:F.reduce((Z,ue)=>(Z[ue]=O[ue],Z),{}),requiresReload:!0}}),f.value.add("stock-policy"));const re=["max_discount_allowed","use_percentage_discount","allow_user_to_edit_additional_discount","allow_user_to_edit_item_discount","disable_rounded_total","tax_inclusive"].filter(Z=>Z in O);re.length>0&&K.push({type:"settings:pricing-changed",payload:{changes:re.reduce((Z,ue)=>(Z[ue]=O[ue],Z),{})}});const Pe=["allow_credit_sale","allow_return","allow_write_off_change","allow_partial_payment","silent_print"].filter(Z=>Z in O);Pe.length>0&&K.push({type:"settings:sales-operations-changed",payload:{changes:Pe.reduce((Z,ue)=>(Z[ue]=O[ue],Z),{})}});const le=["default_card_view","display_item_code","show_customer_balance","hide_expected_amount","display_discount_percentage","display_discount_amount"].filter(Z=>Z in O);le.length>0&&K.push({type:"settings:display-changed",payload:{changes:le.reduce((Z,ue)=>(Z[ue]=O[ue],Z),{})}}),K.push({type:"settings:changed",payload:{changes:O,allChanges:O,timestamp:Date.now()}}),k(K),y(m),Ye.info(`Settings changes detected: ${Object.keys(O).join(", ")}`)}function P(m){return f.value.has(m)}function S(m){f.value.delete(m)}function E(){f.value.clear()}function _(m){d("settings:sync-configured",{enabled:m.enabled,intervalMs:m.intervalMs,timestamp:Date.now()})}function j(m){d("sync:stock-updated",Qe(Be({},m),{timestamp:Date.now()}))}function $(){o.value=[],Ye.info("Event history cleared")}function g(m){return o.value.filter(M=>M.type===m)}function i(m){var M;return((M=p.value.get(m))==null?void 0:M.size)||0}function c(){p.value.clear(),Ye.info("All listeners removed")}return{eventHistory:o,recentEvents:x,hasPendingReloads:w,on:r,off:u,emit:d,emitBatch:k,updateSettingsSnapshot:y,detectSettingsChanges:I,isReloadPending:P,markReloadCompleted:S,clearPendingReloads:E,emitStockSyncConfigured:_,emitStockSyncStatus:j,clearHistory:$,getEventsByType:g,getListenerCount:i,removeAllListeners:c}}),Ct=et.create("Stock"),Wa=nt("stock",()=>{const o=Ha(),p=C(new Map),a=C(new Map),l=C(null),f=C(!1),x=y=>{var I;return(((I=p.value.get(y))==null?void 0:I.qty)||0)-(a.value.get(y)||0)},w=y=>{var I,P;return{code:y,server:((I=p.value.get(y))==null?void 0:I.qty)||0,reserved:a.value.get(y)||0,display:x(y),warehouse:((P=p.value.get(y))==null?void 0:P.warehouse)||l.value}},r=y=>y==null?void 0:y.forEach(I=>{var P,S;return p.value.set(I.item_code,{qty:(S=(P=I.actual_qty)!=null?P:I.stock_qty)!=null?S:0,warehouse:I.warehouse||l.value,ts:Date.now()})}),u=y=>{a.value.clear(),y==null||y.forEach(I=>{const P=Number(I.quantity)||0;P>0&&a.value.set(I.item_code,P)})},d=y=>y==null?void 0:y.forEach(I=>{var P;return p.value.set(I.item_code,{qty:(P=I.actual_qty)!=null?P:I.stock_qty,warehouse:I.warehouse||l.value,ts:Date.now()})}),k=(y,I)=>U(void 0,null,function*(){if(!I&&!l.value)return;f.value=!0;const P=new Map(a.value);try{const S=y||Array.from(p.value.keys());if(!S.length)return;const E=yield Promise.race([Fe("pos_next.api.items.get_stock_quantities",{item_codes:JSON.stringify(S),warehouse:I||l.value}),new Promise((j,$)=>setTimeout($,1e4))]),_=(E==null?void 0:E.message)||E||[];d(_),yield fe.updateStockQuantities(_).catch(()=>{}),a.value=P,Ct.success(`Refreshed ${_.length} items`)}catch(S){Ct.error("Refresh failed",S),a.value=P}finally{f.value=!1}});return o.on("settings:warehouse-changed",I=>U(void 0,[I],function*({newWarehouse:y}){Ct.info(`Event received: Warehouse changed to ${y}`),l.value=y;const P=Array.from(p.value.keys());P.length>0&&(Ct.info(`Refreshing ${P.length} items for new warehouse`),yield k(P,y))})),{server:p,reserved:a,warehouse:l,refreshing:f,getDisplayStock:x,getStockInfo:w,init:r,reserve:u,update:d,refresh:k,setWarehouse:y=>l.value=y,clear:()=>a.value.clear(),reset:()=>{p.value.clear(),a.value.clear()}}}),Ie=et.create("RealtimePosProfile"),At="pos_profile_updated",Ga=300,St=3,Ot=1e3,ct=C(!1),gt=C(!1),Le=new Set,_t=new Map;let Xe=0,ht=null;function Qa(o){return!o||typeof o!="object"?(Ie.warn("Invalid event payload: not an object",{data:o}),!1):!o.pos_profile||typeof o.pos_profile!="string"?(Ie.warn("Invalid event payload: missing or invalid pos_profile",{data:o}),!1):!0}function Ka(o,p){return U(this,null,function*(){try{yield Promise.resolve(o(p))}catch(a){Ie.error("Handler execution failed",{error:a.message,stack:a.stack,profile:p.pos_profile})}})}function Gt(o){var r;if(!Qa(o))return;const{pos_profile:p,change_type:a,item_groups:l,timestamp:f}=o;Ie.info("POS Profile update received",{profile:p,changeType:a,itemGroupCount:(r=l==null?void 0:l.length)!=null?r:0,timestamp:f,handlerCount:Le.size});const x=_t.get(p);x&&clearTimeout(x);const w=setTimeout(()=>{_t.delete(p);const u=Array.from(Le).map(d=>Ka(d,o));Promise.all(u).then(()=>{Ie.debug("All handlers executed",{profile:p,handlerCount:Le.size})})},Ga);_t.set(p,w)}function Qt(){var o;return typeof window=="undefined"?(Ie.warn("Window object not available (SSR context)"),!1):(o=window.frappe)!=null&&o.realtime?!0:(Ie.warn("Socket.IO client not initialized (window.frappe.realtime)"),!1)}function yt(){if(ct.value||gt.value){Ie.debug("Already listening or connecting");return}if(!Qt()){if(Xe<St){Xe++;const o=Ot*Xe;Ie.info(`Socket unavailable, retrying in ${o}ms (attempt ${Xe}/${St})`),ht=setTimeout(()=>{yt()},o)}else Ie.error(`Failed to connect after ${St} attempts`);return}try{gt.value=!0,window.frappe.realtime.on(At,Gt),ct.value=!0,gt.value=!1,Xe=0,Ie.success("Started listening to POS Profile updates",{event:At,handlerCount:Le.size})}catch(o){gt.value=!1,Ie.error("Failed to start listening",o),Xe<St&&(Xe++,ht=setTimeout(()=>yt(),Ot))}}function Pt(){if(ht&&(clearTimeout(ht),ht=null),_t.forEach(o=>clearTimeout(o)),_t.clear(),!ct.value){Ie.debug("Not currently listening");return}try{Qt()&&window.frappe.realtime.off(At,Gt),ct.value=!1,Xe=0,Ie.info("Stopped listening to POS Profile updates")}catch(o){ct.value=!1,Ie.error("Error while stopping listener",o)}}function Ja(){Ie.info("Forcing reconnection"),Pt(),Xe=0,yt()}function Ya(){function o(l){if(typeof l!="function")throw new TypeError(`Handler must be a function, received: ${typeof l}`);return Le.has(l)?(Ie.warn("Handler already registered (duplicate)"),()=>{}):(Le.add(l),Ie.debug("Handler registered",{handlerCount:Le.size}),Le.size===1&&yt(),()=>{Le.delete(l),Ie.debug("Handler unregistered",{handlerCount:Le.size}),Le.size===0&&Pt()})}function p(){return Le.size}function a(){Ie.warn("Clearing all handlers",{count:Le.size}),Le.clear(),Pt()}return{isListening:zt(ct),isConnecting:zt(gt),onPosProfileUpdate:o,startListening:yt,stopListening:Pt,reconnect:Ja,getHandlerCount:p,clearAllHandlers:a}}const Q=et.create("ItemSearch"),gp=nt("itemSearch",()=>{const o=Wa(),{onPosProfileUpdate:p}=Ya(),a=C([]),l=C([]),f=C(""),x=C(null),w=C([]),r=C([]),u=C(!1),d=C(!1),k=C(!1),y=C(null),I=C([]),P=C(null),S=C("asc"),E=C(0),_=X(()=>it.get("itemsPerPage")),j=C(!0),$=C(0),g=C(!1),i=C(!1),c=C({items:0,lastSync:null}),m=C(!1),M=C(0),b=C(0),O=new Map,K=new Map,L=new Set,F=new Set;let oe=null,re=null,ye=null;function Pe(A,q){const ee=new Set(A.map(ae=>ae.item_group)),G=new Set(q.map(ae=>ae.item_group));return{added:[...G].filter(ae=>!ee.has(ae)),removed:[...ee].filter(ae=>!G.has(ae)),unchanged:[...G].filter(ae=>ee.has(ae))}}function ne(A){return U(this,null,function*(){if(!A||A.length===0)return 0;try{const q=yield fe.removeItemsByGroups(A),ee=(q==null?void 0:q.removed)||0;return Q.success(`Removed ${ee} items from ${A.length} group(s)`,{groups:A.slice(0,5),totalGroups:A.length}),ee}catch(q){throw Q.error("Failed to remove items from groups",{groups:A,error:q.message}),q}})}function le(A,q){return U(this,null,function*(){if(!A||A.length===0)return 0;try{const ee=A.map(ae=>({item_group:ae})),G=yield N(q,ee);return G.length>0?(yield fe.cacheItems(G),Q.success(`Cached ${G.length} items from ${A.length} group(s)`),G.length):0}catch(ee){return Q.error("Failed to fetch and cache new groups",ee),0}})}function Z(A,q){return U(this,null,function*(){if(A.pos_profile!==q){Q.debug("Ignoring update for different profile",{received:A.pos_profile,current:q});return}Q.info(`POS Profile ${q} updated remotely - applying smart cache update`,{changeType:A.change_type,timestamp:A.timestamp});const ee=Pe(r.value||[],A.item_groups||[]);if(A.item_groups&&(r.value=A.item_groups),ee.added.length===0&&ee.removed.length===0){Q.info("No item group changes detected - skipping cache update");return}Q.info("Item group delta calculated",{added:ee.added.length,removed:ee.removed.length,unchanged:ee.unchanged.length});try{const G=performance.now(),ae=yield ne(ee.removed),he=yield le(ee.added,q);yield v(q,!0);const ke=Math.round(performance.now()-G);Q.success("Smart cache update completed",{duration:`${ke}ms`,removed:ae,cached:he,addedGroups:ee.added.length,removedGroups:ee.removed.length})}catch(G){Q.error("Smart cache update failed - attempting recovery",{error:G.message,stack:G.stack}),yield ue(q)}})}function ue(A){return U(this,null,function*(){Q.warn("Attempting full cache recovery");try{yield fe.clearItemsCache(),Q.info("Cache cleared successfully"),yield v(A,!0),Q.success("Full cache recovery completed")}catch(q){Q.error("Recovery failed - manual intervention required",{error:q.message,stack:q.stack}),console.error("Failed to update item cache. Please refresh the page manually.",q)}})}const Me=De({url:"pos_next.api.items.get_item_groups",makeParams(){return{pos_profile:y.value}},auto:!1,onSuccess(A){w.value=(A==null?void 0:A.message)||A||[]},onError(A){Q.error("Error fetching item groups",A),w.value=[]}}),z=De({url:"pos_next.api.items.search_by_barcode",auto:!1});function J(){O.clear(),ce.clear(),Ne=""}function Y(A){!A||A.size===0||(A.forEach(q=>{const ee=q==null?void 0:q.item_code;if(!ee)return;const G=K.get(ee);G&&(G.delete(q),G.size===0&&K.delete(ee))}),A.clear())}function R(A,q){!Array.isArray(A)||A.length===0||(o.init(A),A.forEach(ee=>{if(!ee||!ee.item_code)return;let G=K.get(ee.item_code);G||(G=new Set,K.set(ee.item_code,G)),G.add(ee),q.add(ee)}))}function te(A){const q=Array.isArray(A)?A:[];Y(L),a.value=q,M.value+=1,R(q,L),J()}function Ae(A){!Array.isArray(A)||A.length===0||(a.value.push(...A),M.value+=1,R(A,L),J())}function Ee(A){const q=Array.isArray(A)?A:[];Y(F),l.value=q,b.value+=1,R(q,F),J()}const ce=new Map;let Ne="";const je=X(()=>{var ae;const A=(ae=f.value)!=null&&ae.trim()?l.value:a.value;if(!(A!=null&&A.length))return[];const q=`${x.value||"all"}_${M.value}_${f.value||""}`;let ee;if(q===Ne&&ce.has(q))ee=ce.get(q);else{if(x.value)ee=A.filter(he=>he.item_group===x.value);else if(r.value&&r.value.length>0){const he=new Set(r.value.map(ke=>ke.item_group));ee=A.filter(ke=>he.has(ke.item_group))}else ee=A;if(ce.set(q,ee),Ne=q,ce.size>10){const he=ce.keys().next().value;ce.delete(he)}}const G=ee.map(he=>{var _e;const ke=o.getDisplayStock(he.item_code),ie=((_e=o.server.get(he.item_code))==null?void 0:_e.qty)||0;return Qe(Be({},he),{actual_qty:ke,stock_qty:ke,original_stock:ie})});return P.value&&G.sort((he,ke)=>{var _e,Ue,Ke,rt;let ie=0;switch(P.value){case"name":const at=(he.item_name||"").toLowerCase(),Zt=(ke.item_name||"").toLowerCase();ie=at.localeCompare(Zt);break;case"quantity":ie=((_e=he.actual_qty)!=null?_e:0)-((Ue=ke.actual_qty)!=null?Ue:0);break;case"item_group":const eo=(he.item_group||"").toLowerCase(),to=(ke.item_group||"").toLowerCase();ie=eo.localeCompare(to);break;case"price":ie=((Ke=he.price_list_rate)!=null?Ke:0)-((rt=ke.price_list_rate)!=null?rt:0);break;case"item_code":const oo=(he.item_code||"").toLowerCase(),so=(ke.item_code||"").toLowerCase();ie=oo.localeCompare(so);break;default:ie=0}return S.value==="desc"?-ie:ie}),G});function v(A,q=!1){return U(this,null,function*(){if(A){y.value=A,u.value=!0,E.value=0,j.value=!0,$.value=0;try{const ee=r.value||[],G=ee.length>0;Q.info("Loading items with filter strategy",{profile:A,filterCount:ee.length,filters:G?ee.map(ie=>ie.item_group).slice(0,3):[],forceServerFetch:q});const ae=yield fe.getCacheStats();c.value=ae,g.value=ae.cacheReady;const he=Vt(),ke=q||!m.value||!ae.cacheReady;if(he){if(Q.info("Offline mode - loading from cache"),ae.cacheReady&&ae.items>0)try{const ie=G?1e4:_.value,_e=yield fe.searchCachedItems("",ie);_e&&_e.length>0?(te(_e),$.value=_e.length,E.value=_e.length,j.value=G?!1:_e.length>=_.value,Q.success(`Loaded ${_e.length} items from cache (offline mode)`)):(te([]),Q.warn("No items in cache"))}catch(ie){Q.error("Cache load failed in offline mode",ie),te([])}else Q.warn("Cache not ready in offline mode"),te([]);u.value=!1;return}if(!ke&&ae.cacheReady&&ae.items>0){Q.info("Using cached items (already fetched from server this session)");try{const ie=G?1e4:_.value,_e=yield fe.searchCachedItems("",ie);if(_e&&_e.length>0){te(_e),$.value=_e.length,E.value=_e.length,j.value=G?!1:_e.length>=_.value,u.value=!1,Q.success(`Loaded ${_e.length} items from cache`);return}}catch(ie){Q.warn("Cache load failed, will fetch from server",ie)}}if(Q.debug("Fetching fresh data from server"),G){Q.debug(`Fetching items from ${ee.length} filtered groups`);const ie=yield N(A,ee);te(ie),$.value=ie.length,E.value=ie.length,j.value=!1,ie.length>0?(yield fe.clearItemsCache(),yield fe.cacheItems(ie),g.value=!0,m.value=!0,Q.success(`Loaded and cached ${ie.length} filtered items`)):Q.info("No items found for the selected filter groups")}else{Q.debug(`Fetching ${_.value} items (no filters)`);const ie=yield Fe("pos_next.api.items.get_items",{pos_profile:A,search_term:"",item_group:null,start:0,limit:_.value}),_e=(ie==null?void 0:ie.message)||ie||[];_e.length>0&&(te(_e),$.value=_e.length,E.value=_e.length,j.value=!0,yield fe.clearItemsCache(),yield fe.cacheItems(_e),m.value=!0,Q.success(`Loaded ${_e.length} items from server`)),(!ae.cacheReady||ae.items<50)&&ge(A,[])}}catch(ee){Q.error("Error loading items",ee);try{const G=yield fe.searchCachedItems("",_.value);te(G||[]),$.value=(G==null?void 0:G.length)||0,E.value=(G==null?void 0:G.length)||0,j.value=((G==null?void 0:G.length)||0)>=_.value,Q.info(`Loaded ${(G==null?void 0:G.length)||0} items from cache (fallback)`)}catch(G){Q.error("Cache also failed",G),te([])}}finally{u.value=!1}}})}function N(A,q){return U(this,null,function*(){const ee=q.map(he=>U(this,null,function*(){const ke=he.item_group;try{const ie=yield Fe("pos_next.api.items.get_items",{pos_profile:A,search_term:"",item_group:ke,start:0,limit:1e3}),_e=(ie==null?void 0:ie.message)||ie||[];return Q.debug(`Fetched ${_e.length} items from group: ${ke}`),_e}catch(ie){return Q.error(`Failed to fetch items from group: ${ke}`,ie),[]}})),G=yield Promise.all(ee),ae=new Map;for(const he of G)for(const ke of he)ae.has(ke.item_code)||ae.set(ke.item_code,ke);return Array.from(ae.values())})}function V(){return U(this,null,function*(){if(!(d.value||!j.value||!y.value)&&!(f.value&&f.value.trim().length>0)){if(x.value){Q.debug("Item group filter active - all items already loaded, disabling infinite scroll"),j.value=!1;return}if(r.value&&r.value.length>0){Q.debug("POS Profile filters active - all items already loaded, disabling infinite scroll"),j.value=!1;return}d.value=!0;try{const A=yield Fe("pos_next.api.items.get_items",{pos_profile:y.value,search_term:"",item_group:null,start:E.value,limit:_.value}),q=(A==null?void 0:A.message)||A||[];q.length>0?(Ae(q),$.value+=q.length,E.value+=q.length,j.value=q.length===_.value,yield fe.cacheItems(q),Q.debug(`Loaded ${q.length} more items, total: ${$.value}`)):(j.value=!1,Q.info("All items loaded from server"))}catch(A){Q.error("Error loading more items",A),j.value=!1}finally{d.value=!1}}})}function ge(ee){return U(this,arguments,function*(A,q=[]){if(re)return;if(q.length>0){Q.info("Skipping background sync - filtered items already cached");return}Q.info("Starting background cache sync (no filters)"),i.value=!0;let ae=E.value||0;const he=it.get("backgroundSyncBatchSize"),ke=it.get("statsUpdateFrequency");let ie=0;const _e=()=>U(this,null,function*(){try{Q.debug(`Background sync: fetching batch at offset ${ae}`);const Ue=yield Fe("pos_next.api.items.get_items",{pos_profile:A,search_term:"",item_group:null,start:ae,limit:he}),Ke=(Ue==null?void 0:Ue.message)||Ue||[];if(Ke.length>0){if(yield fe.cacheItems(Ke),ae+=Ke.length,ie++,ie%ke===0||Ke.length<he){const at=yield fe.getCacheStats();c.value=at,g.value=at.cacheReady,Q.debug(`Background sync: cached ${ae} total items`)}else Q.debug(`Background sync: cached ${Ke.length} items, offset: ${ae}`);if(Ke.length<he){Q.success("Background sync complete - all items cached");const at=yield fe.getCacheStats();c.value=at,g.value=at.cacheReady,clearInterval(re),re=null,i.value=!1}}else{Q.success("Background sync complete - no more items");const rt=yield fe.getCacheStats();c.value=rt,g.value=rt.cacheReady,clearInterval(re),re=null,i.value=!1}}catch(Ue){Q.error("Background sync error",Ue)}});if(yield _e(),i.value&&!re){const Ue=it.get("backgroundSyncInterval");re=setInterval(_e,Ue),Q.info(`Background sync interval set to ${Ue}ms based on device performance`)}})}function de(){re&&(clearInterval(re),re=null,i.value=!1,Q.info("Background cache sync stopped"))}function h(A){return U(this,null,function*(){if(oe&&clearTimeout(oe),!A||A.trim().length===0){Ee([]),k.value=!1;return}return new Promise(q=>{oe=setTimeout(()=>U(this,null,function*(){k.value=!0;const ee=it.get("searchBatchSize")||500;try{Q.debug(`Searching cache for: "${A}"`);const G=yield fe.searchCachedItems(A,ee);G&&G.length>0&&(Ee(G),k.value=!1,Q.success(`Found ${G.length} items in cache`),q(G)),Q.debug(`Searching server for: "${A}"`);const ae=yield Fe("pos_next.api.items.get_items",{pos_profile:y.value,search_term:A,item_group:x.value,start:0,limit:ee}),he=(ae==null?void 0:ae.message)||ae||[];he.length>0?(Ee(he),Q.success(`Found ${he.length} items on server`),yield fe.cacheItems(he),(!G||G.length===0)&&q(he)):(!G||G.length===0)&&(Ee([]),q([]))}catch(G){if(Q.error("Error searching items",G),!l.value||l.value.length===0)try{const ae=yield fe.searchCachedItems(A,ee);Ee(ae||[]),q(ae||[]),Q.info(`Fallback: found ${(ae==null?void 0:ae.length)||0} items in cache`)}catch(ae){Q.error("Cache search also failed",ae),Ee([]),q([])}}finally{k.value=!1}}),it.get("searchDebounce"))})})}function D(){y.value&&Me.reload()}function H(A){return U(this,null,function*(){try{if(!y.value)throw Q.error("No POS Profile set in store"),new Error("POS Profile not set");Q.debug("Calling searchByBarcode API",{posProfile:y.value});const q=yield z.submit({barcode:A,pos_profile:y.value});return(q==null?void 0:q.message)||q}catch(q){throw Q.error("Store searchByBarcode error",q),q}})}function $e(A){return U(this,null,function*(){try{const q=yield fe.isCacheReady();if(Vt()||q){const ee=yield fe.searchCachedItems(A,1);return(ee==null?void 0:ee[0])||null}else return null}catch(q){return Q.error("Error getting item",q),null}})}function ot(A){f.value=A,A&&A.trim().length>0?h(A):(Ee([]),k.value=!1)}function bt(){f.value="",Ee([]),k.value=!1,oe&&(clearTimeout(oe),oe=null)}function qe(A,q="asc"){P.value=A,S.value=q,J(),Q.debug(`Sort filter set: ${A} ${q}`)}function Ge(){P.value=null,S.value="asc",J(),Q.debug("Sort filter cleared")}function ft(){de(),oe&&(clearTimeout(oe),oe=null),ye&&(ye(),ye=null)}function Kt(A){var q;x.value=A,J(),(q=f.value)!=null&&q.trim()&&(oe&&(clearTimeout(oe),oe=null),h(f.value))}function Jt(A){I.value=A,o.reserve(A)}function Yt(A,q=!0){return U(this,null,function*(){var ee;if(y.value=A,m.value=!1,ye&&(ye(),ye=null),A)try{const G=yield Fe("pos_next.api.pos_profile.get_pos_profile_data",{pos_profile:A});(ee=G==null?void 0:G.pos_profile)!=null&&ee.item_groups?(r.value=G.pos_profile.item_groups,Q.info(`Loaded ${r.value.length} item group filters from POS Profile`)):(r.value=[],Q.info("No item group filters in POS Profile")),ye=p(ae=>U(this,null,function*(){yield Z(ae,A)})),Q.debug("Real-time POS Profile update listener registered"),q&&(Q.debug("Auto-loading items with filters"),yield v(A),yield D())}catch(G){Q.error("Error fetching POS Profile item groups",G),r.value=[]}else r.value=[]})}function Xt(){J()}return{allItems:a,searchResults:l,searchTerm:f,selectedItemGroup:x,itemGroups:w,profileItemGroups:r,loading:u,loadingMore:d,searching:k,posProfile:y,cartItems:I,hasMore:j,totalItemsLoaded:$,currentOffset:E,cacheReady:g,cacheSyncing:i,cacheStats:c,sortBy:P,sortOrder:S,filteredItems:je,loadAllItems:v,loadMoreItems:V,searchItems:h,loadItemGroups:D,searchByBarcode:H,getItem:$e,setSearchTerm:ot,setSearchResults:Ee,clearSearch:bt,setSelectedItemGroup:Kt,setCartItems:Jt,setPosProfile:Yt,startBackgroundCacheSync:ge,stopBackgroundCacheSync:de,cleanup:ft,invalidateCache:Xt,setSortFilter:qe,clearSortFilter:Ge,applyStockUpdates:A=>o.update(A),refreshStockFromServer:(A,q)=>o.refresh(A,q),stockStore:o,itemGroupsResource:Me,searchByBarcodeResource:z}}),Xa={class:"sr-only"},Za={key:0,class:"flex flex-col gap-4"},el={class:"flex items-center gap-3 pb-4 border-b border-gray-200"},tl={class:"w-16 h-16 bg-gray-100 rounded-lg flex-shrink-0 flex items-center justify-center overflow-hidden"},ol=["src","alt"],sl={key:1,class:"h-8 w-8 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},nl={class:"flex-1 min-w-0"},al={class:"text-base font-semibold text-gray-900 truncate"},ll={class:"text-sm text-gray-500 truncate"},rl={class:"grid grid-cols-2 gap-4"},il={class:"flex flex-col gap-4"},ul={class:"block text-sm font-medium text-gray-700 mb-2 text-start"},cl={key:0,class:"w-full h-10 border border-gray-300 rounded-lg bg-gray-50 flex items-center justify-center"},dl={class:"text-sm font-semibold text-gray-600"},ml={key:1,class:"w-full h-10 border border-gray-300 rounded-lg bg-white flex items-center overflow-hidden"},fl={class:"flex-1 h-full flex items-center justify-center px-3"},pl={class:"block text-sm font-medium text-gray-700 mb-2 text-start"},vl={class:"relative h-10"},gl={class:"absolute inset-y-0 start-0 ps-3 flex items-center text-gray-500 text-sm font-medium"},_l={class:"flex flex-col gap-4"},hl={class:"block text-sm font-medium text-gray-700 mb-2 text-start"},yl=["value"],xl=["value"],bl={class:"block text-sm font-medium text-gray-700 mb-2 text-start"},wl=["value"],kl=["value"],$l={key:0,class:"border-t border-gray-200 pt-4"},Cl={class:"flex items-center justify-between mb-3"},Sl={class:"block text-sm font-medium text-gray-700 text-start"},Pl={class:"ms-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"},Ml={class:"flex flex-col gap-2 max-h-40 overflow-y-auto"},Il={class:"flex items-center gap-2"},El={class:"inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-600 text-white text-xs font-medium"},Dl={class:"text-sm font-medium text-gray-900"},Vl=["onClick","disabled","title"],Al={key:1,class:"border-t border-gray-200 pt-4"},jl={class:"block text-sm font-medium text-gray-700 mb-3 text-start"},Bl={class:"grid grid-cols-2 gap-3"},Tl={class:"block text-xs text-gray-600 mb-1 text-start"},zl={value:"percentage"},Ll={value:"amount"},Rl={class:"block text-xs text-gray-600 mb-1 text-start"},Ol={class:"relative"},Nl=["max"],Ul={class:"absolute inset-y-0 end-0 pe-3 flex items-center text-gray-500 text-sm"},Fl={class:"bg-gray-50 rounded-lg p-4 flex flex-col gap-2"},ql={class:"flex items-center justify-between text-sm"},Hl={class:"text-gray-600"},Wl={class:"font-semibold text-gray-900"},Gl={key:0,class:"flex items-center justify-between text-sm text-red-600"},Ql={class:"font-semibold"},Kl={class:"flex items-center justify-between pt-2 border-t border-gray-200"},Jl={class:"text-base font-bold text-gray-900"},Yl={class:"text-lg font-bold text-blue-600"},Xl={class:"flex items-center justify-end gap-2"},Zl={key:0},er={key:1},tr={key:2},or={__name:"EditItemDialog",props:{modelValue:Boolean,item:Object,warehouses:{type:Array,default:()=>[]},currency:{type:String,default:"EGP"}},emits:["update:modelValue","update-item"],setup(o,{emit:p}){const{showSuccess:a,showError:l,showWarning:f}=Ze(),x=Ft(),w=Ut(),r=o,u=p,d=C(null),k=C(1),y=C(""),I=C(0),P=C(""),S=C("percentage"),E=C(0),_=C(0),j=C(0),$=C(0),g=C(!0),i=C(!1),c=C([]),m=C([]),M=C([]),b=X({get:()=>r.modelValue,set:R=>u("update:modelValue",R)}),O=X(()=>!d.value||!d.value.item_uoms?[]:d.value.item_uoms.filter(R=>R.uom!==d.value.stock_uom)),K=X(()=>Ht(r.currency));be(()=>r.item,R=>{var te;if(R){if(d.value=Be({},R),k.value=R.quantity||1,y.value=R.uom||R.stock_uom||__("Nos"),I.value=R.rate||0,P.value=R.warehouse||((te=r.warehouses[0])==null?void 0:te.name)||"",R.has_serial_no&&R.serial_no){const Ae=R.serial_no.split(`
`).filter(Ee=>Ee.trim());c.value=[...Ae],M.value=[...Ae],m.value=[],k.value=Ae.length}else c.value=[],M.value=[],m.value=[];R.discount_percentage&&R.discount_percentage>0?(S.value="percentage",E.value=R.discount_percentage):R.discount_amount&&R.discount_amount>0?(S.value="amount",E.value=R.discount_amount):(S.value="percentage",E.value=0),g.value=!0,i.value=!1,ue()}},{immediate:!0});function L(R){if(R===Math.floor(R))return 1;const te=Math.round(R*1e4)/1e4;return Math.abs(te%.5)<1e-4?.5:Math.abs(te%.25)<1e-4?.25:Math.abs(te%.1)<1e-4?.1:.01}function F(){const R=L(k.value);k.value=Math.round((k.value+R)*1e4)/1e4,ue()}function oe(){const R=L(k.value),te=Math.round((k.value-R)*1e4)/1e4;te>0&&(k.value=te,ue())}function re(){k.value>0&&!isNaN(k.value)&&ue()}function ye(){!k.value||k.value<=0||isNaN(k.value)?k.value=1:k.value=Math.round(k.value*1e4)/1e4,ue()}function Pe(){ue()}function ne(){return U(this,null,function*(){if(!(!d.value||!P.value)){i.value=!0;try{const R=yield go(d.value.item_code,P.value);R===0?(g.value=!1,l(__('"{0}" is not available in warehouse "{1}". Please select another warehouse.',[d.value.item_name,P.value]))):R<k.value?(g.value=!1,f(__('Only {0} units of "{1}" available in "{2}". Current quantity: {3}',[R,d.value.item_name,P.value,k.value]))):(g.value=!0,a(__('{0} units available in "{1}"',[R,P.value])))}catch(R){console.error("Error checking warehouse stock:",R),g.value=!0}finally{i.value=!1}}})}function le(){E.value=0,ue()}function Z(){S.value==="percentage"?(E.value>100&&(E.value=100),j.value=_.value*E.value/100):(E.value>_.value&&(E.value=_.value),j.value=E.value),$.value=_.value-j.value}function ue(){_.value=I.value*k.value,Z()}function Me(R){const te=c.value.indexOf(R);te>-1&&(c.value.splice(te,1),m.value.push(R),k.value=c.value.length,ue())}function z(R){return tt(Number.parseFloat(R||0),r.currency)}function J(){const R=Qe(Be({},d.value),{quantity:k.value,uom:y.value,rate:I.value,warehouse:P.value,discount_percentage:S.value==="percentage"?E.value:0,discount_amount:S.value==="amount"?E.value:0});d.value.has_serial_no&&(R.serial_no=c.value.join(`
`),R.quantity=c.value.length,m.value.length>0&&w.returnSerials(d.value.item_code,m.value)),u("update-item",R),b.value=!1}function Y(){b.value=!1}return(R,te)=>(s(),We(B(Ve),{modelValue:b.value,"onUpdate:modelValue":te[7]||(te[7]=Ae=>b.value=Ae),options:{title:R.__("Edit Item Details"),size:"md"}},{"body-title":W(()=>[e("span",Xa,t(R.__("Edit item quantity, UOM, warehouse, and discount")),1)]),"body-content":W(()=>{var Ae,Ee;return[d.value?(s(),n("div",Za,[e("div",el,[e("div",tl,[d.value.image?(s(),n("img",{key:0,src:d.value.image,alt:d.value.item_name,class:"w-full h-full object-cover"},null,8,ol)):(s(),n("svg",sl,te[8]||(te[8]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"},null,-1)])))]),e("div",nl,[e("h3",al,t(d.value.item_name),1),e("p",ll,t(z(d.value.price_list_rate||d.value.rate))+" / "+t(d.value.stock_uom||R.__("Nos",null,"UOM")),1)])]),e("div",rl,[e("div",il,[e("div",null,[e("label",ul,t(R.__("Quantity")),1),(Ae=d.value)!=null&&Ae.has_serial_no&&c.value.length>0?(s(),n("div",cl,[e("span",dl,t(c.value.length),1)])):(s(),n("div",ml,[e("button",{type:"button",onClick:oe,class:"w-[40px] h-[40px] min-w-[40px] bg-gray-100 hover:bg-gray-200 active:bg-gray-300 text-gray-700 font-bold text-lg transition-colors flex items-center justify-center border-e border-gray-300",style:{flex:"0 0 40px"}}," âˆ’ "),e("div",fl,[Ce(e("input",{"onUpdate:modelValue":te[0]||(te[0]=ce=>k.value=ce),type:"number",min:"0.0001",step:"any",inputmode:"decimal",class:"w-full text-center border-0 text-sm font-semibold focus:outline-none focus:ring-0 bg-transparent",onInput:re,onBlur:ye,onKeydown:te[1]||(te[1]=Et(ce=>ce.target.blur(),["enter"]))},null,544),[[Re,k.value,void 0,{number:!0}]])]),e("button",{type:"button",onClick:F,class:"w-[40px] h-[40px] min-w-[40px] bg-gray-100 hover:bg-gray-200 active:bg-gray-300 text-gray-700 font-bold text-lg transition-colors flex items-center justify-center border-s border-gray-300",style:{flex:"0 0 40px"}}," + ")]))]),e("div",null,[e("label",pl,t(R.__("Rate")),1),e("div",vl,[e("span",gl,t(K.value),1),Ce(e("input",{"onUpdate:modelValue":te[2]||(te[2]=ce=>I.value=ce),type:"number",min:"0",step:"0.01",readonly:"",class:"w-full h-10 border border-gray-300 rounded-lg ps-16 pe-3 text-sm font-semibold bg-gray-50 cursor-not-allowed"},null,512),[[Re,I.value,void 0,{number:!0}]])])])]),e("div",_l,[e("div",null,[e("label",hl,t(R.__("UOM")),1),Ce(e("select",{"onUpdate:modelValue":te[3]||(te[3]=ce=>y.value=ce),onChange:Pe,class:"w-full h-10 border border-gray-300 rounded-lg px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white"},[e("option",{value:d.value.stock_uom},t(d.value.stock_uom),9,yl),O.value.length>0?(s(!0),n(me,{key:0},ve(O.value,ce=>(s(),n("option",{key:ce.uom,value:ce.uom},t(ce.uom),9,xl))),128)):T("",!0)],544),[[st,y.value]])]),e("div",null,[e("label",bl,t(R.__("Warehouse")),1),Ce(e("select",{"onUpdate:modelValue":te[4]||(te[4]=ce=>P.value=ce),onChange:ne,class:"w-full h-10 border border-gray-300 rounded-lg px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white"},[o.warehouses.length>0?(s(!0),n(me,{key:0},ve(o.warehouses,ce=>(s(),n("option",{key:ce.name,value:ce.name},t(ce.warehouse||ce.name),9,wl))),128)):(s(),n("option",{key:1,value:P.value},t(P.value||R.__("Default")),9,kl))],544),[[st,P.value]])])])]),(Ee=d.value)!=null&&Ee.has_serial_no&&c.value.length>0?(s(),n("div",$l,[e("div",Cl,[e("label",Sl,[we(t(R.__("Serial Numbers"))+" ",1),e("span",Pl,t(c.value.length),1)])]),e("div",Ml,[(s(!0),n(me,null,ve(c.value,(ce,Ne)=>(s(),n("div",{key:ce,class:"flex items-center justify-between gap-2 p-2 bg-gray-50 rounded-lg"},[e("div",Il,[e("span",El,t(Ne+1),1),e("span",Dl,t(ce),1)]),e("button",{type:"button",onClick:je=>Me(ce),disabled:c.value.length<=1,class:"p-1 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:c.value.length<=1?R.__("Cannot remove last serial"):R.__("Remove serial")},te[9]||(te[9]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]),8,Vl)]))),128))])])):T("",!0),B(x).allowItemDiscount?(s(),n("div",Al,[e("label",jl,t(R.__("Item Discount")),1),e("div",Bl,[e("div",null,[e("label",Tl,t(R.__("Discount Type")),1),Ce(e("select",{"onUpdate:modelValue":te[5]||(te[5]=ce=>S.value=ce),onChange:le,class:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"},[e("option",zl,t(R.__("Percentage (%)")),1),e("option",Ll,t(R.__("Amount")),1)],544),[[st,S.value]])]),e("div",null,[e("label",Rl,t(S.value==="percentage"?R.__("Percentage"):R.__("Amount")),1),e("div",Ol,[Ce(e("input",{"onUpdate:modelValue":te[6]||(te[6]=ce=>E.value=ce),type:"number",min:"0",max:S.value==="percentage"?100:void 0,step:"0.01",class:"w-full border border-gray-300 rounded-lg px-3 py-2 pe-8 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",onInput:Z},null,40,Nl),[[Re,E.value,void 0,{number:!0}]]),e("span",Ul,t(S.value==="percentage"?"%":""),1)])])])])):T("",!0),e("div",Fl,[e("div",ql,[e("span",Hl,t(R.__("Subtotal:")),1),e("span",Wl,t(z(_.value)),1)]),j.value>0?(s(),n("div",Gl,[e("span",null,t(R.__("Discount:")),1),e("span",Ql,"-"+t(z(j.value)),1)])):T("",!0),e("div",Kl,[e("span",Jl,t(R.__("Total:")),1),e("span",Yl,t(z($.value)),1)])])])):T("",!0)]}),actions:W(()=>[e("div",Xl,[se(B(pe),{variant:"subtle",onClick:Y},{default:W(()=>[we(t(R.__("Cancel")),1)]),_:1}),se(B(pe),{variant:"solid",onClick:J,disabled:!g.value||i.value},{default:W(()=>[i.value?(s(),n("span",Zl,t(R.__("Checking Stock...")),1)):g.value?(s(),n("span",tr,t(R.__("Update Item")),1)):(s(),n("span",er,t(R.__("No Stock Available")),1))]),_:1},8,["disabled"])])]),_:1},8,["modelValue","options"]))}},_p=xt(or,[["__scopeId","data-v-8f053209"]]),sr={class:"pos-numpad-dark"},nr={key:0,class:"numpad-comment-display"},ar={class:"comment-text"},lr={class:"numpad-display-dark"},rr={class:"numpad-grid-dark"},ir=["onClick"],ur=["onClick"],cr=["onClick"],dr={__name:"POSNumpad",props:{modelValue:{type:[String,Number],default:""},comment:{type:String,default:""}},emits:["update:modelValue","enter","number-click"],setup(o,{emit:p}){const a=o,l=p,f=X({get:()=>{var r;return((r=a.modelValue)==null?void 0:r.toString())||""},set:r=>l("update:modelValue",r)});function x(r){if(r==="."&&f.value.includes("."))return;const u=f.value==="0"&&r!=="."?r:f.value+r;f.value=u,l("number-click",r)}function w(){f.value=""}return(r,u)=>(s(),n("div",sr,[o.comment?(s(),n("div",nr,[u[2]||(u[2]=e("span",{class:"comment-icon"},"ðŸ’¬",-1)),e("span",ar,t(o.comment),1)])):T("",!0),e("div",lr,t(f.value||"0"),1),e("div",rr,[(s(),n(me,null,ve(["1","2","3"],d=>e("button",{key:d,onClick:k=>x(d),class:"numpad-btn-dark"},t(d),9,ir)),64)),(s(),n(me,null,ve(["4","5","6"],d=>e("button",{key:d,onClick:k=>x(d),class:"numpad-btn-dark"},t(d),9,ur)),64)),(s(),n(me,null,ve(["7","8","9"],d=>e("button",{key:d,onClick:k=>x(d),class:"numpad-btn-dark"},t(d),9,cr)),64)),e("button",{onClick:u[0]||(u[0]=d=>x("0")),class:"numpad-btn-dark"}," 0 "),e("button",{onClick:u[1]||(u[1]=d=>x(".")),class:"numpad-btn-dark"}," . "),e("button",{onClick:w,class:"numpad-btn-dark clear"}," C ")])]))}},hp=xt(dr,[["__scopeId","data-v-1c564e35"]]);function Mt(o){var a;const p=(a=o.status)==null?void 0:a.toLowerCase();return p==="overdue"||o.docstatus===2?"bg-red-100 text-red-800":p==="partly paid"||p==="partially paid"?"bg-orange-100 text-orange-800":p==="unpaid"?"bg-yellow-100 text-yellow-800":p==="credit note issued"?"bg-blue-100 text-blue-800":p==="paid"||o.docstatus===1?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}const mr={class:"flex flex-col gap-4"},fr={class:"flex items-center gap-2"},pr={class:"flex-1"},vr={key:0,class:"text-center py-8"},gr={class:"mt-3 text-xs text-gray-500"},_r={key:1,class:"text-center py-8"},hr={class:"mt-2 text-sm text-gray-500"},yr={key:2,class:"flex flex-col gap-2 max-h-96 overflow-y-auto pe-2"},xr={class:"flex items-start justify-between gap-3"},br={class:"flex-1 min-w-0"},wr={class:"flex items-center gap-2 mb-1 flex-wrap"},kr={class:"text-sm font-semibold text-gray-900"},$r={key:0,class:"text-xs px-2 py-0.5 rounded-full font-medium bg-red-100 text-red-800"},Cr={class:"text-xs text-gray-600 text-start"},Sr={class:"text-xs text-gray-500 text-start"},Pr={class:"flex-shrink-0 flex flex-col items-end"},Mr={class:"text-sm font-bold text-gray-900 text-end"},Ir={class:"flex items-center gap-1 mt-2"},Er=["onClick","title"],Dr=["onClick","title"],Vr=["onClick","title"],Ar={key:3,class:"text-center"},yp={__name:"InvoiceHistoryDialog",props:{modelValue:Boolean,posProfile:String,currency:{type:String,default:"USD"}},emits:["update:modelValue","create-return","view-invoice","print-invoice"],setup(o,{emit:p}){const{showError:a}=Ze(),l=o;function f(i){return tt(Number.parseFloat(i||0),l.currency)}const x=p,w=C(l.modelValue),r=C([]),u=C(""),d=C(0),k=C(!0),y=De({url:"frappe.client.get_list",makeParams(){return{doctype:"Sales Invoice",filters:Be({is_pos:1},l.posProfile&&{pos_profile:l.posProfile}),fields:["name","customer","customer_name","posting_date","posting_time","grand_total","status","docstatus","is_return"],order_by:"creation desc",start:0,page_length:100}},auto:!1,onSuccess(i){console.log("Invoices loaded:",i),i&&Array.isArray(i)&&(r.value=i.map(c=>Qe(Be({},c),{items_count:0})))},onError(i){console.error("Error loading invoices:",i),a(__("Failed to load invoices"))}});be(()=>l.modelValue,i=>{w.value=i,i&&l.posProfile&&y.reload()}),be(w,i=>{x("update:modelValue",i)});const I=X(()=>{if(!u.value)return r.value;const i=u.value.toLowerCase();return r.value.filter(c=>{var m;return c.name.toLowerCase().includes(i)||((m=c.customer_name)==null?void 0:m.toLowerCase().includes(i))})});function P(){l.posProfile&&y.reload()}function S(){d.value++,P()}function E(){}function _(i){x("view-invoice",i)}function j(i){x("print-invoice",i)}function $(i){x("create-return",i),w.value=!1}function g(i,c){const m=new Date(i).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"});return c?`${m} ${c}`:m}return(i,c)=>(s(),We(B(Ve),{modelValue:w.value,"onUpdate:modelValue":c[2]||(c[2]=m=>w.value=m),options:{title:i.__("Invoice History"),size:"5xl"}},{"body-content":W(()=>[e("div",mr,[e("div",fr,[e("div",pr,[se(B(dt),{modelValue:u.value,"onUpdate:modelValue":c[0]||(c[0]=m=>u.value=m),type:"text",placeholder:i.__("Search by invoice number or customer..."),onInput:E},{prefix:W(()=>c[3]||(c[3]=[e("svg",{class:"h-4 w-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1)])),_:1},8,["modelValue","placeholder"])]),se(B(pe),{variant:"subtle",onClick:P,loading:B(y).loading,title:i.__("Refresh")},{default:W(()=>c[4]||(c[4]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})],-1)])),_:1},8,["loading","title"])]),B(y).loading?(s(),n("div",vr,[c[5]||(c[5]=e("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"},null,-1)),e("p",gr,t(i.__("Loading invoices...")),1)])):I.value.length===0?(s(),n("div",_r,[c[6]||(c[6]=e("svg",{class:"mx-auto h-12 w-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})],-1)),e("p",hr,t(i.__("No invoices found")),1)])):(s(),n("div",yr,[(s(!0),n(me,null,ve(I.value,m=>(s(),n("div",{key:m.name,class:"bg-white border border-gray-200 rounded-lg p-3 hover:shadow-md transition-all"},[e("div",xr,[e("div",br,[e("div",wr,[e("h4",kr,t(m.name),1),m.is_return?(s(),n("span",$r,t(i.__("Return")),1)):(s(),n("span",{key:1,class:xe(["text-xs px-2 py-0.5 rounded-full font-medium",B(Mt)(m)])},t(i.__(m.status)),3))]),e("p",Cr,t(m.customer_name),1),e("p",Sr,t(g(m.posting_date,m.posting_time)),1)]),e("div",Pr,[e("p",Mr,t(f(m.grand_total)),1),e("div",Ir,[e("button",{onClick:M=>_(m),class:"p-1.5 hover:bg-blue-50 rounded transition-colors",title:i.__("View Details")},c[7]||(c[7]=[e("svg",{class:"w-4 h-4 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})],-1)]),8,Er),e("button",{onClick:M=>j(m),class:"p-1.5 hover:bg-green-50 rounded transition-colors",title:i.__("Print")},c[8]||(c[8]=[e("svg",{class:"w-4 h-4 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"})],-1)]),8,Dr),m.docstatus===1&&!m.is_return?(s(),n("button",{key:0,onClick:M=>$(m),class:"p-1.5 hover:bg-orange-50 rounded transition-colors",title:i.__("Create Return")},c[9]||(c[9]=[e("svg",{class:"w-4 h-4 text-orange-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"})],-1)]),8,Vr)):T("",!0)])])])]))),128))])),k.value&&!B(y).loading?(s(),n("div",Ar,[se(B(pe),{variant:"subtle",onClick:S},{default:W(()=>[we(t(i.__("Load More")),1)]),_:1})])):T("",!0)])]),actions:W(()=>[se(B(pe),{variant:"subtle",onClick:c[1]||(c[1]=m=>w.value=!1)},{default:W(()=>[we(t(i.__("Close")),1)]),_:1})]),_:1},8,["modelValue","options"]))}},jr={class:"py-4"},Br={key:0,class:"mb-4"},Tr={class:"flex items-center gap-3 mb-3"},zr={class:"w-12 h-12 bg-gray-100 rounded flex items-center justify-center overflow-hidden flex-shrink-0"},Lr=["src","alt"],Rr={key:1,class:"h-6 w-6 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Or={class:"flex-1"},Nr={class:"text-sm font-semibold text-gray-900"},Ur={class:"text-xs text-gray-500"},Fr={class:"text-xs text-gray-600 mb-3"},qr={key:1,class:"flex items-center justify-center py-8"},Hr={class:"ms-3 text-sm text-gray-500"},Wr={key:2,class:"flex flex-col gap-4"},Gr={class:"flex items-center justify-center mb-4"},Qr=["src","alt"],Kr={class:"text-sm font-semibold text-gray-900 text-start block"},Jr={class:"flex flex-wrap gap-2"},Yr=["onClick"],Xr={key:0,class:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg"},Zr={class:"flex items-center justify-between"},ei={class:"text-sm font-semibold text-gray-900"},ti={class:"text-xs text-gray-500"},oi={class:"text-end"},si={class:"text-sm font-bold text-blue-600"},ni={key:1,class:"mt-4 p-3 bg-orange-50 border border-orange-200 rounded-lg"},ai={class:"text-xs text-orange-700"},li={key:3,class:"flex flex-col gap-2 max-h-96 overflow-y-auto"},ri=["onClick"],ii={class:"flex items-center justify-between"},ui={class:"flex-1"},ci={class:"text-sm font-semibold text-gray-900"},di={class:"text-xs text-gray-500"},mi={class:"text-end ms-3"},fi={class:"text-sm font-bold text-blue-600"},pi={class:"text-xs text-gray-500"},vi={key:4,class:"text-center py-8"},gi={class:"text-sm font-medium text-gray-900"},_i={key:0,class:"text-xs text-gray-500 mt-2"},hi={key:1,class:"text-xs text-gray-500 mt-2"},yi={key:2,class:"mt-4"},xi={class:"text-xs text-gray-600 mb-2"},bi={class:"text-xs text-gray-600 text-start max-w-xs mx-auto flex flex-col gap-1"},wi={class:"flex gap-2 w-full"},xp={__name:"ItemSelectionDialog",props:{modelValue:Boolean,item:Object,mode:{type:String,default:"uom"},posProfile:String,currency:{type:String,default:"USD"}},emits:["update:modelValue","option-selected"],setup(o,{emit:p}){const a=o,l=p,f=X({get:()=>a.modelValue,set:b=>l("update:modelValue",b)}),x=C(!1),w=C([]),r=C(null),u=C({}),d=X(()=>a.mode==="variant"?__("Select Item Variant"):__("Select Unit of Measure")),k=X(()=>a.mode==="variant"?__("Choose a variant of this item:"):__("Select the unit of measure for this item:")),y=X(()=>(a.mode==="variant",__("Add to Cart"))),I=X(()=>{if(a.mode!=="variant"||w.value.length===0)return{};const b={};w.value.forEach(K=>{Object.entries(K.attributes||{}).forEach(([L,F])=>{b[L]||(b[L]=new Set),b[L].add(F)})});const O={};return Object.keys(b).forEach(K=>{O[K]=Array.from(b[K]).sort()}),O}),P=X(()=>{const b=Object.keys(I.value);return b.length>0&&b.every(O=>u.value[O])}),S=X(()=>P.value?w.value.find(b=>Object.entries(u.value).every(([O,K])=>b.attributes[O]===K)):null),E=De({url:"pos_next.api.items.get_item_variants",makeParams(){var b;return{template_item:(b=a.item)==null?void 0:b.item_code,pos_profile:a.posProfile}},auto:!1,onSuccess(b){const O=(b==null?void 0:b.message)||b||[];w.value=O.map(K=>{var L;return{type:"variant",item_code:K.item_code,label:K.item_name,description:K.item_code,attributes:K.attributes||{},rate:K.rate||0,priceLabel:__("per {0}",[K.stock_uom]),stock:(L=K.actual_qty)!=null?L:0,data:K}}),x.value=!1},onError(b){console.error("Error loading variants:",b),x.value=!1}});be(()=>a.modelValue,b=>{b&&a.item&&_()}),be([()=>a.mode,()=>a.item],([,b])=>{a.modelValue&&b&&_()});function _(){r.value=null,u.value={},a.mode==="variant"?(x.value=!0,E.reload()):(w.value=j(),x.value=!1)}be(S,b=>{b?r.value=b:r.value=null});function j(){if(!a.item)return[];const b=[];return b.push({type:"uom",uom:a.item.stock_uom,conversion_factor:1,label:a.item.stock_uom,description:__("Stock unit"),rate:$(a.item.stock_uom,1),priceLabel:__("per {0}",[a.item.stock_uom])}),a.item.item_uoms&&a.item.item_uoms.length>0&&a.item.item_uoms.forEach(O=>{b.push({type:"uom",uom:O.uom,conversion_factor:O.conversion_factor,label:O.uom,description:`1 ${O.uom} = ${O.conversion_factor} ${a.item.stock_uom}`,rate:$(O.uom,O.conversion_factor),priceLabel:__("per {0}",[O.uom])})}),b}function $(b,O){return a.item?a.item.uom_prices&&a.item.uom_prices[b]?a.item.uom_prices[b]:(a.item.rate||0)*O:0}function g(b,O){u.value[b]=O,u.value=Be({},u.value)}function i(b){r.value=b}function c(){r.value&&l("option-selected",r.value)}function m(){r.value=null,u.value={},f.value=!1}function M(b){return tt(Number.parseFloat(b||0),a.currency)}return(b,O)=>(s(),We(B(Ve),{modelValue:f.value,"onUpdate:modelValue":O[0]||(O[0]=K=>f.value=K),options:{title:d.value,size:"md"}},{"body-content":W(()=>{var K,L,F,oe,re,ye,Pe,ne,le,Z,ue,Me,z,J;return[e("div",jr,[o.item?(s(),n("div",Br,[e("div",Tr,[e("div",zr,[o.item.image?(s(),n("img",{key:0,src:o.item.image,loading:"lazy",alt:o.item.item_name,class:"w-full h-full object-cover"},null,8,Lr)):(s(),n("svg",Rr,O[1]||(O[1]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"},null,-1)])))]),e("div",Or,[e("h3",Nr,t(o.item.item_name),1),e("p",Ur,t(o.item.item_code),1)])]),e("p",Fr,t(k.value),1)])):T("",!0),x.value?(s(),n("div",qr,[O[2]||(O[2]=e("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"},null,-1)),e("p",Hr,t(b.__("Loading options...")),1)])):o.mode==="variant"&&w.value.length>0?(s(),n("div",Wr,[e("div",Gr,[(L=(K=S.value)==null?void 0:K.data)!=null&&L.image||(F=o.item)!=null&&F.image?(s(),n("img",{key:0,src:((re=(oe=S.value)==null?void 0:oe.data)==null?void 0:re.image)||o.item.image,loading:"lazy",alt:((ye=S.value)==null?void 0:ye.label)||o.item.item_name,class:"w-32 h-32 object-contain rounded-lg transition-opacity duration-300"},null,8,Qr)):T("",!0)]),(s(!0),n(me,null,ve(I.value,(Y,R)=>(s(),n("div",{key:R,class:"flex flex-col gap-2"},[e("label",Kr,t(R),1),e("div",Jr,[(s(!0),n(me,null,ve(Y,te=>(s(),n("button",{key:te,onClick:Ae=>g(R,te),class:xe(["px-4 py-2 rounded-lg border-2 text-sm font-medium transition-all",u.value[R]===te?"border-blue-500 bg-blue-500 text-white":"border-gray-300 bg-white text-gray-700 hover:border-blue-300"])},t(te),11,Yr))),128))])]))),128)),S.value?(s(),n("div",Xr,[e("div",Zr,[e("div",null,[e("p",ei,t(S.value.label),1),e("p",ti,t(S.value.description),1)]),e("div",oi,[e("p",si,t(M(S.value.rate||0)),1),e("p",{class:xe(["text-xs",((le=(ne=S.value.stock)!=null?ne:(Pe=S.value.data)==null?void 0:Pe.actual_qty)!=null?le:0)>0?"text-green-600":"text-red-600"])},t(b.__("Stock: {0}",[(Me=(ue=S.value.stock)!=null?ue:(Z=S.value.data)==null?void 0:Z.actual_qty)!=null?Me:0])),3)])])])):P.value?(s(),n("div",ni,[e("p",ai,t(b.__("This combination is not available")),1)])):T("",!0)])):o.mode==="uom"&&w.value.length>0?(s(),n("div",li,[(s(!0),n(me,null,ve(w.value,(Y,R)=>(s(),n("button",{key:R,onClick:te=>i(Y),class:xe(["w-full text-start p-3 rounded-lg border-2 transition-all",r.value===Y?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-blue-300 hover:bg-gray-50"])},[e("div",ii,[e("div",ui,[e("p",ci,t(Y.label),1),e("p",di,t(Y.description),1)]),e("div",mi,[e("p",fi,t(M(Y.rate||0)),1),e("p",pi,t(Y.priceLabel),1)])])],10,ri))),128))])):(s(),n("div",vi,[O[3]||(O[3]=e("div",{class:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-orange-100 mb-3"},[e("svg",{class:"h-6 w-6 text-orange-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})])],-1)),e("p",gi,t(o.mode==="variant"?b.__("No Variants Available"):b.__("No Options Available")),1),o.mode==="variant"?(s(),n("p",_i,[se(vt,{inner:b.__("This item template <strong>{0}<strong> has no variants created yet.",[(z=o.item)==null?void 0:z.item_name])},null,8,["inner"])])):(s(),n("p",hi,t(b.__("No additional units of measurement configured for this item.")),1)),o.mode==="variant"?(s(),n("div",yi,[e("p",xi,t(b.__("To create variants:")),1),e("ol",bi,[se(vt,{tag:"li",inner:b.__("1. Go to <strong>Item Master<strong> â†’ <strong>{0}<strong>",[(J=o.item)==null?void 0:J.item_code])},null,8,["inner"]),se(vt,{tag:"li",inner:b.__('2. Click <strong>"Make Variants"<strong> button')},null,8,["inner"]),e("li",null,t(b.__("3. Select attribute combinations")),1),se(vt,{tag:"li",inner:b.__('4. Click <strong>"Create"<strong>')},null,8,["inner"])])])):T("",!0)]))])]}),actions:W(()=>[e("div",wi,[se(B(pe),{class:"flex-1",variant:"subtle",onClick:m},{default:W(()=>[we(t(b.__("Cancel")),1)]),_:1}),se(B(pe),{class:"flex-1",variant:"solid",theme:"blue",onClick:c,disabled:!r.value},{default:W(()=>[we(t(y.value),1)]),_:1},8,["disabled"])])]),_:1},8,["modelValue","options"]))}},ki={class:"flex flex-col gap-4"},$i={key:0,class:"py-8 text-center"},Ci={class:"mt-3 text-sm text-gray-500"},Si={key:1,class:"py-8 text-center"},Pi={class:"mt-3 text-sm text-gray-500"},Mi={key:2,class:"py-12 text-center"},Ii={class:"mt-4 text-sm font-medium text-gray-900"},Ei={class:"mt-2 text-xs text-gray-500"},Di={key:3},Vi={class:"flex flex-col gap-3 max-h-[500px] overflow-y-auto pe-2"},Ai={key:0,class:"absolute top-2 end-2 bg-green-600 text-white text-[10px] font-bold px-2 py-1 rounded-full flex items-center gap-1"},ji={class:"mb-3"},Bi={class:"text-base font-bold text-gray-900"},Ti={key:0,class:"text-xs text-gray-600 mt-1"},zi={class:"flex items-center gap-3 mb-3"},Li={class:"text-lg font-bold"},Ri={key:0},Oi={key:1},Ni={key:2},Ui={key:0,class:"text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full font-semibold"},Fi={class:"grid grid-cols-2 gap-3 mb-3"},qi={key:0,class:"flex items-center gap-2"},Hi={class:"text-[10px] text-gray-500"},Wi={class:"text-xs font-semibold text-gray-900"},Gi={key:1,class:"flex items-center gap-2"},Qi={class:"text-[10px] text-gray-500"},Ki={class:"text-xs font-semibold text-gray-900"},Ji={key:2,class:"flex items-center gap-2"},Yi={class:"text-[10px] text-gray-500"},Xi={class:"text-xs font-semibold text-gray-900"},Zi={class:"flex items-center gap-2"},eu={class:"text-[10px] text-gray-500"},tu={class:"text-xs font-semibold text-gray-900"},ou={key:1,class:"mt-3"},su={class:"flex items-center justify-between text-xs mb-1"},nu={class:"text-gray-600"},au={class:"text-gray-900 font-semibold"},lu={class:"w-full bg-gray-200 rounded-full h-2"},ru={class:"text-xs text-orange-600 mt-1 font-medium"},iu=["onClick","disabled"],uu={class:"flex justify-end w-full"},bp={__name:"OffersDialog",props:{modelValue:Boolean,subtotal:{type:Number,required:!0,note:__("Cart subtotal BEFORE tax - used for discount calculations")},items:Array,posProfile:String,customer:String,company:String,currency:{type:String,default:"USD"},appliedOffers:{type:Array,default:()=>[]}},emits:["update:modelValue","apply-offer","remove-offer"],setup(o,{expose:p,emit:a}){const l=_o(),f=o,x=a,w=C(f.modelValue),r=C(!1),u=X(()=>new Set((f.appliedOffers||[]).map(_=>_==null?void 0:_.code).filter(Boolean))),d=X(()=>l.allEligibleOffersSorted),k=X(()=>!l.hasFetched&&d.value.length===0);be(()=>f.modelValue,_=>{w.value=_}),be(w,_=>{x("update:modelValue",_),_||(r.value=!1)});function y(_){return U(this,null,function*(){if(!r.value){if(P(_)){r.value=!0;try{x("remove-offer",_),yield new Promise(j=>setTimeout(j,500)),w.value=!1}finally{r.value=!1}return}r.value=!0;try{x("apply-offer",_)}catch(j){console.error("Error in handleApplyOffer:",j),r.value=!1}}})}function I(){r.value=!1}p({resetApplyingState:I});function P(_){return u.value.has(_==null?void 0:_.name)}function S(_){return tt(Number.parseFloat(_||0),f.currency)}function E(_){return _?new Date(_).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):""}return(_,j)=>(s(),We(B(Ve),{modelValue:w.value,"onUpdate:modelValue":j[1]||(j[1]=$=>w.value=$),options:{title:_.__("Available Offers"),size:"lg"}},{"body-content":W(()=>[e("div",ki,[k.value?(s(),n("div",$i,[j[2]||(j[2]=e("div",{class:"animate-spin rounded-full h-10 w-10 border-b-2 border-green-500 mx-auto"},null,-1)),e("p",Ci,t(_.__("Loading offers...")),1)])):r.value?(s(),n("div",Si,[j[3]||(j[3]=e("div",{class:"animate-spin rounded-full h-10 w-10 border-b-2 border-green-500 mx-auto"},null,-1)),e("p",Pi,t(_.__("Applying offer...")),1)])):d.value.length===0?(s(),n("div",Mi,[j[4]||(j[4]=e("div",{class:"mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-gray-100"},[e("svg",{class:"h-8 w-8 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"})])],-1)),e("h3",Ii,t(_.__("No offers available")),1),e("p",Ei,t(_.__("Add items to your cart to see eligible offers")),1)])):(s(),n("div",Di,[e("div",Vi,[(s(!0),n(me,null,ve(d.value,$=>(s(),n("div",{key:$.name,class:xe(["relative rounded-xl p-4 transition-all duration-200 border-2",P($)?"bg-green-50 border-green-500 shadow-md":"bg-gradient-to-r from-green-50 to-emerald-50 border-green-200 hover:border-green-400 hover:shadow-lg cursor-pointer"])},[P($)?(s(),n("div",Ai,[j[5]||(j[5]=e("svg",{class:"w-3 h-3",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})],-1)),e("span",null,t(_.__("APPLIED")),1)])):T("",!0),e("div",{class:xe(["absolute top-2 text-[10px] font-bold px-2 py-1 rounded-full",P($)?"end-24":"end-2",$.source==="Pricing Rule"?"bg-blue-600 text-white":"bg-purple-600 text-white"])},t($.source==="Pricing Rule"?_.__("PRICING RULE"):_.__("PROMO SCHEME")),3),e("div",ji,[e("h4",Bi,t($.title||$.name),1),$.description?(s(),n("p",Ti,t($.description),1)):T("",!0)]),e("div",zi,[e("div",{class:xe(["text-white px-4 py-2 rounded-lg transition-all",P($)?"bg-green-700 ring-2 ring-green-600":$.offer==="Give Product"?"bg-purple-600":$.discount_percentage?"bg-orange-600":"bg-green-600"])},[e("div",Li,[$.discount_percentage?(s(),n("span",Ri,t(_.__("{0}% OFF",[Number($.discount_percentage).toFixed(2)])),1)):$.discount_amount?(s(),n("span",Oi,t(_.__("{0} OFF",[S($.discount_amount)])),1)):(s(),n("span",Ni,t(_.__("Special Offer")),1))])],2),$.offer==="Give Product"?(s(),n("div",Ui,t(_.__("+ Free Item")),1)):T("",!0)]),e("div",Fi,[$.min_amt?(s(),n("div",qi,[j[6]||(j[6]=e("svg",{class:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"})],-1)),e("div",null,[e("p",Hi,t(_.__("Min Purchase")),1),e("p",Wi,t(S($.min_amt)),1)])])):T("",!0),$.min_qty?(s(),n("div",Gi,[j[7]||(j[7]=e("svg",{class:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"})],-1)),e("div",null,[e("p",Qi,t(_.__("Min Quantity")),1),e("p",Ki,t(_.__("{0} items",[$.min_qty])),1)])])):T("",!0),$.valid_upto?(s(),n("div",Ji,[j[8]||(j[8]=e("svg",{class:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})],-1)),e("div",null,[e("p",Yi,t(_.__("Valid Until")),1),e("p",Xi,t(E($.valid_upto)),1)])])):T("",!0),e("div",Zi,[j[9]||(j[9]=e("svg",{class:"w-4 h-4 text-gray-500",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z","clip-rule":"evenodd"})],-1)),e("div",null,[e("p",eu,t(_.__("Type")),1),e("p",tu,t($.offer||_.__("Discount")),1)])])]),$.min_amt&&B(l).cartSnapshot.subtotal<$.min_amt?(s(),n("div",ou,[e("div",su,[e("span",nu,t(_.__("Subtotal (before tax)")),1),e("span",au,t(S(B(l).cartSnapshot.subtotal))+" / "+t(S($.min_amt)),1)]),e("div",lu,[e("div",{class:"bg-green-600 h-2 rounded-full transition-all",style:Nt({width:`${Math.min(B(l).cartSnapshot.subtotal/$.min_amt*100,100)}%`})},null,4)]),e("p",ru,t(_.__("Add {0} more to unlock",[S(B(l).getUnlockAmount($))])),1)])):T("",!0),e("button",{type:"button",onClick:ut(g=>y($),["prevent"]),disabled:r.value,class:xe(["mt-3 w-full py-2 px-4 rounded-lg font-semibold text-sm transition-all",P($)?"bg-red-600 hover:bg-red-700 text-white":"bg-green-600 hover:bg-green-700 text-white shadow-md hover:shadow-lg",r.value?"opacity-70 cursor-not-allowed":""])},t(P($)?_.__("Remove Offer"):_.__("Apply Offer")),11,iu)],2))),128))])]))])]),actions:W(()=>[e("div",uu,[se(B(pe),{variant:"subtle",onClick:j[0]||(j[0]=$=>w.value=!1)},{default:W(()=>[we(t(_.__("Close")),1)]),_:1})])]),_:1},8,["modelValue","options"]))}},cu={class:"flex flex-col gap-3 sm:flex flex-col gap-4"},du={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-3 sm:p-4 bg-orange-50 rounded-lg border border-orange-200"},mu={class:"flex items-center gap-2 sm:gap-3"},fu={class:"min-w-0"},pu={class:"font-semibold text-gray-900 text-sm sm:text-base"},vu={class:"text-xs sm:text-sm text-gray-600 truncate"},gu={key:0,class:"flex items-center justify-center py-12"},_u={key:1,class:"text-center py-12"},hu={class:"mt-4 text-gray-500"},yu={key:2,class:"flex flex-col gap-2 sm:flex flex-col gap-3 max-h-[60vh] sm:max-h-96 overflow-y-auto"},xu={class:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3"},bu={class:"flex-1 min-w-0"},wu={class:"flex flex-wrap items-center gap-2"},ku={class:"font-semibold text-gray-900 text-sm sm:text-base truncate"},$u={key:0,class:"text-[10px] sm:text-xs px-2 py-0.5 sm:py-1 bg-red-100 text-red-700 rounded-full flex-shrink-0"},Cu={class:"mt-2 flex flex-col gap-1 text-xs sm:text-sm text-gray-600"},Su={class:"flex flex-wrap items-center gap-x-3 gap-y-1"},Pu={class:"font-semibold text-gray-900"},Mu={class:"text-[10px] sm:text-xs text-gray-500"},Iu={key:0,class:"flex flex-wrap items-center gap-2"},Eu={class:"text-[10px] sm:text-xs text-gray-500"},Du={class:"flex items-center justify-end sm:justify-start gap-1 sm:gap-2"},Vu=["onClick","title"],Au=["onClick","title"],ju=["onClick","title"],Bu={key:0,class:"flex flex-col gap-3 sm:flex flex-col gap-4"},Tu={class:"bg-gray-50 p-3 sm:p-4 rounded-lg"},zu={class:"font-semibold text-gray-900 mb-2 text-sm sm:text-base"},Lu={class:"text-sm sm:text-base"},Ru={class:"bg-gray-50 p-3 sm:p-4 rounded-lg"},Ou={class:"font-semibold text-gray-900 mb-2 text-sm sm:text-base"},Nu={class:"flex flex-col gap-2"},Uu={class:"truncate"},Fu={class:"font-semibold flex-shrink-0"},qu={class:"bg-gray-50 p-3 sm:p-4 rounded-lg"},Hu={class:"flex justify-between mb-1 text-xs sm:text-sm"},Wu={class:"text-gray-600"},Gu={key:0,class:"flex justify-between mb-1 text-xs sm:text-sm"},Qu={class:"text-gray-600"},Ku={key:1,class:"flex justify-between mb-1 text-xs sm:text-sm"},Ju={class:"text-gray-600"},Yu={class:"text-red-600"},Xu={class:"flex justify-between font-semibold text-base sm:text-lg pt-2 border-t"},Zu={key:0,class:"bg-gray-50 p-3 sm:p-4 rounded-lg"},ec={class:"font-semibold text-gray-900 mb-2 text-sm sm:text-base"},tc={class:"flex flex-col gap-1"},oc={class:"font-semibold"},sc={key:0,class:"flex flex-col gap-3 sm:flex flex-col gap-4"},nc={class:"flex items-start gap-2 sm:gap-3"},ac={class:"min-w-0 flex-1"},lc={class:"text-gray-900 font-medium mb-2 text-sm sm:text-base"},rc={class:"bg-gray-50 rounded-lg p-2.5 sm:p-3 flex flex-col gap-1 text-xs sm:text-sm"},ic={class:"flex justify-between gap-2"},uc={class:"text-gray-600"},cc={class:"font-semibold truncate"},dc={class:"flex justify-between gap-2"},mc={class:"text-gray-600"},fc={class:"font-semibold"},pc={class:"flex justify-between gap-2"},vc={class:"text-gray-600"},gc={class:"font-semibold"},_c={class:"text-red-600 text-xs sm:text-sm mt-3"},wp={__name:"OfflineInvoicesDialog",props:{modelValue:Boolean,isOffline:{type:Boolean,default:!1},pendingInvoices:{type:Array,default:()=>[]},isSyncing:{type:Boolean,default:!1},currency:{type:String,default:"USD"}},emits:["update:modelValue","sync-all","delete-invoice","edit-invoice","refresh"],setup(o,{emit:p}){const a=o,l=p,f=X({get:()=>a.modelValue,set:g=>l("update:modelValue",g)}),x=C(!1),w=C([]),r=C(null),u=C(!1),d=C(!1),k=C(null);be(f,g=>U(this,null,function*(){g&&(yield y())})),be(()=>a.pendingInvoices,g=>{w.value=g});function y(){return U(this,null,function*(){x.value=!0;try{w.value=a.pendingInvoices}catch(g){console.error("Error loading offline invoices:",g)}finally{x.value=!1}})}function I(g){return tt(g,a.currency)}function P(g){const i=new Date(g),m=Math.floor((new Date-i)/1e3);return m<60?__("Just now"):m<3600?__("{0} minutes ago",[Math.floor(m/60)]):m<86400?__("{0} hours ago",[Math.floor(m/3600)]):i.toLocaleDateString()+" "+i.toLocaleTimeString()}function S(g){r.value=g,u.value=!0}function E(g){l("edit-invoice",g),f.value=!1}function _(){l("sync-all")}function j(g){k.value=g,d.value=!0}function $(){return U(this,null,function*(){if(k.value){d.value=!1;const g=k.value.id;k.value=null,l("delete-invoice",g)}})}return(g,i)=>(s(),n(me,null,[se(B(Ve),{modelValue:f.value,"onUpdate:modelValue":i[0]||(i[0]=c=>f.value=c),options:{title:g.__("Offline Invoices"),size:"xl"}},{"body-content":W(()=>[e("div",cu,[e("div",du,[e("div",mu,[i[5]||(i[5]=e("svg",{class:"w-5 h-5 sm:w-6 sm:h-6 text-orange-600 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),e("div",fu,[e("h3",pu,t(g.__("{0} Pending Invoice(s)",[w.value.length])),1),e("p",vu,t(g.__("These invoices will be submitted when you're back online")),1)])]),!o.isOffline&&w.value.length>0?(s(),We(B(pe),{key:0,onClick:_,loading:o.isSyncing,variant:"solid",class:"flex-shrink-0 whitespace-nowrap w-full sm:w-auto text-sm"},{prefix:W(()=>i[6]||(i[6]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})],-1)])),default:W(()=>[we(" "+t(g.__("Sync All")),1)]),_:1},8,["loading"])):T("",!0)]),x.value?(s(),n("div",gu,i[7]||(i[7]=[e("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"},null,-1)]))):w.value.length===0?(s(),n("div",_u,[i[8]||(i[8]=e("svg",{class:"w-16 h-16 mx-auto text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})],-1)),e("p",hu,t(g.__("No pending offline invoices")),1)])):(s(),n("div",yu,[(s(!0),n(me,null,ve(w.value,c=>{var m,M;return s(),n("div",{key:c.id,class:"border border-gray-200 rounded-lg p-3 sm:p-4 hover:bg-gray-50 transition-colors"},[e("div",xu,[e("div",bu,[e("div",wu,[e("h4",ku,t(c.data.customer||g.__("Walk-in Customer")),1),c.retry_count>0?(s(),n("span",$u,t(g.__("{0} failed",[c.retry_count])),1)):T("",!0)]),e("div",Cu,[e("div",Su,[e("span",null,t(g.__("{0} items",[((m=c.data.items)==null?void 0:m.length)||0])),1),e("span",Pu,t(I(c.data.grand_total||0)),1),e("span",Mu,t(P(c.timestamp)),1)]),((M=c.data.payments)==null?void 0:M.length)>0?(s(),n("div",Iu,[e("span",Eu,t(g.__("Payments:")),1),(s(!0),n(me,null,ve(c.data.payments,(b,O)=>(s(),n("span",{key:O,class:"text-[10px] sm:text-xs px-2 py-0.5 bg-gray-100 rounded"},t(b.mode_of_payment)+": "+t(I(b.amount)),1))),128))])):T("",!0)])]),e("div",Du,[e("button",{onClick:b=>E(c),class:"p-1.5 sm:p-2 hover:bg-blue-50 rounded-lg transition-colors touch-manipulation",title:g.__("Edit Invoice")},i[9]||(i[9]=[e("svg",{class:"w-4 h-4 sm:w-5 sm:h-5 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})],-1)]),8,Vu),e("button",{onClick:b=>S(c),class:"p-1.5 sm:p-2 hover:bg-gray-100 rounded-lg transition-colors touch-manipulation",title:g.__("View Details")},i[10]||(i[10]=[e("svg",{class:"w-4 h-4 sm:w-5 sm:h-5 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})],-1)]),8,Au),e("button",{onClick:b=>j(c),class:"p-1.5 sm:p-2 hover:bg-red-50 rounded-lg transition-colors touch-manipulation",title:g.__("Delete")},i[11]||(i[11]=[e("svg",{class:"w-4 h-4 sm:w-5 sm:h-5 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})],-1)]),8,ju)])])])}),128))]))])]),_:1},8,["modelValue","options"]),se(B(Ve),{modelValue:u.value,"onUpdate:modelValue":i[2]||(i[2]=c=>u.value=c),options:{title:g.__("Invoice Details"),size:"lg"}},{"body-content":W(()=>{var c;return[r.value?(s(),n("div",Bu,[e("div",Tu,[e("h4",zu,t(g.__("Customer")),1),e("p",Lu,t(r.value.data.customer||g.__("Walk-in Customer")),1)]),e("div",Ru,[e("h4",Ou,t(g.__("Items")),1),e("div",Nu,[(s(!0),n(me,null,ve(r.value.data.items,(m,M)=>(s(),n("div",{key:M,class:"flex justify-between text-xs sm:text-sm gap-2"},[e("span",Uu,t(m.item_name||m.item_code)+" Ã— "+t(m.quantity||m.qty),1),e("span",Fu,t(I(m.amount||0)),1)]))),128))])]),e("div",qu,[e("div",Hu,[e("span",Wu,t(g.__("Subtotal")),1),e("span",null,t(I(r.value.data.total||0)),1)]),r.value.data.total_tax?(s(),n("div",Gu,[e("span",Qu,t(g.__("Tax")),1),e("span",null,t(I(r.value.data.total_tax)),1)])):T("",!0),r.value.data.total_discount?(s(),n("div",Ku,[e("span",Ju,t(g.__("Discount")),1),e("span",Yu,"-"+t(I(r.value.data.total_discount)),1)])):T("",!0),e("div",Xu,[e("span",null,t(g.__("Grand Total")),1),e("span",null,t(I(r.value.data.grand_total||0)),1)])]),((c=r.value.data.payments)==null?void 0:c.length)>0?(s(),n("div",Zu,[e("h4",ec,t(g.__("Payments")),1),e("div",tc,[(s(!0),n(me,null,ve(r.value.data.payments,(m,M)=>(s(),n("div",{key:M,class:"flex justify-between text-xs sm:text-sm"},[e("span",null,t(m.mode_of_payment),1),e("span",oc,t(I(m.amount)),1)]))),128))])])):T("",!0)])):T("",!0)]}),actions:W(()=>[se(B(pe),{variant:"subtle",onClick:i[1]||(i[1]=c=>u.value=!1),class:"w-full sm:w-auto"},{default:W(()=>[we(t(g.__("Close")),1)]),_:1})]),_:1},8,["modelValue","options"]),se(B(Ve),{modelValue:d.value,"onUpdate:modelValue":i[4]||(i[4]=c=>d.value=c),options:{title:g.__("Delete Offline Invoice"),size:"md"}},{"body-content":W(()=>{var c;return[k.value?(s(),n("div",sc,[e("div",nc,[i[12]||(i[12]=e("svg",{class:"w-5 h-5 sm:w-6 sm:h-6 text-red-600 flex-shrink-0 mt-0.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),e("div",ac,[e("p",lc,t(g.__("Are you sure you want to delete this offline invoice?")),1),e("div",rc,[e("div",ic,[e("span",uc,t(g.__("Customer:")),1),e("span",cc,t(k.value.data.customer||g.__("Walk-in Customer")),1)]),e("div",dc,[e("span",mc,t(g.__("Amount:")),1),e("span",fc,t(I(k.value.data.grand_total)),1)]),e("div",pc,[e("span",vc,t(g.__("Items:")),1),e("span",gc,t(((c=k.value.data.items)==null?void 0:c.length)||0),1)])]),e("p",_c,t(g.__("This action cannot be undone.")),1)])])])):T("",!0)]}),actions:W(()=>[se(B(pe),{variant:"subtle",onClick:i[3]||(i[3]=c=>d.value=!1),class:"w-full sm:w-auto"},{default:W(()=>[we(t(g.__("Cancel")),1)]),_:1}),se(B(pe),{variant:"solid",theme:"red",onClick:$,class:"w-full sm:w-auto"},{default:W(()=>[we(t(g.__("Delete Invoice")),1)]),_:1})]),_:1},8,["modelValue","options"])],64))}};function It(o){return{Cash:"ðŸ’µ",Card:"ðŸ’³",Bank:"ðŸ¦",Phone:"ðŸ“±",Wallet:"ðŸ‘›",Credit:"ðŸ’š","Credit Card":"ðŸ’³","Debit Card":"ðŸ’³","Mobile Money":"ðŸ“±",Check:"ðŸ§¾","Gift Card":"ðŸŽ"}[o]||"ðŸ’°"}const hc={class:"flex flex-col gap-4"},yc={class:"bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-100"},xc={class:"flex justify-between items-start mb-3"},bc={class:"text-start text-xs font-medium text-gray-600 mb-1"},wc={class:"text-start text-3xl font-bold text-gray-900"},kc={class:"text-end"},$c={key:0,class:"mb-2"},Cc={class:"text-start text-xs font-medium text-orange-600 mb-1"},Sc={class:"text-start text-xl font-bold text-orange-600"},Pc={key:1},Mc={class:"text-start text-xs font-medium text-green-600 mb-1"},Ic={class:"text-start text-xl font-bold text-green-600"},Ec={key:2,class:"flex items-center text-green-600"},Dc={class:"text-start text-xs font-semibold"},Vc={class:"w-full bg-white rounded-full h-2.5 overflow-hidden shadow-inner"},Ac={class:"text-start text-xs text-gray-600 mt-1"},jc={class:"flex items-center justify-between"},Bc={class:"flex items-center gap-2"},Tc={key:0,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"},zc={key:1,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"},Lc={class:"text-start text-xs font-semibold text-gray-800"},Rc={key:0,class:"text-start text-xs text-emerald-700"},Oc={key:1,class:"text-start text-xs text-red-700"},Nc={key:2,class:"text-start text-xs text-gray-600"},Uc={class:"text-end"},Fc={key:1,class:"bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg p-3"},qc={class:"flex items-center justify-between mb-2"},Hc={class:"flex items-center gap-2"},Wc={class:"text-xs font-bold text-purple-900"},Gc={key:0,class:"text-xs font-bold text-purple-600 bg-purple-100 px-2 py-0.5 rounded"},Qc={class:"relative mb-2"},Kc=["placeholder"],Jc={key:0,class:"mb-2 flex flex-col gap-1.5"},Yc={class:"text-[10px] font-semibold text-purple-700 uppercase tracking-wide mb-1"},Xc={class:"flex items-center gap-2 flex-1"},Zc=["onClick"],ed={class:"text-xs font-medium text-gray-900 flex-1"},td={key:0,class:"flex items-center gap-1"},od=["value","onInput"],sd={key:1,class:"text-xs font-semibold text-purple-700 bg-purple-200 px-2 py-1 rounded"},nd={key:0,class:"flex items-center gap-2 p-2 bg-yellow-50 border border-yellow-300 rounded mt-2"},ad={class:"text-xs font-medium text-yellow-800"},ld={key:1,class:"max-h-48 overflow-y-auto border border-purple-200 rounded-lg bg-white"},rd=["onClick"],id={class:"flex items-center gap-2"},ud={class:"text-xs font-medium text-gray-900"},cd={key:0,class:"text-[10px] text-gray-500"},dd={key:2,class:"text-center py-3"},md={class:"text-xs text-gray-500"},fd={key:3,class:"text-center py-3"},pd={class:"text-xs text-gray-500"},vd={key:4,class:"text-center py-3"},gd={class:"text-xs text-gray-500"},_d={key:2,class:"bg-gradient-to-r from-orange-50 to-red-50 border border-orange-300 rounded-lg p-2"},hd={class:"flex items-center justify-between mb-1.5"},yd={class:"flex items-center gap-1.5"},xd={class:"text-[11px] font-bold text-orange-900"},bd={key:0,class:"text-[10px] font-bold text-red-600 bg-red-100 px-1.5 py-0.5 rounded"},wd={class:"grid grid-cols-[100px_1fr] gap-1.5"},kd={value:"percentage"},$d={value:"amount"},Cd={class:"relative"},Sd={key:0,class:"absolute start-2 top-1/2 -translate-y-1/2 text-gray-600 text-[11px] font-medium"},Pd=["max"],Md={key:1,class:"absolute end-2 top-1/2 -translate-y-1/2 text-gray-600 text-[11px] font-medium"},Id={class:"text-start mb-3"},Ed={class:"text-sm font-semibold text-gray-700 mb-1"},Dd={class:"text-xs text-gray-500"},Vd={key:0,class:"flex items-center justify-center py-8"},Ad={class:"ms-3 text-sm text-gray-500"},jd={key:1,class:"grid grid-cols-2 md:grid-cols-3 gap-3 mt-3"},Bd=["onClick","disabled"],Td={class:"flex items-start justify-between"},zd={class:"flex-1"},Ld={class:"flex items-center mb-1"},Rd={class:"text-2xl me-2"},Od={class:"font-semibold text-sm text-gray-900"},Nd={class:"text-xs text-gray-500"},Ud={key:0,class:"mt-2 pt-2 border-t border-gray-200"},Fd={class:"text-xs text-gray-500"},qd={class:"font-bold text-blue-600"},Hd={key:2,class:"text-center py-8 text-gray-500"},Wd={class:"text-sm"},Gd={key:3,class:"bg-gray-50 rounded-lg p-4 border border-gray-200"},Qd={class:"text-start text-xs font-medium text-gray-600 mb-2"},Kd={class:"grid grid-cols-2 sm:grid-cols-4 gap-2"},Jd=["onClick"],Yd={class:"mt-4"},Xd={class:"text-start text-xs font-medium text-gray-600 mb-1"},Zd={class:"flex gap-2"},e0={key:4},t0={class:"text-start text-sm font-semibold text-gray-700 mb-3"},o0={class:"flex flex-col gap-2 max-h-64 overflow-y-auto"},s0={class:"flex items-center gap-3"},n0={class:"text-xl"},a0={class:"font-medium text-sm text-gray-900"},l0={class:"text-xs text-gray-500"},r0={class:"flex items-center gap-4"},i0=["onUpdate:modelValue","onInput"],u0=["onClick"],c0={class:"flex flex-col w-full gap-2 sm:hidden"},d0=["disabled"],m0=["disabled"],f0={class:"flex items-center gap-2 mt-1"},p0=["disabled"],v0={class:"hidden sm:flex items-center justify-between w-full gap-3"},g0={class:"flex items-center gap-2"},_0={class:"flex items-center gap-2"},h0=["disabled"],y0=["disabled"],kp={__name:"PaymentDialog",props:{modelValue:Boolean,grandTotal:{type:Number,default:0},subtotal:{type:Number,default:0},posProfile:String,currency:{type:String,default:"USD"},isOffline:{type:Boolean,default:!1},allowPartialPayment:{type:Boolean,default:!1},allowCreditSale:{type:Boolean,default:!1},customer:{type:[String,Object],default:null},company:{type:String,default:""},additionalDiscount:{type:Number,default:0}},emits:["update:modelValue","payment-completed","update-additional-discount"],setup(o,{emit:p}){const a=Ft(),{showWarning:l}=Ze(),f=o,x=p,w=X({get:()=>f.modelValue,set:h=>x("update:modelValue",h)}),r=C([]),u=C(!1),d=C(null),k=C(""),y=C([]),I=C([]),P=C({total_outstanding:0,total_credit:0,net_balance:0}),S=C(!1),E=C(0),_=C(a.usePercentageDiscount?"percentage":"amount"),j=De({url:"pos_next.api.pos_profile.get_payment_methods",makeParams(){return{pos_profile:f.posProfile}},auto:!1,onSuccess(h){if(r.value=(h==null?void 0:h.message)||h||[],r.value.length>0){const D=r.value.find(H=>H.default);d.value=D||r.value[0]}}}),$=De({url:"pos_next.api.credit_sales.get_available_credit",makeParams(){var D;const h=((D=f.customer)==null?void 0:D.name)||f.customer;return console.log("[PaymentDialog] Fetching credit for customer:",h),{customer:h,company:f.company,pos_profile:f.posProfile}},auto:!1,onSuccess(h){console.log("[PaymentDialog] Customer credit loaded:",h),I.value=h||[],S.value=!1,console.log("[PaymentDialog] Total available credit:",le.value)},onError(h){console.error("[PaymentDialog] Error loading customer credit:",h),I.value=[],S.value=!1}}),g=De({url:"pos_next.api.credit_sales.get_customer_balance",makeParams(){var D;const h=((D=f.customer)==null?void 0:D.name)||f.customer;return console.log("[PaymentDialog] Fetching balance for customer:",h),{customer:h,company:f.company}},auto:!1,onSuccess(h){console.log("[PaymentDialog] Customer balance loaded:",h),P.value=h||{total_outstanding:0,total_credit:0,net_balance:0},console.log("[PaymentDialog] Net balance:",P.value.net_balance)},onError(h){console.error("[PaymentDialog] Error loading customer balance:",h),P.value={total_outstanding:0,total_credit:0,net_balance:0}}}),i=C([]),c=C([]),m=C(""),M=C(!1),b=De({url:"pos_next.api.pos_profile.get_sales_persons",makeParams(){return{pos_profile:f.posProfile}},auto:!1,onSuccess(h){console.log("[PaymentDialog] Sales persons loaded:",h),i.value=(h==null?void 0:h.message)||h||[],M.value=!1},onError(h){console.error("[PaymentDialog] Error loading sales persons:",h),i.value=[],M.value=!1}}),O=X(()=>{if(!m.value)return[];const h=m.value.toLowerCase(),D=c.value.map(H=>H.sales_person);return i.value.filter(H=>D.includes(H.name)?!1:(H.sales_person_name||H.name||"").toLowerCase().includes(h)).slice(0,10)}),K=X(()=>c.value.reduce((h,D)=>h+(D.allocated_percentage||0),0));function L(h){if(a.isSingleSalesPerson)c.value=[{sales_person:h.name,sales_person_name:h.sales_person_name||h.name,allocated_percentage:100,commission_rate:h.commission_rate}];else{const D=c.value.length===0?100:0;c.value.push({sales_person:h.name,sales_person_name:h.sales_person_name||h.name,allocated_percentage:D,commission_rate:h.commission_rate})}m.value=""}function F(h){const D=c.value.findIndex(H=>H.sales_person===h);D>-1&&c.value.splice(D,1)}function oe(h,D){const H=c.value.find($e=>$e.sales_person===h);H&&(H.allocated_percentage=Number.parseFloat(D)||0)}function re(){c.value=[],m.value=""}function ye(){return U(this,null,function*(){if(!f.posProfile){console.warn("PaymentDialog: Cannot load payment methods - posProfile is not set");return}if(!u.value){u.value=!0;try{if(f.isOffline){const h=yield fe.getCachedPaymentMethods(f.posProfile);if(h&&h.length>0&&(r.value=h,r.value.length>0)){const D=r.value.find(H=>H.default);d.value=D||r.value[0]}}else yield j.fetch()}catch(h){console.error("Error loading payment methods:",h)}finally{u.value=!1}}})}const Pe=X(()=>Ht(f.currency)),ne=X(()=>y.value.reduce((h,D)=>h+(D.amount||0),0)),le=X(()=>-P.value.net_balance),Z=X(()=>{const h=f.grandTotal-ne.value;return h>0?h:0}),ue=X(()=>{const h=ne.value-f.grandTotal;return h>0?h:0}),Me=X(()=>f.allowPartialPayment?ne.value>0&&y.value.length>0:ne.value>=f.grandTotal&&y.value.length>0),z=X(()=>(console.log("[PaymentDialog] Button text calculation:",{totalPaid:ne.value,grandTotal:f.grandTotal,allowPartialPayment:f.allowPartialPayment,canComplete:Me.value}),ne.value>=f.grandTotal?__("Complete Payment"):f.allowPartialPayment&&ne.value>0?__("Partial Payment"):__("Complete Payment"))),J=X(()=>{const h=Z.value;if(h<=0)return[10,20,50,100];const D=new Set,H=Math.ceil(h);D.add(H);let $e;h<20?$e=[5,10,20,50]:h<100?$e=[10,20,50,100]:h<500?$e=[50,100,200,500]:h<2e3?$e=[100,200,500,1e3]:$e=[500,1e3,2e3,5e3];const ot=Math.max(5,H*.05),bt=qe=>{for(const Ge of D)if(Math.abs(qe-Ge)<ot)return!1;return!0};for(const qe of $e){if(D.size>=4)break;const Ge=Math.ceil(h/qe)*qe;if(Ge>H&&bt(Ge)&&D.add(Ge),D.size<4){const ft=Ge+qe;ft>H&&bt(ft)&&D.add(ft)}}return Array.from(D).filter(qe=>qe>0).sort((qe,Ge)=>qe-Ge).slice(0,4)});be(()=>f.posProfile,h=>{h&&(console.log("[PaymentDialog] Preloading payment methods for profile:",h),ye(),a.enableSalesPersons&&i.value.length===0&&(M.value=!0,b.fetch()))},{immediate:!0}),be(w,h=>{if(h){if(y.value=[],k.value="",d.value=null,I.value=[],P.value={total_outstanding:0,total_credit:0,net_balance:0},c.value=[],m.value="",console.log("[PaymentDialog] Dialog opened with props:",{allowCreditSale:f.allowCreditSale,customer:f.customer,company:f.company,posProfile:f.posProfile}),r.value.length>0&&!d.value){const D=r.value.find(H=>H.default);d.value=D||r.value[0]}f.allowCreditSale&&f.customer&&f.company?(console.log("[PaymentDialog] Loading customer credit and balance..."),S.value=!0,$.fetch(),g.fetch()):console.log("[PaymentDialog] Not loading credit because:",{allowCreditSale:f.allowCreditSale,hasCustomer:!!f.customer,hasCompany:!!f.company})}});function Y(h){console.log("[PaymentDialog] Quick add payment:",{method:h.mode_of_payment,remainingAmount:Z.value,currentEntries:y.value.length}),Z.value!==0&&(d.value=h,y.value.push({mode_of_payment:h.mode_of_payment,amount:Number.parseFloat(Z.value.toFixed(2)),type:h.type||__("Cash")}),console.log("[PaymentDialog] Payment added, new entries:",y.value),k.value="")}function R(h,D){console.log("[PaymentDialog] Add custom payment:",{method:h.mode_of_payment,amount:D,currentEntries:y.value.length});const H=Number.parseFloat(D);!H||H<=0||(y.value.push({mode_of_payment:h.mode_of_payment,amount:H,type:h.type||__("Cash")}),console.log("[PaymentDialog] Payment added, new entries:",y.value),k.value="")}function te(){if(console.log("[PaymentDialog] Apply customer credit:",{totalCredit:le.value,remainingAmount:Z.value,currentEntries:y.value.length}),Z.value===0||le.value===0)return;const h=Math.min(Z.value,le.value);y.value.push({mode_of_payment:"Customer Credit",amount:Number.parseFloat(h.toFixed(2)),type:"Credit",is_customer_credit:!0,credit_details:I.value.map(D=>Qe(Be({},D),{credit_to_redeem:0}))}),console.log("[PaymentDialog] Existing credit applied, new entries:",y.value)}function Ae(){console.log("[PaymentDialog] Add credit account payment (Pay Later):",{grandTotal:f.grandTotal,currentPaid:ne.value,remainingAmount:Z.value});const h={payments:[],change_amount:0,is_partial_payment:!1,is_credit_sale:!0,paid_amount:0,outstanding_amount:f.grandTotal};console.log("[PaymentDialog] Emitting credit sale payment-completed:",h),x("payment-completed",h),w.value=!1}function Ee(h){y.value.splice(h,1)}function ce(h,D){const H=Number.parseFloat(D);H&&H>0&&(y.value[h].amount=H)}function Ne(){y.value=[],k.value=""}function je(){if(console.log("[PaymentDialog] Complete payment called:",{canComplete:Me.value,totalPaid:ne.value,grandTotal:f.grandTotal,allowPartialPayment:f.allowPartialPayment,paymentEntries:y.value,salesPersons:c.value}),!Me.value){console.warn("[PaymentDialog] Cannot complete - validation failed");return}const h=ne.value<f.grandTotal,D={payments:y.value,change_amount:ue.value,is_partial_payment:h,paid_amount:ne.value,outstanding_amount:h?Z.value:0,sales_team:c.value.length>0?c.value:null};console.log("[PaymentDialog] Emitting payment-completed:",D),x("payment-completed",D),w.value=!1}function v(h){return tt(Number.parseFloat(h||0),f.currency)}function N(h){return y.value.filter(D=>D.mode_of_payment===h).reduce((D,H)=>D+(H.amount||0),0)}function V(){let h=E.value,D=0;if(_.value==="percentage")a.maxDiscountAllowed>0&&h>a.maxDiscountAllowed&&(E.value=a.maxDiscountAllowed,h=a.maxDiscountAllowed,l(__("Maximum allowed discount is {0}%",[a.maxDiscountAllowed]))),h>100&&(E.value=100,h=100),D=f.subtotal*h/100;else if(D=h,a.maxDiscountAllowed>0&&f.subtotal>0&&D/f.subtotal*100>a.maxDiscountAllowed){const $e=f.subtotal*a.maxDiscountAllowed/100;E.value=$e,D=$e,l(__("Maximum allowed discount is {0}% ({1} {2})",[a.maxDiscountAllowed,f.currency,$e.toFixed(2)]))}D>f.subtotal&&(_.value==="amount"&&(E.value=f.subtotal),D=f.subtotal),D<0&&(E.value=0,D=0),x("update-additional-discount",D)}function ge(){V()}function de(){E.value=0,x("update-additional-discount",0)}return be(()=>f.modelValue,h=>{h&&(E.value=f.additionalDiscount||0)}),(h,D)=>(s(),We(B(Ve),{modelValue:w.value,"onUpdate:modelValue":D[8]||(D[8]=H=>w.value=H),options:{title:h.__("Complete Payment"),size:"4xl"}},{"body-content":W(()=>[e("div",hc,[e("div",yc,[e("div",xc,[e("div",null,[e("div",bc,t(h.__("Total Amount")),1),e("div",wc,t(v(o.grandTotal)),1)]),e("div",kc,[Z.value>0?(s(),n("div",$c,[e("div",Cc,t(h.__("Remaining")),1),e("div",Sc,t(v(Z.value)),1)])):T("",!0),ue.value>0?(s(),n("div",Pc,[e("div",Mc,t(h.__("Change")),1),e("div",Ic,t(v(ue.value)),1)])):T("",!0),ne.value>=o.grandTotal&&ue.value===0?(s(),n("div",Ec,[D[9]||(D[9]=e("svg",{class:"w-5 h-5 me-1",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})],-1)),e("span",Dc,t(h.__("Paid in Full")),1)])):T("",!0)])]),e("div",Vc,[e("div",{class:xe(["h-full transition-all duration-300",ne.value>=o.grandTotal?"bg-green-500":"bg-blue-500"]),style:Nt({width:`${o.grandTotal>0?Math.min(ne.value/o.grandTotal*100,100):0}%`})},null,6)]),e("div",Ac,t(h.__("{0} paid of {1}",[v(ne.value),v(o.grandTotal)])),1)]),o.allowCreditSale?(s(),n("div",{key:0,class:xe(["rounded-lg p-3 border-2",le.value>0?"bg-gradient-to-br from-emerald-50 to-green-50 border-emerald-200":le.value<0?"bg-gradient-to-br from-red-50 to-rose-50 border-red-300":"bg-gradient-to-br from-gray-50 to-slate-50 border-gray-200"])},[e("div",jc,[e("div",Bc,[e("div",{class:xe(["w-8 h-8 rounded-full flex items-center justify-center",le.value>0?"bg-emerald-200":le.value<0?"bg-red-200":"bg-gray-200"])},[(s(),n("svg",{class:xe(["w-5 h-5",le.value>0?"text-emerald-700":le.value<0?"text-red-700":"text-gray-700"]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[le.value>=0?(s(),n("path",Tc)):(s(),n("path",zc))],2))],2),e("div",null,[e("div",Lc,t(le.value>=0?h.__("Customer Credit Available"):h.__("Customer Outstanding Balance")),1),le.value>0?(s(),n("div",Rc,t(h.__("Credit can be applied to invoice")),1)):le.value<0?(s(),n("div",Oc,t(h.__("Amount owed by customer")),1)):(s(),n("div",Nc,t(h.__("No outstanding balance")),1))])]),e("div",Uc,[e("div",{class:xe(["text-start text-xs font-medium",le.value>0?"text-emerald-700":le.value<0?"text-red-700":"text-gray-700"])},t(le.value>=0?h.__("Available"):h.__("Outstanding")),3),e("div",{class:xe(["text-start text-2xl font-bold",le.value>0?"text-emerald-700":le.value<0?"text-red-700":"text-gray-700"])},t(v(Math.abs(le.value))),3)])])],2)):T("",!0),B(a).enableSalesPersons?(s(),n("div",Fc,[e("div",qc,[e("div",Hc,[D[10]||(D[10]=e("div",{class:"w-6 h-6 rounded-full bg-purple-200 flex items-center justify-center"},[e("svg",{class:"w-4 h-4 text-purple-700",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})])],-1)),e("span",Wc,t(B(a).isMultipleSalesPersons?h.__("Sales Persons"):h.__("Sales Person")),1),c.value.length>0?(s(),n("span",Gc,t(B(a).isSingleSalesPerson?h.__("1 selected"):h.__("{0} selected",[c.value.length])),1)):T("",!0)]),c.value.length>0?(s(),n("button",{key:0,onClick:re,class:"text-xs text-purple-700 hover:text-purple-900 font-semibold px-2 py-1 bg-purple-100 hover:bg-purple-200 rounded transition-colors"},t(B(a).isSingleSalesPerson?h.__("Clear"):h.__("Clear All")),1)):T("",!0)]),e("div",Qc,[Ce(e("input",{"onUpdate:modelValue":D[0]||(D[0]=H=>m.value=H),type:"text",placeholder:h.__("Search sales person..."),class:"w-full px-3 py-2 ps-9 text-xs border border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white"},null,8,Kc),[[Re,m.value]]),D[11]||(D[11]=e("svg",{class:"w-4 h-4 text-gray-400 absolute start-3 top-1/2 -translate-y-1/2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1))]),c.value.length>0?(s(),n("div",Jc,[e("div",Yc,t(h.__("Selected:")),1),(s(!0),n(me,null,ve(c.value,H=>(s(),n("div",{key:H.sales_person,class:"flex items-center justify-between p-2 bg-purple-100 border border-purple-300 rounded-lg"},[e("div",Xc,[e("button",{onClick:$e=>F(H.sales_person),class:"text-purple-600 hover:text-purple-800 hover:bg-purple-200 rounded p-0.5 transition-colors"},D[12]||(D[12]=[e("svg",{class:"w-3.5 h-3.5",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z","clip-rule":"evenodd"})],-1)]),8,Zc),e("span",ed,t(H.sales_person_name||H.sales_person),1)]),B(a).isMultipleSalesPersons?(s(),n("div",td,[e("input",{type:"number",value:H.allocated_percentage,onInput:$e=>oe(H.sales_person,$e.target.value),placeholder:"%",min:"0",max:"100",step:"1",class:"w-14 px-1.5 py-1 text-xs font-semibold text-end border border-purple-300 rounded focus:outline-none focus:ring-1 focus:ring-purple-500 bg-white"},null,40,od),D[13]||(D[13]=e("span",{class:"text-xs text-gray-600 font-medium"},"%",-1))])):(s(),n("div",sd," 100% "))]))),128)),B(a).isMultipleSalesPersons&&K.value!==100?(s(),n("div",nd,[D[14]||(D[14]=e("svg",{class:"w-4 h-4 text-yellow-600 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1)),e("span",ad,t(h.__("Total: {0}% (should be 100%)",[K.value])),1)])):T("",!0)])):T("",!0),O.value.length>0&&m.value?(s(),n("div",ld,[(s(!0),n(me,null,ve(O.value,H=>(s(),n("div",{key:H.name,onClick:$e=>L(H),class:"flex items-center justify-between p-2 hover:bg-purple-50 cursor-pointer border-b border-purple-100 last:border-b-0 transition-colors"},[e("div",id,[D[15]||(D[15]=e("svg",{class:"w-4 h-4 text-purple-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1)),e("div",null,[e("div",ud,t(H.sales_person_name||H.name),1),H.commission_rate?(s(),n("div",cd,t(h.__("Commission: {0}%",[H.commission_rate])),1)):T("",!0)])])],8,rd))),128))])):!m.value&&c.value.length===0&&!M.value?(s(),n("div",dd,[D[16]||(D[16]=e("svg",{class:"w-8 h-8 text-gray-300 mx-auto mb-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1)),e("div",md,t(h.__("Search to add sales persons")),1)])):T("",!0),M.value?(s(),n("div",fd,[e("div",pd,t(h.__("Loading sales persons...")),1)])):T("",!0),m.value&&O.value.length===0&&!M.value?(s(),n("div",vd,[e("div",gd,t(h.__("No sales persons found")),1)])):T("",!0)])):T("",!0),B(a).allowAdditionalDiscount?(s(),n("div",_d,[e("div",hd,[e("div",yd,[D[17]||(D[17]=e("div",{class:"w-5 h-5 rounded-full bg-orange-200 flex items-center justify-center"},[e("svg",{class:"w-3 h-3 text-orange-700",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})])],-1)),e("span",xd,t(h.__("Additional Discount")),1),E.value>0?(s(),n("span",bd," -"+t(v(_.value==="percentage"?o.subtotal*E.value/100:E.value)),1)):T("",!0)]),E.value>0?(s(),n("button",{key:0,onClick:de,class:"text-[10px] text-orange-700 hover:text-orange-900 font-semibold px-1.5 py-0.5 bg-orange-100 hover:bg-orange-200 rounded transition-colors"},t(h.__("Clear")),1)):T("",!0)]),e("div",wd,[Ce(e("select",{"onUpdate:modelValue":D[1]||(D[1]=H=>_.value=H),onChange:ge,class:"w-full px-1.5 py-1.5 text-[11px] font-medium border border-orange-300 rounded focus:outline-none focus:ring-1 focus:ring-orange-500 focus:border-transparent bg-white"},[e("option",kd,t(h.__("% Percent")),1),e("option",$d,t(h.__("{0} Amount",[Pe.value])),1)],544),[[st,_.value]]),e("div",Cd,[_.value==="amount"?(s(),n("span",Sd,t(Pe.value),1)):T("",!0),Ce(e("input",{type:"number","onUpdate:modelValue":D[2]||(D[2]=H=>E.value=H),onInput:V,placeholder:"0.00",min:"0",max:_.value==="percentage"?100:o.subtotal,step:"0.01",class:xe(["w-full py-1.5 text-[11px] font-semibold border border-orange-300 rounded focus:outline-none focus:ring-1 focus:ring-orange-500 focus:border-transparent bg-white placeholder-gray-400",_.value==="amount"?"ps-9 pe-2":"px-2 pe-6"])},null,42,Pd),[[Re,E.value,void 0,{number:!0}]]),_.value==="percentage"?(s(),n("span",Md,"%")):T("",!0)])])])):T("",!0),e("div",Id,[e("h3",Ed,t(h.__("Payment Methods")),1),e("div",Dd,t(h.__("Select payment method to add")),1),u.value?(s(),n("div",Vd,[D[18]||(D[18]=e("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"},null,-1)),e("span",Ad,t(h.__("Loading payment methods...")),1)])):r.value.length>0?(s(),n("div",jd,[(s(!0),n(me,null,ve(r.value,H=>(s(),n("button",{key:H.mode_of_payment,onClick:$e=>Y(H),disabled:Z.value===0,class:xe(["group relative p-4 rounded-xl border-2 transition-all text-start","hover:shadow-lg transform hover:-translate-y-0.5",Z.value===0?"opacity-50 cursor-not-allowed":"cursor-pointer","border-gray-200 hover:border-blue-400 bg-white hover:bg-blue-50"])},[e("div",Td,[e("div",zd,[e("div",Ld,[e("span",Rd,t(B(It)(H.type)),1),e("div",null,[e("div",Od,t(H.mode_of_payment),1),e("div",Nd,t(H.type||h.__("Cash")),1)])])]),D[19]||(D[19]=e("div",{class:"opacity-0 group-hover:opacity-100 transition-opacity"},[e("svg",{class:"w-5 h-5 text-blue-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})])],-1))]),N(H.mode_of_payment)>0?(s(),n("div",Ud,[e("div",Fd,t(h.__("Added")),1),e("div",qd,t(v(N(H.mode_of_payment))),1)])):T("",!0)],10,Bd))),128))])):(s(),n("div",Hd,[D[20]||(D[20]=e("svg",{class:"mx-auto h-10 w-10 text-gray-400 mb-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"})],-1)),e("p",Wd,t(h.__("No payment methods available")),1)]))]),Z.value>0&&d.value?(s(),n("div",Gd,[e("div",Qd,t(h.__("Quick amounts for {0}",[d.value.mode_of_payment])),1),e("div",Kd,[(s(!0),n(me,null,ve(J.value,H=>(s(),n("button",{key:H,onClick:$e=>R(d.value,H),class:"px-4 py-3 text-sm font-semibold rounded-lg bg-white border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 text-gray-700 hover:text-blue-600 transition-all"},t(v(H)),9,Jd))),128))]),e("div",Yd,[e("div",Xd,t(h.__("Custom amount")),1),e("div",Zd,[se(B(dt),{modelValue:k.value,"onUpdate:modelValue":D[3]||(D[3]=H=>k.value=H),type:"number",step:"5",min:"0",placeholder:"0.00",class:"flex-1",onKeyup:D[4]||(D[4]=Et(H=>R(d.value,k.value),["enter"]))},null,8,["modelValue"]),se(B(pe),{variant:"solid",theme:"blue",onClick:D[5]||(D[5]=H=>R(d.value,k.value)),disabled:!k.value||k.value<=0},{default:W(()=>[we(t(h.__("Add")),1)]),_:1},8,["disabled"])])])])):T("",!0),y.value.length>0?(s(),n("div",e0,[e("h3",t0,t(h.__("Payment Breakdown")),1),e("div",o0,[(s(!0),n(me,null,ve(y.value,(H,$e)=>(s(),n("div",{key:$e,class:"group flex items-center justify-between p-3 bg-white rounded-lg border-2 border-gray-200 hover:border-red-300 transition-all"},[e("div",s0,[e("span",n0,t(B(It)(H.type)),1),e("div",null,[e("div",a0,t(H.mode_of_payment),1),e("div",l0,t(H.type),1)])]),e("div",r0,[Ce(e("input",{"onUpdate:modelValue":ot=>H.amount=ot,type:"number",step:"5",min:"0",class:"w-28 px-3 py-1 text-end font-bold text-gray-900 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",onInput:ot=>ce($e,ot.target.value)},null,40,i0),[[Re,H.amount,void 0,{number:!0}]]),e("button",{onClick:ot=>Ee($e),class:"opacity-0 group-hover:opacity-100 p-1 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg transition-all"},D[21]||(D[21]=[e("svg",{class:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})],-1)]),8,u0)])]))),128))])])):T("",!0)])]),actions:W(()=>[e("div",c0,[e("button",{onClick:je,disabled:!Me.value,class:xe(["w-full inline-flex items-center justify-center gap-2 transition-colors focus:outline-none","h-12 text-base font-semibold px-4 rounded-lg touch-manipulation",Me.value?"bg-blue-600 text-white hover:bg-blue-700 active:bg-blue-800 focus-visible:ring-2 focus-visible:ring-blue-400":"bg-blue-300 text-white cursor-not-allowed"])},[D[22]||(D[22]=e("svg",{class:"w-5 h-5",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})],-1)),e("span",null,t(z.value),1)],10,d0),o.allowCreditSale?(s(),n("button",{key:0,onClick:Ae,disabled:y.value.length>0,class:xe(["w-full inline-flex items-center justify-center gap-2 transition-colors focus:outline-none","h-12 text-base font-semibold px-4 rounded-lg touch-manipulation",y.value.length>0?"bg-orange-300 text-white cursor-not-allowed":"bg-orange-500 text-white hover:bg-orange-600 active:bg-orange-700 focus-visible:ring-2 focus-visible:ring-orange-400"])},[D[23]||(D[23]=e("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})],-1)),e("span",null,t(h.__("Pay on Account")),1)],10,m0)):T("",!0),o.allowCreditSale&&le.value>0&&Z.value>0?(s(),n("button",{key:1,onClick:te,class:"w-full inline-flex items-center justify-center gap-2 h-11 px-4 text-sm font-medium text-emerald-700 bg-emerald-50 hover:bg-emerald-100 active:bg-emerald-200 rounded-lg transition-colors touch-manipulation"},[D[24]||(D[24]=e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1)),e("span",null,t(h.__("Apply Credit")),1)])):T("",!0),e("div",f0,[e("button",{onClick:Ne,disabled:y.value.length===0,class:xe(["flex-1 inline-flex items-center justify-center gap-1.5 h-11 px-3 text-sm font-medium rounded-lg transition-colors touch-manipulation",y.value.length===0?"text-gray-400 bg-gray-50 cursor-not-allowed":"text-red-600 bg-red-50 hover:bg-red-100 active:bg-red-200"])},[D[25]||(D[25]=e("svg",{class:"w-4 h-4 rtl:scale-x-[-1]",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})],-1)),e("span",null,t(h.__("Clear")),1)],10,p0),e("button",{onClick:D[6]||(D[6]=H=>w.value=!1),class:"flex-1 inline-flex items-center justify-center gap-1.5 h-11 px-3 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 active:bg-gray-300 rounded-lg transition-colors touch-manipulation"},[e("span",null,t(h.__("Cancel")),1)])])]),e("div",v0,[e("div",g0,[y.value.length>0?(s(),n("button",{key:0,onClick:Ne,class:"inline-flex items-center justify-center gap-1.5 h-9 px-3 text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 active:bg-red-200 rounded-lg transition-colors"},[D[26]||(D[26]=e("svg",{class:"w-4 h-4 rtl:scale-x-[-1]",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})],-1)),e("span",null,t(h.__("Clear All")),1)])):T("",!0),o.allowCreditSale&&le.value>0&&Z.value>0?(s(),n("button",{key:1,onClick:te,class:"inline-flex items-center justify-center gap-1.5 h-9 px-3 text-sm font-medium text-emerald-700 bg-emerald-50 hover:bg-emerald-100 active:bg-emerald-200 rounded-lg transition-colors"},[D[27]||(D[27]=e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1)),e("span",null,t(h.__("Apply Credit")),1)])):T("",!0)]),e("div",_0,[e("button",{onClick:D[7]||(D[7]=H=>w.value=!1),class:"inline-flex items-center justify-center h-9 px-4 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 active:bg-gray-300 rounded-lg transition-colors"},t(h.__("Cancel")),1),o.allowCreditSale?(s(),n("button",{key:0,onClick:Ae,disabled:y.value.length>0,class:xe(["inline-flex items-center justify-center gap-2 transition-colors focus:outline-none","h-9 text-sm font-semibold px-4 rounded-lg",y.value.length>0?"bg-orange-300 text-white cursor-not-allowed":"bg-orange-500 text-white hover:bg-orange-600 active:bg-orange-700 focus-visible:ring-2 focus-visible:ring-orange-400"])},[D[28]||(D[28]=e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})],-1)),e("span",null,t(h.__("Pay on Account")),1)],10,h0)):T("",!0),e("button",{onClick:je,disabled:!Me.value,class:xe(["inline-flex items-center justify-center gap-2 transition-colors focus:outline-none","h-9 text-sm font-semibold px-5 rounded-lg",Me.value?"bg-blue-600 text-white hover:bg-blue-700 active:bg-blue-800 focus-visible:ring-2 focus-visible:ring-blue-400":"bg-blue-300 text-white cursor-not-allowed"])},[D[29]||(D[29]=e("svg",{class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20"},[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule":"evenodd"})],-1)),e("span",null,t(z.value),1)],10,y0)])])]),_:1},8,["modelValue","options"]))}},x0={class:"flex flex-col gap-4"},b0={class:"block text-sm text-start font-medium text-gray-700 mb-3"},w0={class:"mb-3 flex gap-2"},k0={key:0,class:"text-center py-8"},$0={class:"mt-2 text-xs text-gray-500"},C0={key:1,class:"max-h-96 overflow-y-auto flex flex-col gap-2 pe-2"},S0=["onClick"],P0={class:"flex items-start justify-between gap-3"},M0={class:"flex-1 min-w-0"},I0={class:"flex items-center gap-2 flex-wrap"},E0={class:"text-sm font-bold text-gray-900"},D0={class:"text-xs text-gray-600 mt-1 text-start"},V0={class:"text-xs text-gray-500 text-start"},A0={class:"text-end flex-shrink-0"},j0={class:"text-sm font-bold text-gray-900"},B0={key:0,class:"text-center py-8 text-gray-500 text-sm"},T0={class:"flex flex-col gap-4"},z0={key:0,class:"bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 sm:p-5 border border-blue-100 shadow-sm"},L0={class:"sm:hidden flex flex-col gap-3"},R0={class:"flex items-start gap-2"},O0={class:"flex-1 min-w-0"},N0={class:"text-base font-bold text-gray-900"},U0={class:"flex flex-col gap-2"},F0={class:"text-xs text-gray-500"},q0={class:"text-sm font-semibold text-gray-900"},H0={class:"flex items-center justify-between"},W0={class:"text-xs text-gray-500"},G0={class:"text-sm font-semibold text-gray-900"},Q0={class:"text-end"},K0={class:"text-xs text-gray-500 mb-1"},J0={class:"text-xl font-bold text-gray-900"},Y0={class:"hidden sm:flex items-start justify-between"},X0={class:"flex-1"},Z0={class:"flex items-center gap-2"},em={class:"text-base font-bold text-gray-900"},tm={class:"mt-3 grid grid-cols-2 gap-3"},om={class:"text-xs text-gray-500"},sm={class:"text-sm font-semibold text-gray-900"},nm={class:"text-xs text-gray-500"},am={class:"text-sm font-semibold text-gray-900"},lm={class:"text-end ms-4"},rm={class:"text-xs text-gray-500 mb-1"},im={class:"text-2xl font-bold text-gray-900"},um={key:1},cm={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 gap-2"},dm={class:"text-sm font-medium text-gray-700"},mm={class:"flex gap-2 self-start sm:self-auto"},fm={class:"text-xs whitespace-nowrap"},pm={class:"text-xs whitespace-nowrap"},vm={class:"flex flex-col gap-2 max-h-96 overflow-y-auto pe-2"},gm=["onClick"],_m={class:"hidden sm:flex items-center gap-4"},hm=["onUpdate:modelValue"],ym={class:"flex-1 min-w-0"},xm={class:"flex items-start justify-between"},bm={class:"flex-1"},wm={class:"text-sm font-bold text-gray-900 truncate"},km={class:"text-xs text-gray-500 mt-0.5"},$m={key:0,class:"text-xs text-amber-600 mt-1"},Cm={class:"text-xs font-medium text-gray-600"},Sm={class:"flex items-center gap-2"},Pm=["onClick","disabled"],Mm=["onUpdate:modelValue","max","disabled","onChange","onBlur"],Im=["onClick","disabled"],Em={class:"text-xs font-semibold text-gray-700"},Dm={class:"text-end min-w-[100px]"},Vm={class:"text-sm font-bold text-gray-900"},Am={class:"text-xs text-gray-500 mt-0.5"},jm={class:"sm:hidden flex flex-col gap-3"},Bm={class:"flex items-start gap-3"},Tm=["onUpdate:modelValue"],zm={class:"flex-1 min-w-0"},Lm={class:"text-sm font-semibold text-gray-900 leading-tight"},Rm={class:"text-xs text-gray-500 mt-1"},Om={key:0,class:"text-xs text-amber-600 mt-1"},Nm={class:"flex items-center justify-between"},Um={class:"text-xs font-medium text-gray-600"},Fm={class:"text-xs text-gray-500"},qm={class:"flex items-center gap-2"},Hm=["onClick","disabled"],Wm=["onUpdate:modelValue","max","disabled","onChange","onBlur"],Gm=["onClick","disabled"],Qm={class:"flex items-center justify-between px-1 pt-2 border-t border-gray-100"},Km={class:"text-xs text-gray-600"},Jm={class:"text-end"},Ym={class:"text-base font-bold text-gray-900"},Xm={class:"text-xs text-gray-500"},Zm={key:0,class:"text-center py-8 text-gray-500"},ef={key:2},tf={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 gap-2"},of={class:"text-sm font-medium text-gray-700"},sf={class:"text-xs"},nf={class:"flex flex-col gap-2"},af={class:"sm:hidden flex flex-col gap-3"},lf={class:"flex items-center gap-3"},rf={class:"flex-shrink-0 text-3xl"},uf=["onUpdate:modelValue"],cf={value:""},df=["value"],mf=["onClick"],ff={class:"flex items-center gap-3 ps-1"},pf={class:"text-sm font-medium text-gray-600 w-20 text-start"},vf=["onUpdate:modelValue","max"],gf={class:"hidden sm:flex items-center gap-3"},_f={class:"flex-shrink-0 text-2xl"},hf={class:"flex-1 min-w-0"},yf=["onUpdate:modelValue"],xf={value:""},bf=["value"],wf={class:"flex-1 min-w-0"},kf=["onUpdate:modelValue","max","placeholder"],$f=["onClick"],Cf={class:"mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200"},Sf={class:"flex items-center justify-between text-sm"},Pf={class:"text-gray-600"},Mf={class:"font-bold text-gray-900"},If={class:"flex items-center justify-between text-sm mt-1"},Ef={class:"text-gray-600"},Df={key:0,class:"mt-2 text-xs text-amber-600"},Vf={key:3,class:"bg-gradient-to-br from-red-50 to-orange-50 rounded-xl p-4 sm:p-5 border border-red-200 shadow-sm"},Af={class:"flex items-center gap-2 mb-3"},jf={class:"text-sm font-bold text-gray-900"},Bf={class:"flex flex-col gap-3"},Tf={class:"flex justify-between items-center"},zf={class:"text-sm text-gray-600"},Lf={class:"px-2 py-1 bg-white rounded-lg text-sm font-bold text-gray-900 border border-red-200"},Rf={class:"flex justify-between items-center pt-2 border-t border-red-200"},Of={class:"text-sm sm:text-base font-semibold text-gray-700"},Nf={class:"text-xl sm:text-2xl font-bold text-red-600"},Uf={key:4},Ff=["placeholder"],qf={class:"flex flex-col w-full gap-2"},Hf={key:0,class:"text-xs text-red-600"},Wf={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between w-full gap-2 sm:gap-3"},Gf={key:0,class:"text-xs text-gray-500 flex-shrink-0 order-2 sm:order-1"},Qf={class:"flex gap-2 w-full sm:w-auto sm:ms-auto flex-shrink-0 order-1 sm:order-2"},Kf={class:"text-sm"},Jf={class:"text-sm whitespace-nowrap"},Yf={class:"flex items-start gap-3 rounded-lg border border-red-200 bg-red-50 px-4 py-3"},Xf={class:"text-sm font-semibold text-red-700"},Zf={class:"mt-1 text-sm text-red-600 whitespace-pre-line"},ep={class:"flex justify-end w-full"},tp={__name:"ReturnInvoiceDialog",props:{modelValue:Boolean,posProfile:String,currency:{type:String,default:"USD"}},emits:["update:modelValue","return-created"],setup(o,{emit:p}){const{showSuccess:a,showError:l,showWarning:f}=Ze(),x=o,w=p,r=C(x.modelValue),u=C(null),d=C([]),k=C(""),y=C([]),I=C([]),P=C([]),S=C(""),E=C(""),_=C(!1),j=Lt({visible:!1,title:__("Validation Error"),message:""}),$=Lt({visible:!1}),g=De({url:"pos_next.api.invoices.get_returnable_invoices",makeParams(){return{limit:50}},auto:!1,onSuccess(v){v&&(P.value=v)},onError(v){console.error("Error loading invoices:",v),l(__("Failed to load recent invoices"))}}),i=De({url:"frappe.client.get",makeParams(){return{doctype:"POS Profile",name:x.posProfile,fields:JSON.stringify(["name","payments"])}},auto:!1,onSuccess(v){v&&v.payments&&(y.value=v.payments)},onError(v){console.error("Error loading payment methods:",v)}}),c=De({url:"pos_next.api.invoices.get_invoice_for_return",auto:!1,onSuccess(v){if(v){if(v.docstatus!==1){f(__("Invoice must be submitted to create a return"));return}if(v.is_return===1){f(__("Cannot create return against a return invoice"));return}const N=v.items.filter(V=>V.qty>0);if(N.length===0){f(__("All items from this invoice have already been returned")),u.value=null,d.value=[];return}u.value=v,d.value=N.map(V=>Qe(Be({},V),{quantity:V.qty,selected:!1,return_qty:V.qty,original_qty:V.original_qty||V.qty})),d.value.forEach(ye),y.value.length===0&&x.posProfile&&i.reload(),Z()}},onError(v){console.error("Error fetching invoice:",v),l(__("Failed to load invoice details"))}}),m=De({url:"pos_next.api.invoices.submit_invoice",makeParams(){const v={doctype:"Sales Invoice",pos_profile:x.posProfile,customer:u.value.customer,company:u.value.company,is_return:1,return_against:u.value.name,is_pos:1,update_stock:1,items:M.value.map(N=>({item_code:N.item_code,item_name:N.item_name,qty:-Math.abs(N.return_qty),rate:N.rate,warehouse:N.warehouse,uom:N.uom,conversion_factor:N.conversion_factor||1,sales_invoice_item:N.name})),payments:I.value.map(N=>({mode_of_payment:N.mode_of_payment,amount:-Math.abs(N.amount)})),remarks:k.value||__("Return against {0}",[u.value.name])};return{invoice:JSON.stringify(v),data:JSON.stringify({})}},auto:!1,transform(v){if(v&&v.exc)throw v;return v},onSuccess(v){E.value="",_.value=!1,w("return-created",v),g.reload(),Me(),a(__("Return invoice {0} created successfully",[v.name]))},onError(v){_.value=!1;const N=F(v);E.value=N,console.error("Error creating return - full error object:",v),oe(N)}});Dt(()=>{x.posProfile&&i.reload(),document.addEventListener("keydown",R)}),fo(()=>{document.removeEventListener("keydown",R)}),be(()=>x.modelValue,v=>{r.value=v,v?g.reload():ce()}),be(r,v=>{w("update:modelValue",v),v||ce()});const M=X(()=>!d.value||!Array.isArray(d.value)?[]:d.value.filter(v=>v.selected&&v.return_qty>0)),b=X(()=>!M.value||!Array.isArray(M.value)?0:M.value.reduce((v,N)=>v+N.return_qty*N.rate,0)),O=X(()=>!I.value||!Array.isArray(I.value)?0:I.value.reduce((v,N)=>v+(Number(N.amount)||0),0)),K=X(()=>{if(!M.value||!I.value)return!1;const v=M.value.length>0,N=I.value.length>0&&I.value.every(ge=>ge.mode_of_payment&&ge.amount>0),V=Math.abs(O.value-b.value)<.01;return v&&N&&V}),L=X(()=>{if(!P.value||!Array.isArray(P.value))return[];if(!S.value)return P.value;const v=S.value.toLowerCase();return P.value.filter(N=>N.name.toLowerCase().includes(v)||N.customer_name.toLowerCase().includes(v))});be(b,v=>{!$.visible||!r.value||I.value&&Array.isArray(I.value)&&I.value.length===1&&I.value[0]&&v>0&&(I.value[0].amount=v)});function F(v,N=__("Failed to create return invoice")){if(!v)return N;if(v.messages&&Array.isArray(v.messages)&&v.messages.length>0)return v.messages.join(", ");if(v._server_messages)try{const V=JSON.parse(v._server_messages);if(Array.isArray(V)&&V.length>0){const ge=JSON.parse(V[0]);if(ge!=null&&ge.message)return ge.message}}catch(V){console.error("Failed to parse server messages:",V)}if(typeof v.exc=="string"){const V=v.exc.match(/ValidationError: (.+?)\\n/);if(V)return V[1]}return v.httpStatusText&&v.httpStatusText!=="Expectation Failed"?v.httpStatusText:v.message&&v.message!=="ValidationError"?v.message:N}function oe(v,N=__("Validation Error")){j.title=N,j.message=v,j.visible=!0}function re(){j.visible=!1}function ye(v){const N=Number(v.quantity)||0,V=1;let ge=Number(v.return_qty);Number.isFinite(ge)||(ge=V),N>0&&ge>N&&(ge=N),ge<V&&(ge=V),v.return_qty=ge}function Pe(){const v=M.value.filter(ge=>ge.return_qty>ge.quantity);if(v.length===0)return!0;v.forEach(ye);const N=v.map(ge=>__("{0}: maximum {1}",[ge.item_name||ge.item_code,ge.quantity])).join(`
`),V=__(`Adjust return quantities before submitting.

{0}`,[N]);return E.value=V,oe(V),!1}function ne(){I.value.push({mode_of_payment:"",amount:0})}function le(v){I.value.splice(v,1)}function Z(){u.value&&u.value.payments&&u.value.payments.length>0?I.value=u.value.payments.map(v=>({mode_of_payment:v.mode_of_payment,amount:Math.abs(v.amount)})):I.value=[{mode_of_payment:y.value.length>0?y.value[0].mode_of_payment:"",amount:0}]}function ue(v){E.value="",c.fetch({invoice_name:v.name}),$.visible=!0}function Me(){$.visible=!1,u.value=null,d.value=[],k.value="",I.value=[],E.value=""}function z(){d.value.forEach(v=>{v.selected=!0,v.return_qty=v.quantity})}function J(){d.value.forEach(v=>{v.selected=!1})}function Y(v){v.selected=!v.selected,v.selected&&v.return_qty===0&&(v.return_qty=v.quantity)}function R(v){$.visible&&((v.ctrlKey||v.metaKey)&&v.key==="a"&&(v.preventDefault(),z()),(v.ctrlKey||v.metaKey)&&v.key==="Enter"&&(v.preventDefault(),K.value&&!_.value&&Ee()),v.key==="Escape"&&Me())}function te(v){v.return_qty<v.quantity&&v.return_qty++}function Ae(v){v.return_qty>1&&v.return_qty--}function Ee(){return U(this,null,function*(){if(!(!K.value||_.value)&&Pe()){E.value="",_.value=!0;try{const v=yield m.submit();if(v&&v.exc)throw v}catch(v){if(console.error("Caught error in handleCreateReturn:",v),!E.value){const N=F(v);E.value=N,oe(N)}}finally{_.value=!1}}})}function ce(){u.value=null,d.value=[],k.value="",I.value=[],P.value=[],S.value="",E.value="",_.value=!1,$.visible=!1,j.visible=!1,j.message=""}function Ne(v){return v?new Date(v).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):""}function je(v){return tt(Number.parseFloat(v||0),x.currency)}return(v,N)=>(s(),n(me,null,[se(B(Ve),{modelValue:r.value,"onUpdate:modelValue":N[3]||(N[3]=V=>r.value=V),options:{title:v.__("Create Return Invoice"),size:"5xl"}},{"body-content":W(()=>[e("div",x0,[e("div",null,[e("label",b0,t(v.__("Select Invoice to Return")),1),e("div",w0,[se(B(dt),{modelValue:S.value,"onUpdate:modelValue":N[0]||(N[0]=V=>S.value=V),type:"text",placeholder:v.__("Search by invoice number or customer name..."),class:"flex-1"},null,8,["modelValue","placeholder"]),se(B(pe),{variant:"subtle",onClick:N[1]||(N[1]=V=>B(g).reload()),loading:B(g).loading,title:v.__("Refresh")},{default:W(()=>N[11]||(N[11]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})],-1)])),_:1},8,["loading","title"])]),B(g).loading?(s(),n("div",k0,[N[12]||(N[12]=e("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"},null,-1)),e("p",$0,t(v.__("Loading invoices...")),1)])):(s(),n("div",C0,[(s(!0),n(me,null,ve(L.value,V=>(s(),n("div",{key:V.name,onClick:ge=>ue(V),class:"bg-white border border-gray-200 rounded-lg p-3 hover:border-blue-400 hover:bg-blue-50/30 cursor-pointer transition-all"},[e("div",P0,[e("div",M0,[e("div",I0,[e("h4",E0,t(V.name),1),e("span",{class:xe(["px-2 py-0.5 text-xs font-semibold rounded-full whitespace-nowrap",B(Mt)(V)])},t(v.__(V.status)),3)]),e("p",D0,t(V.customer_name),1),e("p",V0,t(Ne(V.posting_date)),1)]),e("div",A0,[e("p",j0,t(je(V.grand_total)),1)])])],8,S0))),128)),!B(g).loading&&L.value.length===0?(s(),n("p",B0,t(v.__("No invoices found")),1)):T("",!0)]))])])]),actions:W(()=>[se(B(pe),{variant:"subtle",onClick:N[2]||(N[2]=V=>r.value=!1)},{default:W(()=>[we(t(v.__("Close")),1)]),_:1})]),_:1},8,["modelValue","options"]),se(B(Ve),{modelValue:$.visible,"onUpdate:modelValue":N[9]||(N[9]=V=>$.visible=V),options:{title:v.__("Process Return"),size:"5xl"}},{"body-content":W(()=>[e("div",T0,[u.value?(s(),n("div",z0,[e("div",L0,[e("div",R0,[N[13]||(N[13]=e("svg",{class:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})],-1)),e("div",O0,[e("h3",N0,t(u.value.name),1),e("span",{class:xe(["inline-block mt-1 px-2 py-0.5 text-xs font-semibold rounded-full",B(Mt)(u.value)])},t(v.__(u.value.status)),3)])]),e("div",U0,[e("div",null,[e("p",F0,t(v.__("Customer")),1),e("p",q0,t(u.value.customer_name),1)]),e("div",H0,[e("div",null,[e("p",W0,t(v.__("Date")),1),e("p",G0,t(Ne(u.value.posting_date)),1)]),e("div",Q0,[e("p",K0,t(v.__("Total")),1),e("p",J0,t(je(u.value.grand_total)),1)])])])]),e("div",Y0,[e("div",X0,[e("div",Z0,[N[14]||(N[14]=e("svg",{class:"w-5 h-5 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})],-1)),e("h3",em,t(u.value.name),1),e("span",{class:xe(["px-2 py-0.5 text-xs font-semibold rounded-full",B(Mt)(u.value)])},t(v.__(u.value.status)),3)]),e("div",tm,[e("div",null,[e("p",om,t(v.__("Customer")),1),e("p",sm,t(u.value.customer_name),1)]),e("div",null,[e("p",nm,t(v.__("Date")),1),e("p",am,t(Ne(u.value.posting_date)),1)])])]),e("div",lm,[e("p",rm,t(v.__("Total Amount")),1),e("p",im,t(je(u.value.grand_total)),1)])])])):T("",!0),u.value?(s(),n("div",um,[e("div",cm,[e("label",dm,t(v.__("Select Items to Return")),1),e("div",mm,[se(B(pe),{size:"sm",variant:"subtle",onClick:z},{default:W(()=>[e("span",fm,t(v.__("Select All")),1)]),_:1}),se(B(pe),{size:"sm",variant:"subtle",onClick:J},{default:W(()=>[e("span",pm,t(v.__("Clear All")),1)]),_:1})])]),e("div",vm,[(s(!0),n(me,null,ve(d.value,(V,ge)=>(s(),n("div",{key:ge,onClick:de=>Y(V),class:xe(["bg-white border rounded-xl p-4 transition-all duration-200 cursor-pointer",V.selected?"border-blue-400 shadow-md bg-blue-50/30":"border-gray-200 hover:border-gray-300 hover:shadow-sm"])},[e("div",_m,[Ce(e("input",{type:"checkbox","onUpdate:modelValue":de=>V.selected=de,onClick:N[4]||(N[4]=ut(()=>{},["stop"])),class:"h-5 w-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 cursor-pointer"},null,8,hm),[[Rt,V.selected]]),e("div",ym,[e("div",xm,[e("div",bm,[e("h4",wm,t(V.item_name),1),e("p",km,t(V.item_code),1),V.already_returned>0?(s(),n("p",$m,t(v.__("âš ï¸ {0} already returned",[V.already_returned])),1)):T("",!0)])])]),e("div",{class:"flex items-center gap-3 bg-gray-50 rounded-lg px-3 py-2 border border-gray-200",onClick:N[5]||(N[5]=ut(()=>{},["stop"]))},[e("span",Cm,t(v.__("Return Qty:")),1),e("div",Sm,[e("button",{onClick:de=>Ae(V),disabled:!V.selected||V.return_qty<=1,class:"w-6 h-6 rounded-full bg-white border border-gray-300 flex items-center justify-center text-gray-600 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"},N[15]||(N[15]=[e("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M20 12H4"})],-1)]),8,Pm),Ce(e("input",{"onUpdate:modelValue":de=>V.return_qty=de,max:V.quantity,disabled:!V.selected,type:"number",min:"1",step:"1",onChange:de=>ye(V),onBlur:de=>ye(V),class:"w-14 px-2 py-1 border border-gray-300 rounded-lg text-sm text-center font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"},null,40,Mm),[[Re,V.return_qty,void 0,{number:!0}]]),e("button",{onClick:de=>te(V),disabled:!V.selected||V.return_qty>=V.quantity,class:"w-6 h-6 rounded-full bg-white border border-gray-300 flex items-center justify-center text-gray-600 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"},N[16]||(N[16]=[e("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1)]),8,Im)]),e("span",Em,t(v.__("of {0}",[V.quantity],"item qty")),1)]),e("div",Dm,[e("p",Vm,t(je(V.rate*V.return_qty)),1),e("p",Am,"@ "+t(je(V.rate))+"/"+t(V.uom),1)])]),e("div",jm,[e("div",Bm,[Ce(e("input",{type:"checkbox","onUpdate:modelValue":de=>V.selected=de,onClick:N[6]||(N[6]=ut(()=>{},["stop"])),class:"h-5 w-5 mt-1 text-blue-600 rounded-md focus:ring-2 focus:ring-blue-500 cursor-pointer flex-shrink-0"},null,8,Tm),[[Rt,V.selected]]),e("div",zm,[e("h4",Lm,t(V.item_name),1),e("p",Rm,t(V.item_code),1),V.already_returned>0?(s(),n("p",Om,t(v.__("âš ï¸ {0} already returned",[V.already_returned])),1)):T("",!0)])]),e("div",{class:"flex flex-col gap-2",onClick:N[7]||(N[7]=ut(()=>{},["stop"]))},[e("div",Nm,[e("span",Um,t(v.__("Return Qty:")),1),e("span",Fm,t(v.__("of {0}",[V.quantity],"item qty")),1)]),e("div",qm,[e("button",{onClick:de=>Ae(V),disabled:!V.selected||V.return_qty<=1,class:"flex-1 h-10 rounded-lg bg-white border-2 border-gray-300 flex items-center justify-center text-gray-700 active:bg-gray-100 disabled:opacity-30 disabled:cursor-not-allowed font-bold text-xl"}," âˆ’ ",8,Hm),Ce(e("input",{"onUpdate:modelValue":de=>V.return_qty=de,max:V.quantity,disabled:!V.selected,type:"number",min:"1",step:"1",onChange:de=>ye(V),onBlur:de=>ye(V),class:"w-16 h-10 px-2 border-2 border-gray-300 rounded-lg text-lg text-center font-bold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"},null,40,Wm),[[Re,V.return_qty,void 0,{number:!0}]]),e("button",{onClick:de=>te(V),disabled:!V.selected||V.return_qty>=V.quantity,class:"flex-1 h-10 rounded-lg bg-white border-2 border-gray-300 flex items-center justify-center text-gray-700 active:bg-gray-100 disabled:opacity-30 disabled:cursor-not-allowed font-bold text-xl"}," + ",8,Gm)])]),e("div",Qm,[e("span",Km,t(v.__("Amount:")),1),e("div",Jm,[e("p",Ym,t(je(V.rate*V.return_qty)),1),e("p",Xm,"@ "+t(je(V.rate))+"/"+t(V.uom),1)])])])],10,gm))),128))]),d.value.length===0?(s(),n("p",Zm,t(v.__("No items available for return")),1)):T("",!0)])):T("",!0),M.value.length>0?(s(),n("div",ef,[e("div",tf,[e("label",of,t(v.__("Refund Payment Methods")),1),se(B(pe),{size:"sm",variant:"subtle",onClick:ne,class:"self-start sm:self-auto"},{default:W(()=>[e("span",sf,t(v.__("+ Add Payment")),1)]),_:1})]),e("div",nf,[(s(!0),n(me,null,ve(I.value,(V,ge)=>(s(),n("div",{key:ge,class:"bg-white border border-gray-200 rounded-lg p-3"},[e("div",af,[e("div",lf,[e("div",rf,t(V.mode_of_payment?B(It)(V.mode_of_payment):"ðŸ’°"),1),Ce(e("select",{"onUpdate:modelValue":de=>V.mode_of_payment=de,class:"flex-1 px-3 py-3 border-2 border-gray-300 rounded-lg text-base font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"},[e("option",cf,t(v.__("Select method...",null,"payment")),1),(s(!0),n(me,null,ve(y.value,de=>(s(),n("option",{key:de.mode_of_payment,value:de.mode_of_payment},t(de.mode_of_payment),9,df))),128))],8,uf),[[st,V.mode_of_payment]]),I.value.length>1?(s(),n("button",{key:0,onClick:de=>le(ge),class:"p-2.5 text-red-600 active:bg-red-50 rounded-lg transition-colors flex-shrink-0"},N[17]||(N[17]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})],-1)]),8,mf)):T("",!0)]),e("div",ff,[e("label",pf,t(v.__("Amount:")),1),Ce(e("input",{"onUpdate:modelValue":de=>V.amount=de,type:"number",step:"1",min:"0",max:b.value,placeholder:"0.00",class:"flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg text-lg text-end font-bold focus:outline-none focus:ring-2 focus:ring-blue-500"},null,8,vf),[[Re,V.amount,void 0,{number:!0}]])])]),e("div",gf,[e("div",_f,t(V.mode_of_payment?B(It)(V.mode_of_payment):"ðŸ’°"),1),e("div",hf,[Ce(e("select",{"onUpdate:modelValue":de=>V.mode_of_payment=de,class:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"},[e("option",xf,t(v.__("Select payment method...")),1),(s(!0),n(me,null,ve(y.value,de=>(s(),n("option",{key:de.mode_of_payment,value:de.mode_of_payment},t(de.mode_of_payment),9,bf))),128))],8,yf),[[st,V.mode_of_payment]])]),e("div",wf,[Ce(e("input",{"onUpdate:modelValue":de=>V.amount=de,type:"number",step:"1",min:"0",max:b.value,placeholder:v.__("Amount"),class:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm text-end focus:outline-none focus:ring-2 focus:ring-blue-500"},null,8,kf),[[Re,V.amount,void 0,{number:!0}]])]),I.value.length>1?(s(),n("button",{key:0,onClick:de=>le(ge),class:"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors flex-shrink-0"},N[18]||(N[18]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})],-1)]),8,$f)):T("",!0)])]))),128))]),e("div",Cf,[e("div",Sf,[e("span",Pf,t(v.__("Total Refund:")),1),e("span",Mf,t(je(b.value)),1)]),e("div",If,[e("span",Ef,t(v.__("Payment Total:")),1),e("span",{class:xe(["font-bold",O.value===b.value?"text-green-600":"text-red-600"])},t(je(O.value)),3)]),O.value!==b.value?(s(),n("p",Df,t(v.__("âš ï¸ Payment total must equal refund amount")),1)):T("",!0)])])):T("",!0),M.value.length>0?(s(),n("div",Vf,[e("div",Af,[N[19]||(N[19]=e("svg",{class:"w-5 h-5 text-red-600 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2zM10 8.5a.5.5 0 11-1 0 .5.5 0 011 0zm5 5a.5.5 0 11-1 0 .5.5 0 011 0z"})],-1)),e("h3",jf,t(v.__("Return Summary")),1)]),e("div",Bf,[e("div",Tf,[e("span",zf,t(v.__("Items to Return:")),1),e("span",Lf,t(M.value.length),1)]),e("div",Rf,[e("span",Of,t(v.__("Refund Amount:")),1),e("span",Nf,t(je(b.value)),1)])])])):T("",!0),M.value.length>0?(s(),n("div",Uf,[se(vt,{tag:"label",class:"block text-sm font-medium text-gray-700 mb-2",inner:v.__('Return Reason <span class="text-gray-400">(optional)</span>')},null,8,["inner"]),Ce(e("textarea",{"onUpdate:modelValue":N[8]||(N[8]=V=>k.value=V),rows:"3",placeholder:v.__("Enter reason for return (e.g., defective product, wrong item, customer request)..."),class:"w-full px-4 py-3 border border-gray-300 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"},null,8,Ff),[[Re,k.value]])])):T("",!0)])]),actions:W(()=>[e("div",qf,[E.value?(s(),n("p",Hf,t(E.value),1)):T("",!0),e("div",Wf,[M.value.length>0?(s(),n("p",Gf,t(v.__("{0} item(s) selected",[M.value.length])),1)):T("",!0),e("div",Qf,[se(B(pe),{variant:"subtle",onClick:Me,class:"flex-1 sm:flex-initial"},{default:W(()=>[e("span",Kf,t(v.__("Cancel")),1)]),_:1}),se(B(pe),{variant:"solid",theme:"red",onClick:Ee,disabled:!K.value||_.value,loading:_.value,class:"flex-1 sm:flex-initial"},{default:W(()=>[e("span",Jf,t(v.__("Create Return")),1)]),_:1},8,["disabled","loading"])])])])]),_:1},8,["modelValue","options"]),se(B(Ve),{modelValue:j.visible,"onUpdate:modelValue":N[10]||(N[10]=V=>j.visible=V),options:{title:j.title,size:"sm"}},{"body-content":W(()=>[e("div",Yf,[N[20]||(N[20]=e("svg",{class:"h-5 w-5 flex-shrink-0 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L4.34 16c-.77 1.333.192 3 1.732 3z"})],-1)),e("div",null,[e("p",Xf,t(j.title),1),e("p",Zf,t(j.message),1)])])]),actions:W(()=>[e("div",ep,[se(B(pe),{variant:"solid",theme:"red",onClick:re},{default:W(()=>[we(t(v.__("OK")),1)]),_:1})])]),_:1},8,["modelValue","options"])],64))}},$p=xt(tp,[["__scopeId","data-v-23d66f75"]]),Te=et.create("PrintInvoice");function op(o,p=null,a=null){return U(this,null,function*(){try{if(!o||!o.name)throw new Error("Invalid invoice data");const l=o.doctype||"Sales Invoice",f=p||"POS Next Receipt",x=new URLSearchParams({doctype:l,name:o.name,format:f,no_letterhead:a?0:1,_lang:"en",_t:Date.now()});a&&x.append("letterhead",a);const w=`/printview?${x.toString()}`,r=document.createElement("iframe");r.style.position="fixed",r.style.right="0",r.style.bottom="0",r.style.width="0",r.style.height="0",r.style.border="none",r.style.opacity="0",r.style.pointerEvents="none",r.src=w,document.body.appendChild(r);let u=!1,d=!1,k=0;const y=20;let I=null,P=null;const S=()=>{I&&(clearInterval(I),I=null),P&&(clearTimeout(P),P=null),setTimeout(()=>{r.parentNode&&document.body.removeChild(r)},500)},E=()=>{if(!(u||d||!r.parentNode)){try{const _=r.contentWindow,j=r.contentDocument||_&&_.document;if(j){if((j.readyState==="complete"||j.readyState==="interactive"||k>=5)&&_)return _.addEventListener("afterprint",()=>{u=!0,d=!0,S()},{once:!0}),_.print(),d=!0,u=!0,S(),!0}else if(k>=10&&_)try{return _.addEventListener("afterprint",()=>{u=!0,d=!0,S()},{once:!0}),_.print(),d=!0,u=!0,S(),!0}catch($){}}catch(_){if(_.name==="SecurityError"||_.message.includes("Blocked")){if(k>=10&&r.contentWindow)try{return r.contentWindow.addEventListener("afterprint",()=>{u=!0,d=!0,S()},{once:!0}),r.contentWindow.print(),d=!0,u=!0,S(),!0}catch(j){}}else Te.error("Error checking iframe readiness:",_)}return k++,!1}};return r.onload=()=>{setTimeout(()=>{!u&&!d&&E()},500)},I=setInterval(()=>{if(u||d||!r.parentNode){clearInterval(I),I=null;return}if(k>=y){clearInterval(I),I=null;try{r.parentNode&&r.contentWindow&&(r.contentWindow.addEventListener("afterprint",()=>{u=!0,d=!0,S()},{once:!0}),r.contentWindow.print(),d=!0,u=!0,S())}catch(_){Te.error("Final print attempt failed:",_),S()}return}E()&&I&&(clearInterval(I),I=null)},300),P=setTimeout(()=>{if(I&&(clearInterval(I),I=null),!u&&!d&&r.parentNode)try{r.contentWindow&&(r.contentWindow.addEventListener("afterprint",()=>{u=!0,d=!0,S()},{once:!0}),r.contentWindow.print(),d=!0,u=!0,S())}catch(_){Te.error("Error in fallback print:",_),S()}else S()},6e3),!0}catch(l){return Te.error("Error printing with Frappe print format:",l),sp(o)}})}function sp(o){const p=window.open("","_blank","width=350,height=600"),a=`
		<!DOCTYPE html>
		<html>
		<head>
			<meta charset="UTF-8">
			<title>${__("Invoice - {0}",[o.name])}</title>
			<style>
				* {
					margin: 0;
					padding: 0;
					box-sizing: border-box;
				}

				body {
					font-family: 'Courier New', monospace;
					padding: 10px;
					width: 80mm;
					margin: 0;
					max-width: 80mm;
				}

				.receipt {
					width: 100%;
				}

				.header {
					text-align: center;
					margin-bottom: 20px;
					border-bottom: 2px dashed #000;
					padding-bottom: 10px;
				}

				.company-name {
					font-size: 18px;
					font-weight: bold;
					margin-bottom: 5px;
				}

				.invoice-info {
					margin-bottom: 15px;
					font-size: 12px;
				}

				.invoice-info div {
					display: flex;
					justify-content: space-between;
					margin-bottom: 3px;
				}

				.partial-status {
					color: #dc3545;
					font-weight: bold;
					margin-bottom: 5px;
				}

				.items-table {
					width: 100%;
					margin-bottom: 15px;
					border-top: 1px dashed #000;
					border-bottom: 1px dashed #000;
					padding: 10px 0;
				}

				.item-row {
					margin-bottom: 10px;
					font-size: 12px;
				}

				.item-name {
					font-weight: bold;
					margin-bottom: 3px;
				}

				.item-comment {
					font-size: 10px;
					color: #e65100;
					font-style: italic;
					margin-bottom: 3px;
					padding: 2px 5px;
					background-color: #fff3e0;
					border-radius: 2px;
					border-left: 2px solid #ff9800;
				}

				.item-details {
					display: flex;
					justify-content: space-between;
					font-size: 11px;
					color: #333;
				}

				.item-discount {
					display: flex;
					justify-content: space-between;
					font-size: 10px;
					color: #28a745;
					margin-top: 2px;
				}

				.item-serials {
					font-size: 9px;
					color: #666;
					margin-top: 3px;
					padding: 3px 5px;
					background-color: #f5f5f5;
					border-radius: 2px;
				}

				.item-serials-label {
					font-weight: bold;
					margin-bottom: 2px;
				}

				.item-serials-list {
					word-break: break-all;
				}

				.totals {
					margin-top: 15px;
					border-top: 1px dashed #000;
					padding-top: 10px;
				}

				.total-row {
					display: flex;
					justify-content: space-between;
					margin-bottom: 5px;
					font-size: 12px;
				}

				.grand-total {
					font-size: 16px;
					font-weight: bold;
					border-top: 2px solid #000;
					padding-top: 10px;
					margin-top: 10px;
				}

				.payments {
					margin-top: 15px;
					border-top: 1px dashed #000;
					padding-top: 10px;
				}

				.payment-row {
					display: flex;
					justify-content: space-between;
					margin-bottom: 3px;
					font-size: 11px;
				}

				.total-paid {
					font-weight: bold;
					border-top: 1px solid #ccc;
					padding-top: 5px;
					margin-top: 5px;
				}

				.outstanding-row {
					display: flex;
					justify-content: space-between;
					font-size: 13px;
					font-weight: bold;
					color: #dc3545;
					background-color: #fff3cd;
					padding: 8px;
					margin-top: 8px;
					border-radius: 4px;
				}

				.footer {
					text-align: center;
					margin-top: 20px;
					padding-top: 10px;
					border-top: 2px dashed #000;
					font-size: 11px;
				}

				@media print {
					@page {
						size: 80mm auto;
						margin: 0;
					}

					body {
						width: 80mm;
						padding: 5mm;
						margin: 0;
					}

					.no-print {
						display: none;
					}
				}
			</style>
		</head>
		<body>
			<div class="receipt">
				<!-- Header -->
				<div class="header">
					<div class="company-name">${o.company||"INTouch"}</div>
					<div style="font-size: 12px;">${__("TAX INVOICE")}</div>
				</div>

				<!-- Invoice Info -->
				<div class="invoice-info">
					<div>
						<span>${__("Invoice #:")}</span>
						<span><strong>${o.name}</strong></span>
					</div>
					<div>
						<span>${__("Date:")}</span>
						<span>${new Date(o.posting_date||Date.now()).toLocaleString()}</span>
					</div>
					${o.customer_name?`
					<div>
						<span>${__("Customer:")}</span>
						<span>${o.customer_name}</span>
					</div>
					`:""}
					${o.status==="Partly Paid"||o.outstanding_amount&&o.outstanding_amount>0&&o.outstanding_amount<o.grand_total?`
					<div class="partial-status">
						<span>${__("Status:")}</span>
						<span>${__("PARTIAL PAYMENT")}</span>
					</div>
					`:""}
				</div>

				<!-- Items -->
				<div class="items-table">
					${o.items.map(l=>{const f=l.discount_percentage&&Number.parseFloat(l.discount_percentage)>0||l.discount_amount&&Number.parseFloat(l.discount_amount)>0,x=l.is_free_item,w=l.quantity||l.qty,r=l.price_list_rate||l.rate,u=w*r,d=l.description&&l.description.includes("ðŸ“");let k=l.item_name||l.item_code,y="";if(d){const I=l.description.split(`
ðŸ“ `);I.length>1&&(y=I[1])}else l.comment&&(y=l.comment);return`
						<div class="item-row">
							<div class="item-name">
								${k} ${x?__("(FREE)"):""}
							</div>
							${y?`
							<div class="item-comment">
								${y}
							</div>
							`:""}
							<div class="item-details">
								<span>${w} Ã— ${He(r)}</span>
								<span><strong>${He(u)}</strong></span>
							</div>
							${f?`
							<div class="item-discount">
								<span>Discount ${l.discount_percentage?`(${Number(l.discount_percentage).toFixed(2)}%)`:""}</span>
								<span>-${He(l.discount_amount||0)}</span>
							</div>
							`:""}
							${l.serial_no?`
							<div class="item-serials">
								<div class="item-serials-label">${__("Serial No:")}</div>
								<div class="item-serials-list">${l.serial_no.replace(/\n/g,", ")}</div>
							</div>
							`:""}
						</div>
						`}).join("")}
				</div>

				<!-- Totals -->
				<div class="totals">
					${o.total_taxes_and_charges&&o.total_taxes_and_charges>0?`
					<div class="total-row">
						<span>${__("Subtotal:")}</span>
						<span>${He((o.grand_total||0)-(o.total_taxes_and_charges||0))}</span>
					</div>
					<div class="total-row">
						<span>${__("Tax:")}</span>
						<span>${He(o.total_taxes_and_charges)}</span>
					</div>
					`:""}
					${o.discount_amount?`
					<div class="total-row" style="color: #28a745;">
						<span>Additional Discount${o.additional_discount_percentage?` (${Number(o.additional_discount_percentage).toFixed(1)}%)`:""}:</span>
						<span>-${He(Math.abs(o.discount_amount))}</span>
					</div>
					`:""}
					<div class="total-row grand-total">
						<span>${__("TOTAL:")}</span>
						<span>${He(o.grand_total)}</span>
					</div>
				</div>

				<!-- Payments -->
				${o.payments&&o.payments.length>0?`
				<div class="payments">
					<div style="font-weight: bold; margin-bottom: 5px; font-size: 12px;">Payments:</div>
					${o.payments.map(l=>`
						<div class="payment-row">
							<span>${l.mode_of_payment}:</span>
							<span>${He(l.amount)}</span>
						</div>
					`).join("")}
					<div class="payment-row total-paid">
						<span>${__("Total Paid:")}</span>
						<span>${He(o.paid_amount||0)}</span>
					</div>
					${o.change_amount&&o.change_amount>0?`
					<div class="payment-row" style="font-weight: bold; margin-top: 5px;">
						<span>${__("Change:")}</span>
						<span>${He(o.change_amount)}</span>
					</div>
					`:""}
					${o.outstanding_amount&&o.outstanding_amount>0?`
					<div class="outstanding-row">
						<span>${__("BALANCE DUE:")}</span>
						<span>${He(o.outstanding_amount)}</span>
					</div>
					`:""}
				</div>
				`:""}

				<!-- Footer -->
				<div class="footer">
					<div style="margin-bottom: 5px;">${__("Thank you for your business!")}</div>
					<div style="font-size: 10px;">Powered by <a href="#" style="color: #3b82f6; text-decoration: none; font-weight: 600;">INTouch</a></div>
				</div>
			</div>

			<div class="no-print" style="text-align: center; margin-top: 20px;">
				<button onclick="window.print()" style="padding: 10px 20px; font-size: 14px; cursor: pointer;">
					${__("Print Receipt")}
				</button>
				<button onclick="window.close()" style="padding: 10px 20px; font-size: 14px; cursor: pointer; margin-left: 10px;">
					${__("Close")}
				</button>
			</div>
		</body>
		</html>
	`;p.document.write(a),p.document.close(),p.onload=()=>{setTimeout(()=>{p.print()},250)}}function He(o){return Number.parseFloat(o||0).toFixed(2)}function np(o){return U(this,null,function*(){return new Promise((p,a)=>{try{const l=document.createElement("iframe");l.style.position="fixed",l.style.right="0",l.style.bottom="0",l.style.width="0",l.style.height="0",l.style.border="none",l.style.opacity="0",l.style.pointerEvents="none",l.src=o,document.body.appendChild(l);let f=!1,x=0;const w=15,r=()=>{if(!(f||!l.parentNode)){try{const d=l.contentWindow,k=l.contentDocument||d&&d.document;if(k&&(k.readyState==="complete"||k.readyState==="interactive"||x>=5)){if(d)return d.print(),f=!0,setTimeout(()=>{l.parentNode&&document.body.removeChild(l),p(!0)},1e3),!0}else if(x>=10&&d)try{return d.print(),f=!0,setTimeout(()=>{l.parentNode&&document.body.removeChild(l),p(!0)},1e3),!0}catch(y){}}catch(d){if(d.name==="SecurityError"||d.message.includes("Blocked")){if(x>=10&&l.contentWindow)try{return l.contentWindow.print(),f=!0,setTimeout(()=>{l.parentNode&&document.body.removeChild(l),p(!0)},1e3),!0}catch(k){}}else return Te.error("Print error:",d),l.parentNode&&document.body.removeChild(l),a(d),!1}return x++,!1}};l.onload=()=>{setTimeout(()=>{f||r()},300)};const u=setInterval(()=>{if(f||!l.parentNode){clearInterval(u);return}if(x>=w){clearInterval(u);try{l.parentNode&&l.contentWindow&&(l.contentWindow.print(),f=!0,setTimeout(()=>{l.parentNode&&document.body.removeChild(l),p(!0)},1e3))}catch(d){l.parentNode&&document.body.removeChild(l),a(d)}return}r()&&clearInterval(u)},300);setTimeout(()=>{if(clearInterval(u),!f&&l.parentNode)try{l.contentWindow&&(l.contentWindow.print(),f=!0,setTimeout(()=>{l.parentNode&&document.body.removeChild(l),p(!0)},1e3))}catch(d){l.parentNode&&document.body.removeChild(l),a(d)}},5e3)}catch(l){Te.error("Silent print setup error:",l),a(l)}})})}function ap(o){return U(this,null,function*(){try{const p=yield Fe("pos_next.api.invoices.fast_print_invoice",{invoice_name:o});return p.success?(Te.info("Invoice printed successfully via network printer"),!0):(p.fallback||Te.warn("Network printing failed:",p.error),!1)}catch(p){return Te.warn("Fast network print not available:",p),!1}})}function Cp(o,p=null,a=null,l=!1){return U(this,null,function*(){try{const f="Sales Invoice",x=p||"POS Next Receipt",w=new URLSearchParams({doctype:f,name:o,format:x,no_letterhead:a?0:1,_lang:"en",_t:Date.now()});a&&w.append("letterhead",a);const r=`/printview?${w.toString()}`;if(l)return(yield ap(o))?!0:yield np(r);const u=document.createElement("iframe");u.style.position="fixed",u.style.right="0",u.style.bottom="0",u.style.width="0",u.style.height="0",u.style.border="none",u.style.opacity="0",u.style.pointerEvents="none",u.src=r,document.body.appendChild(u);let d=!1,k=!1,y=0;const I=15;let P=null,S=null;const E=()=>{P&&(clearInterval(P),P=null),S&&(clearTimeout(S),S=null),setTimeout(()=>{u.parentNode&&document.body.removeChild(u)},500)},_=()=>{if(!(d||k||!u.parentNode)){try{const j=u.contentWindow,$=u.contentDocument||j&&j.document;if($){if(($.readyState==="complete"||$.readyState==="interactive"||y>=5)&&j)return j.addEventListener("afterprint",()=>{d=!0,k=!0,E()},{once:!0}),j.print(),k=!0,d=!0,E(),!0}else if(y>=10)try{if(u.contentWindow)return u.contentWindow.addEventListener("afterprint",()=>{d=!0,k=!0,E()},{once:!0}),u.contentWindow.print(),k=!0,d=!0,E(),!0}catch(g){return Te.error("Error triggering print after retries:",g),E(),!1}}catch(j){if(!(j.name==="SecurityError"||j.message.includes("Blocked"))){if(y>=5)try{if(u.contentWindow)return u.contentWindow.addEventListener("afterprint",()=>{d=!0,k=!0,E()},{once:!0}),u.contentWindow.print(),k=!0,d=!0,E(),!0}catch($){return Te.error("Error triggering print after retries:",$),E(),!1}}}return y++,!1}};return u.onload=()=>{setTimeout(()=>{!d&&!k&&_()},500)},P=setInterval(()=>{if(d||k||!u.parentNode){clearInterval(P),P=null;return}if(y>=I){clearInterval(P),P=null;try{u.parentNode&&u.contentWindow&&(u.contentWindow.addEventListener("afterprint",()=>{d=!0,k=!0,E()},{once:!0}),u.contentWindow.print(),k=!0,d=!0,E())}catch(j){Te.error("Final print attempt failed:",j),E()}return}_()&&P&&(clearInterval(P),P=null)},300),S=setTimeout(()=>{if(P&&(clearInterval(P),P=null),!d&&!k&&u.parentNode)try{u.contentWindow&&(u.contentWindow.addEventListener("afterprint",()=>{d=!0,k=!0,E()},{once:!0}),u.contentWindow.print(),k=!0,d=!0,E())}catch(j){Te.error("Error in fallback print:",j),E()}else E()},5e3),!0}catch(f){Te.error("Error printing invoice:",f);try{const x=yield Fe("pos_next.api.invoices.get_invoice",{invoice_name:o});if(!x)throw new Error("Invoice not found");if(!p&&x.pos_profile)try{const w=yield Fe("frappe.client.get",{doctype:"POS Profile",name:x.pos_profile});w&&(p=w.print_format,a=a||w.letter_head)}catch(w){Te.warn("Could not fetch POS Profile print settings:",w)}return yield op(x,p,a)}catch(x){throw Te.error("Error fetching invoice for print:",x),x}}})}const Sp=nt("posDrafts",()=>{const{showSuccess:o,showError:p,showWarning:a}=Ze(),l=C(0);function f(){return U(this,null,function*(){try{l.value=yield va()}catch(r){console.error("Error getting drafts count:",r)}})}function x(y,I,P){return U(this,arguments,function*(r,u,d,k=[]){if(r.length===0)return a(__("Cannot save an empty cart as draft")),!1;try{return yield da({pos_profile:d,customer:u,items:r,applied_offers:k}),yield f(),o(__("Invoice saved as draft successfully")),!0}catch(S){return console.error("Error saving draft:",S),p(__("Failed to save draft")),!1}})}function w(r){return U(this,null,function*(){try{return yield Wt(r.draft_id),yield f(),o(__("Draft invoice loaded successfully")),{items:r.items||[],customer:r.customer,applied_offers:r.applied_offers||[]}}catch(u){throw console.error("Error loading draft:",u),p(__("Failed to load draft")),u}})}return{draftsCount:l,updateDraftsCount:f,saveDraftInvoice:x,loadDraft:w}}),Pp=nt("posShift",()=>{const{currentProfile:o,currentShift:p,hasOpenShift:a,checkOpeningShift:l}=po(),f=C(""),x=C(""),w=X(()=>{var _;return(_=o.value)==null?void 0:_.name}),r=X(()=>{var _;return((_=o.value)==null?void 0:_.currency)||"USD"}),u=X(()=>{var _;return(_=o.value)==null?void 0:_.warehouse}),d=X(()=>{var _;return(_=o.value)==null?void 0:_.company}),k=X(()=>{var _;return(_=o.value)==null?void 0:_.customer}),y=X(()=>{var _;return(_=o.value)==null?void 0:_.print_receipt_on_order_complete});function I(){var m;if(!a.value||!((m=p.value)!=null&&m.period_start_date)){x.value="";return}const _=new Date(p.value.period_start_date),$=new Date-_,g=Math.floor($/(1e3*60*60)),i=Math.floor($%(1e3*60*60)/(1e3*60)),c=Math.floor($%(1e3*60)/1e3);x.value=`${g} ${__("Hr")} ${i} ${__("Min")} ${c} ${__("Sec")}`}function P(){const _=new Date;f.value=_.toLocaleTimeString("en-US",{hour12:!1})}function S(){return P(),I(),setInterval(()=>{P(),I()},1e3)}function E(){return U(this,null,function*(){return yield l.fetch(),a.value})}return{currentProfile:o,currentShift:p,hasOpenShift:a,currentTime:f,shiftDuration:x,profileName:w,profileCurrency:r,profileWarehouse:u,profileCompany:d,profileCustomer:k,autoPrintEnabled:y,updateShiftDuration:I,updateCurrentTime:P,startTimers:S,checkShift:E,checkOpeningShift:l}}),ze=et.create("POSSync"),Mp=nt("posSync",()=>{const o=C(pt.isOffline),p=C(0),a=C(!1),l=C(pt.getConnectionQuality()),f=C([]);let x=pt.isOffline;const{showSuccess:w,showError:r,showWarning:u}=Ze();pt.subscribe(M=>U(void 0,null,function*(){const b=M.isOffline;if(o.value=b,l.value=M.quality||pt.getConnectionQuality(),x&&!b){ze.info("Transition to online detected, auto-syncing pending invoices");try{yield y()}catch(O){ze.error("Auto-sync failed on reconnection",O)}}x=b}));const d=X(()=>p.value>0);function k(){return U(this,null,function*(){try{p.value=yield fe.getOfflineInvoiceCount()}catch(M){ze.error("Failed to get pending invoice count",M)}})}function y(){return U(this,null,function*(){if(o.value)throw new Error("Cannot sync while offline");a.value=!0;try{const M=yield ho();return yield k(),M}catch(M){throw ze.error("Failed to sync invoices",M),M}finally{a.value=!1}})}function I(){return U(this,null,function*(){return yield fe.getOfflineInvoices()})}function P(M){return U(this,null,function*(){yield fe.deleteOfflineInvoice(M),yield k()})}function S(M,b){return U(this,null,function*(){try{return(M==null?void 0:M.length)>0&&(yield fe.cacheItems(M)),(b==null?void 0:b.length)>0&&(yield fe.cacheCustomers(b)),!0}catch(O){return ze.error("Failed to cache data",O),!1}})}function E(M){return U(this,null,function*(){try{return yield fe.saveOfflineInvoice(M),yield k(),ze.info("Invoice saved offline successfully"),!0}catch(b){throw ze.error("Failed to save invoice offline",b),b}})}function _(){return U(this,null,function*(){try{f.value=yield I()}catch(M){ze.error("Failed to load pending invoices",M),f.value=[]}})}function j(M){return U(this,null,function*(){try{yield P(M),yield _(),w(__("Offline invoice deleted successfully"))}catch(b){throw ze.error("Failed to delete offline invoice",b),r(b.message||__("Failed to delete offline invoice")),b}})}function $(){return U(this,null,function*(){if(o.value)return u(__("Cannot sync while offline")),{success:0,failed:0,errors:[]};try{const M=yield y();return M.success>0&&(w(__("{0} invoice(s) synced successfully",[M.success])),yield _()),M}catch(M){throw ze.error("Sync all pending failed",M),M}})}function g(M){return U(this,null,function*(){var b;if(!(!M||o.value))try{const O=yield c(),K=yield m(),L=!K.lastSync||Date.now()-K.lastSync>24*60*60*1e3;ze.info("Loading payment methods for offline use");try{const F=yield yo(M.name);if(((b=F.payment_methods)==null?void 0:b.length)>0){const oe=F.payment_methods.map(re=>Qe(Be({},re),{pos_profile:M.name}));yield fe.cachePaymentMethods(oe),ze.success(`Cached ${oe.length} payment methods`)}}catch(F){ze.error("Failed to load payment methods",F)}if(!O||L){w(__("Loading customers for offline use..."));const F=yield xo(M.name);yield S([],F.customers||[]),w(__("Data is ready for offline use"))}}catch(O){ze.error("Failed to preload offline data",O),u(__("Some data may not be available offline"))}})}function i(){return U(this,null,function*(){const M=yield c();return!M&&o.value&&u(__("POS is offline without cached data. Please connect to sync.")),M})}function c(){return U(this,null,function*(){return yield fe.isCacheReady()})}function m(){return U(this,null,function*(){return yield fe.getCacheStats()})}return k(),{isOffline:o,pendingInvoicesCount:p,isSyncing:a,pendingInvoicesList:f,hasPendingInvoices:d,saveInvoiceOffline:E,loadPendingInvoices:_,deleteOfflineInvoice:j,syncAllPending:$,preloadDataForOffline:g,checkOfflineCacheAvailability:i,checkCacheReady:c,getCacheStats:m}});export{pp as C,_p as E,hp as P,$p as R,kp as _,Ys as a,Ha as b,Pp as c,Mp as d,Sp as e,tt as f,Mt as g,Wa as h,dp as i,vp as j,fp as k,bp as l,mp as m,xp as n,yp as o,it as p,wp as q,Dn as r,op as s,Cp as t,gp as u};
