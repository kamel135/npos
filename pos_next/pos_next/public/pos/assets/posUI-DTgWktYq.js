var Ct=Object.defineProperty,kt=Object.defineProperties;var Ot=Object.getOwnPropertyDescriptors;var ut=Object.getOwnPropertySymbols;var It=Object.prototype.hasOwnProperty,At=Object.prototype.propertyIsEnumerable;var dt=(e,t,n)=>t in e?Ct(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Ge=(e,t)=>{for(var n in t||(t={}))It.call(t,n)&&dt(e,n,t[n]);if(ut)for(var n of ut(t))At.call(t,n)&&dt(e,n,t[n]);return e},Ke=(e,t)=>kt(e,Ot(t));var G=(e,t,n)=>new Promise((u,D)=>{var y=I=>{try{q(n.next(I))}catch(L){D(L)}},N=I=>{try{q(n.throw(I))}catch(L){D(L)}},q=I=>I.done?u(I.value):Promise.resolve(I.value).then(y,N);q((n=n.apply(e,t)).next())});import{W as at,i as w,l as m,P as Se,j as $t,a9 as Et,m as je,o as T,aa as qt,ab as Pt,a5 as ft,E as Tt,z as nt,a4 as Nt,w as ye,f as a,d as Ce,u as k,G as Pe,e as Te,t as d,c as M,g as ae,q as He,F as Je,B as Ze,$ as rt,K as gt,x as Dt,y as lt,v as it,ac as be,ad as We,ae as Qe,a1 as Bt,af as Me,O as Ft,L as Lt,M as Vt,a3 as ot}from"./index-CLcWQdf2.js";import{useBootstrapStore as Rt}from"./bootstrap-BaxiQ869.js";function Mt(e){return e==null?"0.00":Number.parseFloat(e).toFixed(2)}function jt(e){return e==null?"0":Number.parseFloat(e).toFixed(4).replace(/\.?0+$/,"")}function zt(e){return e?new Date(e).toLocaleString():""}function Ut(e){if(!e)return"";if(typeof e=="string"&&e.includes(":")){const t=e.split(":");return t.length>=2?`${t[0]}:${t[1]}`:e}return new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function Gt(e){return e?new Date(e).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"2-digit"}):""}function Wt(e,t=2){return e==null?"0%":`${Number.parseFloat(e).toFixed(t).replace(/\.?0+$/,"")}%`}function ht(){return{formatCurrency:Mt,formatQuantity:jt,formatDateTime:zt,formatTime:Ut,formatDate:Gt,formatPercentage:Wt}}const yt=at("posSettings",()=>{const e=w({pos_profile:"",enabled:0,max_discount_allowed:0,use_percentage_discount:0,allow_user_to_edit_additional_discount:0,allow_user_to_edit_item_discount:1,disable_rounded_total:1,allow_credit_sale:0,allow_return:0,allow_write_off_change:0,allow_partial_payment:0,default_card_view:0,display_item_code:0,show_customer_balance:0,hide_expected_amount:0,display_discount_percentage:0,display_discount_amount:0,allow_sales_order:0,allow_select_sales_order:0,create_only_sales_order:0,allow_return_without_invoice:0,allow_free_batch_return:0,allow_print_draft_invoices:0,decimal_precision:"2",allow_customer_purchase_order:0,allow_duplicate_customer_names:0,fetch_coupon:0,allow_print_last_invoice:0,silent_print:0,use_delivery_charges:0,auto_set_delivery_charges:0,use_limit_search:0,search_limit:1e3,allow_submissions_in_background_job:0,allow_delete_offline_invoice:0,allow_change_posting_date:0,input_qty:0,allow_negative_stock:0,enable_sales_persons:"Disabled"}),t=w(!1),n=w(!1),u=m(()=>!!e.value.enabled),D=m(()=>Number.parseFloat(e.value.max_discount_allowed)||0),y=m(()=>!!e.value.use_percentage_discount),N=m(()=>!!e.value.allow_user_to_edit_additional_discount),q=m(()=>!!e.value.allow_user_to_edit_item_discount),I=m(()=>!!e.value.disable_rounded_total),L=m(()=>!!e.value.allow_credit_sale),W=m(()=>!!e.value.allow_return),F=m(()=>!!e.value.allow_write_off_change),c=m(()=>!!e.value.allow_partial_payment),o=m(()=>!!e.value.default_card_view),S=m(()=>!!e.value.display_item_code),h=m(()=>!!e.value.show_customer_balance),$=m(()=>!!e.value.hide_expected_amount),j=m(()=>!!e.value.display_discount_percentage),se=m(()=>!!e.value.display_discount_amount),K=m(()=>!!e.value.allow_sales_order),le=m(()=>!!e.value.allow_select_sales_order),ee=m(()=>!!e.value.create_only_sales_order),_e=m(()=>!!e.value.allow_return_without_invoice),Y=m(()=>!!e.value.allow_free_batch_return),oe=m(()=>!!e.value.allow_print_draft_invoices),pe=m(()=>Number.parseInt(e.value.decimal_precision)||2),re=m(()=>!!e.value.allow_customer_purchase_order),ve=m(()=>!!e.value.allow_duplicate_customer_names),b=m(()=>!!e.value.fetch_coupon),B=m(()=>!!e.value.allow_print_last_invoice),O=m(()=>!!e.value.silent_print),ne=m(()=>!!e.value.use_delivery_charges),X=m(()=>!!e.value.auto_set_delivery_charges),i=m(()=>!!e.value.use_limit_search),C=m(()=>Number.parseInt(e.value.search_limit)||1e3),P=m(()=>!!e.value.allow_submissions_in_background_job),V=m(()=>!!e.value.allow_delete_offline_invoice),te=m(()=>!!e.value.allow_change_posting_date),Ne=m(()=>!!e.value.input_qty),$e=m(()=>!!e.value.allow_negative_stock),ke=m(()=>e.value.enable_sales_persons!=="Disabled"),Le=m(()=>e.value.enable_sales_persons||"Disabled"),xe=m(()=>e.value.enable_sales_persons==="Single"),fe=m(()=>e.value.enable_sales_persons==="Multiple"),De=Se({url:"pos_next.pos_next.doctype.pos_settings.pos_settings.get_pos_settings",onSuccess(J){console.log("[POSSettings Store] Loaded settings:",J),J&&(Object.assign(e.value,J),console.log("[POSSettings Store] Updated settings.value:",e.value),console.log("[POSSettings Store] allowPartialPayment computed:",!!e.value.allow_partial_payment),n.value=!0),t.value=!1},onError(J){console.error("Failed to load POS Settings:",J),t.value=!1}});function Q(J){return G(this,null,function*(){if(!J)return console.warn("Cannot load POS Settings: POS Profile not provided"),!1;t.value=!0,e.value.pos_profile=J;try{const Be=Rt().getPreloadedPOSSettings();if(Be&&Object.keys(Be).length>0)return console.log("[POSSettings Store] Using preloaded settings from bootstrap:",Be),Object.assign(e.value,Be),n.value=!0,t.value=!1,!0}catch(Ie){console.log("[POSSettings Store] Bootstrap not available, fetching from API")}try{return yield De.submit({pos_profile:J}),!0}catch(Ie){return console.error("Error loading POS Settings:",Ie),!1}})}function me(){e.value={pos_profile:"",enabled:0,max_discount_allowed:0,use_percentage_discount:0,allow_user_to_edit_additional_discount:0,allow_user_to_edit_item_discount:1,disable_rounded_total:1,allow_credit_sale:0,allow_return:0,allow_write_off_change:0,allow_partial_payment:0,default_card_view:0,display_item_code:0,show_customer_balance:0,hide_expected_amount:0,display_discount_percentage:0,display_discount_amount:0,allow_sales_order:0,allow_select_sales_order:0,create_only_sales_order:0,allow_return_without_invoice:0,allow_free_batch_return:0,allow_print_draft_invoices:0,decimal_precision:"2",allow_customer_purchase_order:0,allow_duplicate_customer_names:0,fetch_coupon:0,allow_print_last_invoice:0,silent_print:0,use_delivery_charges:0,auto_set_delivery_charges:0,use_limit_search:0,search_limit:1e3,allow_submissions_in_background_job:0,allow_delete_offline_invoice:0,allow_change_posting_date:0,input_qty:0,allow_negative_stock:0,enable_sales_persons:"Disabled"},n.value=!1}function we(J){return!u.value||D.value===0?!0:J<=D.value}function Ee(){return u.value&&!!e.value.allow_negative_stock}function ge(){return u.value&&!e.value.allow_negative_stock}function Oe(){return G(this,null,function*(){if(!e.value.pos_profile)return console.warn("Cannot reload POS Settings: POS Profile not set"),!1;t.value=!0;try{return yield De.reload(),!0}catch(J){return console.error("Error reloading POS Settings:",J),!1}})}return{settings:e,isLoading:t,isLoaded:n,isEnabled:u,maxDiscountAllowed:D,usePercentageDiscount:y,allowAdditionalDiscount:N,allowItemDiscount:q,disableRoundedTotal:I,allowCreditSale:L,allowReturn:W,allowWriteOffChange:F,allowPartialPayment:c,defaultCardView:o,displayItemCode:S,showCustomerBalance:h,hideExpectedAmount:$,displayDiscountPercentage:j,displayDiscountAmount:se,allowSalesOrder:K,allowSelectSalesOrder:le,createOnlySalesOrder:ee,allowReturnWithoutInvoice:_e,allowFreeBatchReturn:Y,allowPrintDraftInvoices:oe,decimalPrecision:pe,allowCustomerPurchaseOrder:re,allowDuplicateCustomerNames:ve,fetchCoupon:b,allowPrintLastInvoice:B,silentPrint:O,useDeliveryCharges:ne,autoSetDeliveryCharges:X,useLimitSearch:i,searchLimit:C,allowSubmissionsInBackgroundJob:P,allowDeleteOfflineInvoice:V,allowChangePostingDate:te,inputQty:Ne,allowNegativeStock:$e,enableSalesPersons:ke,salesPersonsMode:Le,isSingleSalesPerson:xe,isMultipleSalesPersons:fe,loadSettings:Q,reloadSettings:Oe,resetSettings:me,validateDiscount:we,isNegativeStockAllowed:Ee,shouldEnforceStockValidation:ge}}),_t={__name:"TranslatedHTML",props:{tag:{type:String,required:!1,default:"span"},inner:{type:String,required:!0}},setup(e){const t=e,n=w(null);return $t(()=>{const u=Et.sanitize(t.inner);n.value.innerHTML=u}),(u,D)=>(T(),je(Pt(e.tag),qt(u.$attrs,{ref_key:"containerRef",ref:n}),null,16))}},Ht={class:"flex flex-col gap-3 md:gap-6"},Qt={key:0,class:"text-center py-8 md:py-12"},Jt={class:"mt-3 md:mt-4 text-base md:text-lg font-medium text-gray-600"},Kt={class:"text-xs md:text-sm text-gray-500"},Yt={key:1,class:"flex flex-col gap-3 md:gap-6"},Xt={key:0,class:"bg-white border border-gray-200 rounded-lg p-3 md:p-6 shadow-sm"},Zt={class:"flex flex-col sm:flex-row justify-start items-start gap-3 mb-3 md:mb-6"},ea={class:"flex-1"},ta={class:"text-start text-sm md:text-base font-medium text-gray-900"},aa={class:"text-start text-xs md:text-sm text-gray-500 mt-1"},sa={class:"text-start sm:text-end"},oa={class:"text-start text-xs text-gray-500 uppercase"},na={class:"text-base md:text-lg font-semibold text-gray-900"},la={class:"grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4"},ra={class:"text-start bg-blue-50 border border-blue-200 rounded-lg p-3 md:p-4"},ia={class:"text-blue-600 text-xs uppercase font-medium mb-1"},ca={class:"text-lg md:text-2xl font-bold text-blue-900 mb-0.5 md:mb-1 truncate"},ua={class:"text-blue-600 text-xs"},da={class:"text-start bg-gray-50 border border-gray-200 rounded-lg p-3 md:p-4"},_a={class:"text-gray-600 text-xs uppercase font-medium mb-1"},ma={class:"text-lg md:text-2xl font-bold text-gray-900 mb-0.5 md:mb-1 truncate"},pa={class:"text-gray-600 text-xs"},va={class:"text-start bg-gray-50 border border-gray-200 rounded-lg p-3 md:p-4"},fa={class:"text-gray-600 text-xs uppercase font-medium mb-1"},ga={class:"text-lg md:text-2xl font-bold text-gray-900 mb-0.5 md:mb-1"},ha={class:"text-gray-600 text-xs"},ya={class:"text-start bg-gray-50 border border-gray-200 rounded-lg p-3 md:p-4"},ba={class:"text-gray-600 text-xs uppercase font-medium mb-1"},xa={class:"text-lg md:text-2xl font-bold text-gray-900 mb-0.5 md:mb-1 truncate"},wa={class:"text-gray-600 text-xs"},Sa={key:1,class:"bg-yellow-50 border border-yellow-200 rounded-lg p-3 md:p-4"},Ca={class:"flex items-start gap-2 md:gap-3"},ka={class:"text-xs md:text-sm font-medium text-yellow-900"},Oa={class:"text-xs md:text-sm text-yellow-700 mt-1 md:mt-2"},Ia={class:"bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm"},Aa={class:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2"},$a={class:"text-start flex items-center gap-2"},Ea={class:"text-sm md:text-lg font-semibold text-gray-900"},qa={key:0,class:"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"},Pa={class:"text-xs md:text-sm text-gray-600"},Ta={key:0,class:"text-start sm:text-end"},Na={class:"text-xs mb-1 text-gray-500 uppercase"},Da={class:"p-3 md:p-6"},Ba={key:0,class:"flex flex-col gap-3 md:gap-4"},Fa={class:"flex items-center justify-between gap-4 md:gap-6"},La={class:"flex items-center gap-2 md:gap-3"},Va={class:"text-base md:text-xl"},Ra={class:"text-start text-sm md:text-base font-semibold text-gray-900"},Ma={class:"flex items-center gap-2 md:gap-3"},ja=["for"],za={class:"w-32 md:w-40"},Ua={key:1,class:"flex flex-col gap-3 md:gap-4"},Ga={class:"flex items-center justify-between gap-4 md:gap-6"},Wa={class:"flex items-center gap-2 md:gap-3"},Ha={class:"text-base md:text-xl"},Qa={class:"text-start text-sm md:text-base font-semibold text-gray-900"},Ja={class:"text-xs md:text-sm text-gray-600 mt-0.5"},Ka={class:"flex items-center gap-2 md:gap-3"},Ya=["for"],Xa={class:"w-32 md:w-40"},Za={key:0,class:"text-start bg-gray-50 px-3 py-3 md:px-6 md:py-4 border-t border-gray-200"},es={class:"grid grid-cols-3 gap-2 md:gap-4"},ts={class:"text-xs md:text-sm text-gray-600"},as={class:"text-base md:text-xl font-semibold text-gray-900"},ss={class:"text-xs md:text-sm text-gray-600"},os={class:"text-base md:text-xl font-semibold text-gray-900"},ns={class:"text-xs md:text-sm text-gray-600"},ls={key:2,class:"bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm"},rs={class:"px-3 py-3 md:px-6 md:py-4 bg-gray-50 border-b border-gray-200"},is={class:"text-sm md:text-lg font-medium text-gray-900"},cs={class:"p-3 md:p-6"},us={class:"flex flex-col gap-2 md:gap-3"},ds={class:"text-xs md:text-sm font-medium text-gray-900"},_s={class:"text-xs text-gray-500"},ms={class:"text-end"},ps={class:"text-sm md:text-base font-semibold text-gray-900"},vs={class:"mt-3 md:mt-4 pt-3 md:pt-4 border-t border-gray-200"},fs={class:"flex items-center justify-between"},gs={class:"text-xs md:text-sm font-medium text-gray-700"},hs={class:"text-base md:text-lg font-bold text-gray-900"},ys={key:3,class:"rounded-lg bg-red-50 border border-red-200 p-3 md:p-4"},bs={class:"flex gap-2 md:gap-3"},xs={class:"flex-1"},ws={class:"text-xs md:text-sm font-medium text-red-800"},Ss={class:"text-xs md:text-sm text-red-700 mt-1"},Cs={key:2,class:"rounded-lg bg-red-50 border border-red-200 p-3 md:p-4"},ks={class:"flex gap-2 md:gap-3"},Os={class:"text-xs md:text-sm font-medium text-red-800"},Is={class:"text-xs md:text-sm text-red-700 mt-1"},As={class:"flex flex-col sm:flex-row justify-between w-full items-stretch sm:items-center gap-2 sm:gap-0"},$s={class:"flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-3 order-1 sm:order-2"},Es={key:0,class:"text-xs md:text-sm text-yellow-600 font-medium text-center sm:text-end"},qs={key:1,class:"text-xs md:text-sm text-green-600 font-medium text-center sm:text-end"},Ps={__name:"ShiftClosingDialog",props:{modelValue:{type:Boolean,required:!0},openingShift:{type:String,required:!0,validator:e=>e&&e.length>0}},emits:["update:modelValue","shift-closed"],setup(e,{emit:t}){const n=e,u=t,D=m({get:()=>n.modelValue,set:i=>u("update:modelValue",i)}),{getClosingShiftData:y,submitClosingShift:N}=ft(),{formatCurrency:q,formatQuantity:I,formatDateTime:L}=ht(),W=yt(),{hideExpectedAmount:F}=Tt(W),c=w(null),o=y,S=N,h=w(!1),$=w("");nt(D,i=>G(this,null,function*(){i&&n.openingShift&&(yield W.reloadSettings(),j())}));function j(){return G(this,null,function*(){try{$.value="";const i=yield o.submit({opening_shift:n.openingShift});i.payment_reconciliation&&(i.payment_reconciliation=i.payment_reconciliation.map(C=>{var P,V;return Nt(Ke(Ge({},C),{closing_amount:(V=(P=C.closing_amount)!=null?P:C.expected_amount)!=null?V:0,difference:0}))}),i.payment_reconciliation.forEach(C=>{se(C)})),c.value=i}catch(i){console.error("Error loading closing data:",i),$.value="Unable to load shift data. Please check your connection and try again."}})}function se(i){const C=Number.parseFloat(i.closing_amount)||0,P=Number.parseFloat(i.expected_amount)||0;i.difference=C-P}function K(i,C){i.closing_amount=C,se(i)}const le=m(()=>!c.value||!c.value.payment_reconciliation?!1:c.value.payment_reconciliation.every(i=>i.closing_amount!==null&&i.closing_amount!==void 0&&i.closing_amount!==""));function ee(){return G(this,null,function*(){if(c.value)try{$.value="",c.value.payment_reconciliation&&c.value.payment_reconciliation.forEach(i=>{se(i)}),yield S.submit({closing_shift:c.value}),F.value?h.value=!0:(u("shift-closed"),_e())}catch(i){console.error("Error submitting closing shift:",i),$.value="Failed to close shift. Please verify all amounts and try again."}})}function _e(){h.value&&u("shift-closed"),D.value=!1,c.value=null,h.value=!1,$.value=""}const Y=m(()=>!F.value||h.value),oe=m(()=>F.value&&!h.value),pe=m(()=>oe.value?"Enter the actual counted amounts for each payment method":h.value&&F.value?"Shift closed successfully - Review the final reconciliation below":"Count your cash and enter actual amounts below"),re=m(()=>c.value?(c.value.pos_transactions||[]).length:0),ve=m(()=>!c.value||!c.value.taxes?0:c.value.taxes.reduce((i,C)=>i+Number.parseFloat(C.amount||0),0)),b=m(()=>!c.value||!c.value.payment_reconciliation?0:c.value.payment_reconciliation.reduce((i,C)=>i+Number.parseFloat(C.expected_amount||0),0)),B=m(()=>!c.value||!c.value.payment_reconciliation?0:c.value.payment_reconciliation.reduce((i,C)=>i+Number.parseFloat(C.closing_amount||0),0)),O=m(()=>B.value-b.value);function ne(){if(!c.value||!c.value.period_start_date)return __("N/A");const i=new Date(c.value.period_start_date),P=new Date-i,V=Math.floor(P/(1e3*60*60)),te=Math.floor(P%(1e3*60*60)/(1e3*60));return V>0?__("{0}h {1}m",[V,te]):__("{0}m",[te])}function X(i){const C=i.toLowerCase();return C.includes("cash")?{icon:"ðŸ’µ",color:"bg-green-500"}:C.includes("card")||C.includes("credit")||C.includes("debit")?{icon:"ðŸ’³",color:"bg-blue-500"}:C.includes("mobile")||C.includes("wallet")||C.includes("upi")||C.includes("phone")?{icon:"ðŸ“±",color:"bg-purple-500"}:C.includes("bank")||C.includes("transfer")?{icon:"ðŸ¦",color:"bg-indigo-500"}:C.includes("cheque")||C.includes("check")?{icon:"ðŸ“",color:"bg-yellow-500"}:{icon:"ðŸ’°",color:"bg-gray-500"}}return(i,C)=>(T(),je(k(gt),{modelValue:D.value,"onUpdate:modelValue":C[1]||(C[1]=P=>D.value=P),options:{title:i.__("Close POS Shift"),size:"4xl"}},{"body-content":ye(()=>[a("div",Ht,[k(o).loading?(T(),M("div",Qt,[C[2]||(C[2]=a("div",{class:"inline-block animate-spin rounded-full h-12 w-12 md:h-16 md:w-16 border-b-4 border-blue-600"},null,-1)),a("p",Jt,d(i.__("Loading shift data...")),1),a("p",Kt,d(i.__("Calculating totals and reconciliation...")),1)])):c.value?(T(),M("div",Yt,[Y.value?(T(),M("div",Xt,[a("div",Zt,[a("div",ea,[a("h3",ta,d(c.value.pos_profile),1),a("p",aa,d(k(L)(c.value.period_start_date)),1)]),a("div",sa,[a("div",oa,d(i.__("Duration")),1),a("div",na,d(ne()),1)])]),a("div",la,[a("div",ra,[a("div",ia,d(i.__("Total Sales")),1),a("div",ca,d(k(q)(c.value.grand_total)),1),a("div",ua,d(i.__("{0} invoices",[re.value])),1)]),a("div",da,[a("div",_a,d(i.__("Net Amount")),1),a("div",ma,d(k(q)(c.value.net_total)),1),a("div",pa,d(i.__("Before tax")),1)]),a("div",va,[a("div",fa,d(i.__("Items Sold")),1),a("div",ga,d(k(I)(c.value.total_quantity)),1),a("div",ha,d(i.__("Total items")),1)]),a("div",ya,[a("div",ba,d(i.__("Tax Collected")),1),a("div",xa,d(k(q)(ve.value)),1),a("div",wa,d(i.__("Total tax")),1)])])])):ae("",!0),Y.value&&re.value===0?(T(),M("div",Sa,[a("div",Ca,[C[3]||(C[3]=a("div",{class:"flex-shrink-0"},[a("svg",{class:"h-4 w-4 md:h-5 md:w-5 text-yellow-600",fill:"currentColor",viewBox:"0 0 20 20"},[a("path",{"fill-rule":"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})])],-1)),a("div",null,[a("h3",ka,d(i.__("No Sales During This Shift")),1),a("p",Oa,d(i.__("No invoices were created. Closing amounts should match opening amounts.")),1)])])])):ae("",!0),a("div",Ia,[a("div",{class:He(["px-3 py-3 md:px-6 md:py-4 border-b border-gray-200",k(F)&&h.value?"bg-green-50 border-green-200":"bg-gray-50"])},[a("div",Aa,[a("div",null,[a("div",$a,[a("h3",Ea,d(i.__("Payment Reconciliation")),1),k(F)&&h.value?(T(),M("span",qa,d(i.__("âœ“ Shift Closed")),1)):ae("",!0)]),a("p",Pa,d(pe.value),1)]),Y.value&&O.value!==0?(T(),M("div",Ta,[a("div",Na,d(i.__("Total Variance")),1),a("div",{class:He(["text-lg md:text-xl font-bold",O.value>0?"text-blue-600":"text-red-600"])},d(O.value>0?"+":"")+d(k(q)(Math.abs(O.value))),3)])):ae("",!0)])],2),a("div",Da,[oe.value?(T(),M("div",Ba,[(T(!0),M(Je,null,Ze(c.value.payment_reconciliation,(P,V)=>(T(),M("div",{key:V,class:"border border-gray-200 rounded-lg p-3 md:p-4 bg-white hover:border-gray-300 transition-colors"},[a("div",Fa,[a("div",La,[a("div",{class:He(["rounded-lg p-1.5 md:p-2 flex-shrink-0",X(P.mode_of_payment).color])},[a("span",Va,d(X(P.mode_of_payment).icon),1)],2),a("div",Ra,d(P.mode_of_payment),1)]),a("div",Ma,[a("label",{for:`payment-${V}`,class:"text-sm md:text-base font-medium text-gray-700 whitespace-nowrap"},d(i.__("Actual Amount:")),9,ja),a("div",za,[Ce(k(rt),{id:`payment-${V}`,modelValue:P.closing_amount,"onUpdate:modelValue":te=>K(P,te),type:"number",step:"10",min:"0",placeholder:"0.00",disabled:k(S).loading,"aria-label":i.__("Enter actual amount for {0}",[P.mode_of_payment]),class:"text-base md:text-lg text-center font-semibold"},null,8,["id","modelValue","onUpdate:modelValue","disabled","aria-label"])])])])]))),128))])):(T(),M("div",Ua,[(T(!0),M(Je,null,Ze(c.value.payment_reconciliation,(P,V)=>(T(),M("div",{key:V,class:"border border-gray-200 rounded-lg p-3 md:p-4 bg-white hover:border-gray-300 transition-colors"},[a("div",Ga,[a("div",Wa,[a("div",{class:He(["rounded-lg p-1.5 md:p-2 flex-shrink-0",X(P.mode_of_payment).color])},[a("span",Ha,d(X(P.mode_of_payment).icon),1)],2),a("div",null,[a("div",Qa,d(P.mode_of_payment),1),a("div",Ja,d(i.__("Total: {0}",[k(q)(P.expected_amount)])),1)])]),a("div",Ka,[a("label",{for:`payment-actual-${V}`,class:"text-sm md:text-base font-medium text-gray-700 whitespace-nowrap"},d(i.__("Actual Amount:")),9,Ya),a("div",Xa,[Ce(k(rt),{id:`payment-actual-${V}`,modelValue:P.closing_amount,"onUpdate:modelValue":te=>K(P,te),type:"number",step:"0.01",min:"0",placeholder:"0.00",disabled:h.value||k(S).loading,"aria-label":i.__("Enter actual amount for {0}",[P.mode_of_payment]),class:"text-base md:text-lg text-center font-semibold"},null,8,["id","modelValue","onUpdate:modelValue","disabled","aria-label"])])])])]))),128))]))]),Y.value?(T(),M("div",Za,[a("div",es,[a("div",null,[a("p",ts,d(i.__("Total Expected")),1),a("p",as,d(k(q)(b.value)),1)]),a("div",null,[a("p",ss,d(i.__("Total Actual")),1),a("p",os,d(k(q)(B.value)),1)]),a("div",null,[a("p",ns,d(i.__("Net Variance")),1),a("p",{class:He(["text-base md:text-xl font-bold",O.value===0?"text-green-600":O.value>0?"text-blue-600":"text-red-600"])},d(O.value===0?"âœ“ ":O.value>0?"+":"")+d(k(q)(Math.abs(O.value))),3)])])])):ae("",!0)]),Y.value&&c.value.taxes&&c.value.taxes.length>0?(T(),M("div",ls,[a("div",rs,[a("h3",is,d(i.__("Tax Summary")),1)]),a("div",cs,[a("div",us,[(T(!0),M(Je,null,Ze(c.value.taxes,(P,V)=>(T(),M("div",{key:V,class:"flex items-center justify-between py-2 border-b border-gray-100 last:border-0"},[a("div",null,[a("p",ds,d(P.account_head),1),a("p",_s,d(k(I)(P.rate))+"%",1)]),a("div",ms,[a("p",ps,d(k(q)(P.amount)),1)])]))),128))]),a("div",vs,[a("div",fs,[a("span",gs,d(i.__("Total Tax Collected")),1),a("span",hs,d(k(q)(ve.value)),1)])])])])):ae("",!0),k(S).error||$.value&&!k(o).error?(T(),M("div",ys,[a("div",bs,[C[4]||(C[4]=a("svg",{class:"h-4 w-4 md:h-5 md:w-5 text-red-600 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20"},[a("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z","clip-rule":"evenodd"})],-1)),a("div",xs,[a("h4",ws,d(i.__("Error Closing Shift")),1),a("p",Ss,d($.value||k(S).error),1),$.value?(T(),M("button",{key:0,onClick:C[0]||(C[0]=P=>$.value=""),class:"mt-2 text-xs text-red-600 hover:text-red-800 underline"},d(i.__("Dismiss")),1)):ae("",!0)])])])):ae("",!0)])):k(o).error||$.value?(T(),M("div",Cs,[a("div",ks,[C[5]||(C[5]=a("svg",{class:"h-4 w-4 md:h-5 md:w-5 text-red-600 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20"},[a("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z","clip-rule":"evenodd"})],-1)),a("div",null,[a("h3",Os,d(i.__("Failed to Load Shift Data")),1),a("p",Is,d($.value||k(o).error),1)])])])):ae("",!0)])]),actions:ye(()=>[a("div",As,[Ce(k(Pe),{variant:"subtle",onClick:_e,disabled:k(S).loading,class:"order-2 sm:order-1"},{default:ye(()=>[Te(d(h.value?i.__("Close"):i.__("Cancel")),1)]),_:1},8,["disabled"]),a("div",$s,[!le.value&&c.value&&!h.value?(T(),M("div",Es,d(i.__("Please enter all closing amounts")),1)):ae("",!0),h.value?(T(),M("div",qs,d(i.__("âœ“ Shift closed successfully")),1)):ae("",!0),h.value?ae("",!0):(T(),je(k(Pe),{key:2,variant:"solid",theme:"blue",onClick:ee,loading:k(S).loading,disabled:!le.value},{default:ye(()=>[Te(d(k(S).loading?i.__("Closing Shift..."):i.__("Close Shift")),1)]),_:1},8,["loading","disabled"]))])])]),_:1},8,["modelValue","options"]))}},Ts={class:"flex flex-col gap-6"},Ns={key:0,class:"flex flex-col gap-4"},Ds={class:"block text-sm font-medium text-gray-700 mb-2 text-start"},Bs={key:0,class:"text-center py-4"},Fs={key:1,class:"grid grid-cols-1 gap-3"},Ls=["onClick"],Vs={class:"flex justify-between items-start"},Rs={class:"font-medium text-gray-900"},Ms={class:"text-sm text-gray-500 mt-1"},js={class:"text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded"},zs={key:2,class:"text-center py-8 text-gray-500"},Us={key:0,class:"rounded-md bg-red-50 p-4"},Gs={class:"text-sm text-red-800"},Ws={key:1,class:"flex flex-col gap-4"},Hs={class:"mb-4"},Qs={class:"flex items-center justify-between"},Js={class:"font-medium text-gray-900"},Ks={class:"text-sm text-gray-500"},Ys={class:"block text-sm font-medium text-gray-700 mb-3 text-start"},Xs={key:0,class:"text-center py-4"},Zs={key:1,class:"flex flex-col gap-3"},eo={class:"flex-1"},to={class:"text-sm font-medium text-gray-700 text-start"},ao={class:"w-32"},so={key:2,class:"text-center py-4 text-gray-500"},oo={class:"text-sm"},no={key:0,class:"rounded-md bg-red-50 p-4"},lo={class:"text-sm text-red-800"},ro={key:1,class:"rounded-md bg-red-50 p-4"},io={class:"text-sm text-red-800"},co={key:2,class:"flex flex-col gap-4"},uo={class:"text-center"},_o={class:"text-lg font-medium text-gray-900 mb-2"},mo={class:"text-sm text-gray-500 mb-6"},po={key:0,class:"bg-gray-50 rounded-lg p-4 mb-6"},vo={class:"text-sm text-gray-600"},fo={class:"flex gap-3 justify-center"},go={class:"flex justify-between w-full"},ho={key:1},yo={class:"flex gap-2"},Vo={__name:"ShiftOpeningDialog",props:{modelValue:Boolean},emits:["update:modelValue","shift-opened","dialog-closed"],setup(e,{emit:t}){const n=e,u=t,D=m({get:()=>n.modelValue,set:b=>u("update:modelValue",b)}),{createOpeningShift:y,checkOpeningShift:N}=ft(),{formatDateTime:q}=ht(),I=w(1),L=w(null),W=w({}),F=w(null),c=w(!1),o=w(!1),S=w(null),h=Se({url:"pos_next.api.pos_profile.get_pos_profiles",auto:!1}),$=Se({url:"pos_next.api.shifts.get_opening_dialog_data",auto:!1}),j=y,se=m(()=>!$.data||!L.value?[]:($.data.payments_method||[]).filter(b=>b.parent===L.value.name));nt(D,b=>{b?K():le()},{immediate:!0}),nt(c,b=>{o.value=b,!b&&F.value&&(S.value=null)});function K(){return G(this,null,function*(){I.value=1,L.value=null,F.value=null,W.value={},$.reset();try{yield h.fetch();const b=yield N.fetch();if(b){F.value=b,oe();return}}catch(b){console.error("Error initializing shift dialog:",b)}})}function le(){I.value=1,L.value=null,W.value={},F.value=null,h.reset(),$.reset(),j.reset()}function ee(b){L.value=b}function _e(){return G(this,null,function*(){I.value===1&&L.value&&(yield $.fetch(),I.value=2)})}function Y(){return G(this,null,function*(){if(!L.value)return;const b=se.value.map(B=>({mode_of_payment:B.mode_of_payment,opening_amount:Number.parseFloat(W.value[B.mode_of_payment]||0)}));try{yield j.submit({pos_profile:L.value.name,company:L.value.company,balance_details:b}),u("shift-opened"),re("shift-opened")}catch(B){console.error("Error opening shift:",B)}})}function oe(){u("shift-opened"),re("resumed")}function pe(){var b,B,O;(B=(b=F.value)==null?void 0:b.pos_opening_shift)!=null&&B.name&&(S.value=((O=F.value.pos_profile)==null?void 0:O.name)||null,c.value=!0)}function re(b){D.value=!1,u("dialog-closed",{reason:b})}function ve(){return G(this,null,function*(){var B;c.value=!1;const b=S.value;if(S.value=null,F.value=null,I.value=1,W.value={},yield N.fetch(),(!h.data||h.data.length===0)&&(yield h.fetch()),b){const O=(B=h.data)==null?void 0:B.find(ne=>ne.name===b);O&&(L.value=O,yield $.fetch(),I.value=2)}})}return(b,B)=>{var O,ne;return T(),M(Je,null,[Ce(k(gt),{modelValue:D.value,"onUpdate:modelValue":B[3]||(B[3]=X=>D.value=X),options:{title:b.__("Open POS Shift"),size:"xl"}},{"body-content":ye(()=>{var X,i,C,P;return[a("div",Ts,[I.value===1?(T(),M("div",Ns,[a("div",null,[a("label",Ds,d(b.__("Select POS Profile")),1),k(h).loading?(T(),M("div",Bs,B[5]||(B[5]=[a("div",{class:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"},null,-1)]))):k(h).data&&k(h).data.length>0?(T(),M("div",Fs,[(T(!0),M(Je,null,Ze(k(h).data,V=>{var te;return T(),M("div",{key:V.name,onClick:Ne=>ee(V),class:He(["p-4 border rounded-lg cursor-pointer transition-all",((te=L.value)==null?void 0:te.name)===V.name?"border-blue-500 bg-blue-50 ring-2 ring-blue-500":"border-gray-200 hover:border-blue-300 hover:bg-gray-50"])},[a("div",Vs,[a("div",null,[a("h3",Rs,d(V.name),1),a("p",Ms,d(V.company),1)]),a("span",js,d(V.currency),1)])],10,Ls)}),128))])):(T(),M("div",zs,[a("p",null,d(b.__("No POS Profiles available. Please contact your administrator.")),1)]))]),k(h).error?(T(),M("div",Us,[a("p",Gs,d(k(h).error),1)])):ae("",!0)])):ae("",!0),I.value===2?(T(),M("div",Ws,[a("div",Hs,[a("div",Qs,[a("div",null,[a("h3",Js,d((X=L.value)==null?void 0:X.name),1),a("p",Ks,d((i=L.value)==null?void 0:i.company),1)]),Ce(k(Pe),{variant:"subtle",onClick:B[0]||(B[0]=V=>I.value=1)},{default:ye(()=>[Te(d(b.__("Change Profile")),1)]),_:1})])]),a("div",null,[a("label",Ys,d(b.__("Opening Balance (Optional)")),1),k($).loading?(T(),M("div",Xs,B[6]||(B[6]=[a("div",{class:"inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"},null,-1)]))):se.value.length>0?(T(),M("div",Zs,[(T(!0),M(Je,null,Ze(se.value,V=>(T(),M("div",{key:V.name,class:"flex items-center justify-between p-3 border rounded-lg"},[a("div",eo,[a("label",to,d(V.mode_of_payment),1)]),a("div",ao,[Ce(k(rt),{modelValue:W.value[V.mode_of_payment],"onUpdate:modelValue":te=>W.value[V.mode_of_payment]=te,type:"number",placeholder:"0.00",step:"0.01",min:"0"},null,8,["modelValue","onUpdate:modelValue"])])]))),128))])):(T(),M("div",so,[a("p",oo,d(b.__("No payment methods configured for this POS Profile")),1)]))]),k($).error?(T(),M("div",no,[a("p",lo,d(k($).error),1)])):ae("",!0),k(j).error?(T(),M("div",ro,[a("p",io,d(k(j).error),1)])):ae("",!0)])):ae("",!0),I.value===3?(T(),M("div",co,[a("div",uo,[B[8]||(B[8]=a("div",{class:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4"},[a("svg",{class:"h-6 w-6 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})])],-1)),a("h3",_o,d(b.__("Existing Shift Found")),1),a("p",mo,d(b.__("You have an open shift. Would you like to resume it or close it and open a new one?")),1),F.value?(T(),M("div",po,[a("div",vo,[Ce(_t,{tag:"p",inner:b.__("<strong>POS Profile:</strong> {0}",[(C=F.value.pos_profile)==null?void 0:C.name])},null,8,["inner"]),B[7]||(B[7]=a("div",{class:"h-2"},null,-1)),Ce(_t,{tag:"p",inner:b.__("<strong>Opened:</strong> {0}",[k(q)((P=F.value.pos_opening_shift)==null?void 0:P.period_start_date)])},null,8,["inner"])])])):ae("",!0),a("div",fo,[Ce(k(Pe),{variant:"solid",theme:"blue",onClick:oe},{default:ye(()=>[Te(d(b.__("Resume Shift")),1)]),_:1}),Ce(k(Pe),{variant:"subtle",theme:"gray",onClick:pe,disabled:o.value},{default:ye(()=>[Te(d(b.__("Close & Open New")),1)]),_:1},8,["disabled"])])])])):ae("",!0)])]}),actions:ye(()=>[a("div",go,[I.value>1&&I.value!==3?(T(),je(k(Pe),{key:0,variant:"subtle",onClick:B[1]||(B[1]=X=>I.value--)},{default:ye(()=>[Te(d(b.__("Back")),1)]),_:1})):(T(),M("div",ho)),a("div",yo,[Ce(k(Pe),{variant:"subtle",onClick:B[2]||(B[2]=X=>re("cancelled")),disabled:k(j).loading},{default:ye(()=>[Te(d(b.__("Cancel")),1)]),_:1},8,["disabled"]),I.value===1?(T(),je(k(Pe),{key:0,variant:"solid",theme:"blue",onClick:_e,disabled:!L.value},{default:ye(()=>[Te(d(b.__("Next")),1)]),_:1},8,["disabled"])):ae("",!0),I.value===2?(T(),je(k(Pe),{key:1,variant:"solid",theme:"blue",onClick:Y,loading:k(j).loading},{default:ye(()=>[Te(d(b.__("Open Shift")),1)]),_:1},8,["loading"])):ae("",!0)])])]),_:1},8,["modelValue","options"]),F.value?(T(),je(Ps,{key:0,modelValue:c.value,"onUpdate:modelValue":B[4]||(B[4]=X=>c.value=X),"opening-shift":(ne=(O=F.value)==null?void 0:O.pos_opening_shift)==null?void 0:ne.name,onShiftClosed:ve},null,8,["modelValue","opening-shift"])):ae("",!0)],64)}}},Ae=Dt.create("SerialNumber"),bo=at("serialNumber",()=>{const e=w(new Map),t=w(!1),n=w(null),u=5*60*1e3,D=c=>{const o=e.value.get(c);return o?o.serials:[]},y=c=>{const o=e.value.get(c);return!(!o||o.warehouse!==n.value||Date.now()-o.timestamp>u)},N=c=>{n.value!==c&&(n.value=c,e.value.clear(),Ae.info(`Warehouse changed to ${c}, cache cleared`))},q=(c,o=!1)=>G(void 0,null,function*(){if(!c||!n.value)return Ae.warn("Missing itemCode or warehouse"),[];if(!o&&y(c))return Ae.info(`Using cached serials for ${c}`),D(c);t.value=!0;try{const h=(yield lt("frappe.client.get_list",{doctype:"Serial No",filters:{item_code:c,warehouse:n.value,status:"Active"},fields:["name as serial_no","warehouse"],limit_page_length:500}))||[];return e.value.set(c,{serials:h,warehouse:n.value,timestamp:Date.now()}),Ae.success(`Loaded ${h.length} serials for ${c}`),h}catch(S){return Ae.error(`Failed to fetch serials for ${c}`,S),[]}finally{t.value=!1}});return{cache:e,loading:t,currentWarehouse:n,getSerials:D,isCacheValid:y,setWarehouse:N,fetchSerials:q,consumeSerials:(c,o)=>{const S=e.value.get(c);if(!S)return;const h=new Set(Array.isArray(o)?o:o.split(`
`).map($=>$.trim()).filter(Boolean));S.serials=S.serials.filter($=>!h.has($.serial_no)),Ae.info(`Consumed ${h.size} serials for ${c}`)},returnSerials:(c,o)=>{const S=e.value.get(c);if(!S)return;const h=Array.isArray(o)?o:o.split(`
`).map(j=>j.trim()).filter(Boolean),$=new Set(S.serials.map(j=>j.serial_no));for(const j of h)$.has(j)||S.serials.push({serial_no:j,warehouse:n.value});S.serials.sort((j,se)=>j.serial_no.localeCompare(se.serial_no,void 0,{numeric:!0})),Ae.info(`Returned ${h.length} serials for ${c}`)},clearCache:(c=null)=>{c?(e.value.delete(c),Ae.info(`Cache cleared for ${c}`)):(e.value.clear(),Ae.info("All cache cleared"))},prefetchSerials:c=>G(void 0,null,function*(){const o=c.filter(h=>!y(h));if(o.length===0)return;Ae.info(`Prefetching serials for ${o.length} items`);const S=3;for(let h=0;h<o.length;h+=S){const $=o.slice(h,h+S);yield Promise.all($.map(j=>q(j)))}})}}),xo=()=>typeof window=="undefined"?!1:it.isOffline,wo=()=>G(void 0,null,function*(){try{return yield be.invoice_queue.filter(t=>t.synced===!1).toArray()}catch(e){return console.error("Error getting offline invoices:",e),[]}}),So=()=>G(void 0,null,function*(){if(xo())return console.log("Cannot sync while offline"),{success:0,failed:0};const e=yield wo();if(e.length===0)return{success:0,failed:0};let t=0,n=0;const u=[];for(const y of e)try{const N=Ge({},y.data);N.items&&Array.isArray(N.items)&&(N.items=N.items.map(I=>Ke(Ge({},I),{qty:I.quantity||I.qty||1})));const q=yield lt("pos_next.api.invoices.submit_invoice",{data:JSON.stringify({invoice:N,data:{}})});(q.message||q.name)&&(yield be.invoice_queue.update(y.id,{synced:!0}),t++,console.log(`Invoice ${y.id} synced successfully as ${q.name||q.message}`))}catch(N){console.error(`Error syncing invoice ${y.id}:`,N),u.push({invoiceId:y.id,customer:y.data.customer||"Walk-in Customer",error:N}),yield be.invoice_queue.update(y.id,{retry_count:(y.retry_count||0)+1}),n++,(y.retry_count||0)>=3&&(yield be.invoice_queue.update(y.id,{sync_failed:!0,error:N.message}))}const D=Date.now()-7*24*60*60*1e3;return yield be.invoice_queue.filter(y=>y.synced===!0&&y.timestamp<D).delete(),{success:t,failed:n,errors:u}});typeof window!="undefined"&&it.subscribe(e=>G(void 0,null,function*(){var t;if(!e.isOffline&&e.source!=="manual"){console.log("Back online, syncing pending invoices...");const n=yield So();window.dispatchEvent(new CustomEvent("offlineInvoicesSynced",{detail:n})),n.success>0&&(console.log(`Successfully synced ${n.success} invoices`),(t=window.frappe)!=null&&t.msgprint&&window.frappe.msgprint({title:__("Sync Complete"),message:`Successfully synced ${n.success} offline invoices`,indicator:"green"}))}}));const Co={items:["item_code","item_name","item_group","barcodes","price","stock"],customers:["name","customer_name","mobile_no","email_id"],item_prices:["price_list","item_code","price"],local_stock:["item_code","warehouse","actual_qty"],payment_methods:["mode_of_payment","pos_profile","default","allow_in_returns","type"]};function ko(e){const t=JSON.stringify(e);let n=0;for(let u=0;u<t.length;u++){const D=t.charCodeAt(u);n=(n<<5)-n+D,n=n&n}return Math.abs(n)}function Oo(){const e=ko(Co),t=localStorage.getItem("pos_next_cache_structure_hash"),n=Number.parseInt(localStorage.getItem("pos_next_cache_version")||"1");if(t!==e.toString()){const u=n+1;return console.log(`Cache structure changed. Upgrading from v${n} to v${u}`),localStorage.setItem("pos_next_cache_structure_hash",e.toString()),localStorage.setItem("pos_next_cache_version",u.toString()),u}return n}const Ye=Oo(),ue={offline_invoices:[],offline_customers:[],offline_payments:[],items:[],customers:[],item_prices:{},local_stock:{},payment_methods:[],items_last_sync:null,customers_last_sync:null,payment_methods_last_sync:null,cache_ready:!1,stock_cache_ready:!1,manual_offline:!1,cache_version:Ye},Io=()=>G(void 0,null,function*(){try{console.log("Initializing memory cache..."),(yield We("cache_version",Ye))!==Ye&&(console.log("Cache version mismatch, clearing cache..."),yield Ao(),yield Qe("cache_version",Ye),ue.cache_version=Ye),ue.items_last_sync=yield We("items_last_sync",null),ue.customers_last_sync=yield We("customers_last_sync",null),ue.cache_ready=yield We("cache_ready",!1),ue.stock_cache_ready=yield We("stock_cache_ready",!1),ue.manual_offline=yield We("manual_offline",!1),ue.manual_offline&&it.setManualOffline(!0,{silent:!0});const t=yield be.items.count(),n=yield be.customers.count();return console.log(`Cache initialized: ${t} items, ${n} customers`),console.log(`Cache ready: ${ue.cache_ready}, Stock ready: ${ue.stock_cache_ready}`),!0}catch(e){return console.error("Failed to initialize memory cache:",e),!1}}),Ro=e=>G(void 0,null,function*(){try{console.log("Fetching customers from server...");const t=yield lt("pos_next.api.customers.get_customers",{pos_profile:e,start:0,limit:0});if(t.message&&Array.isArray(t.message)){const n=t.message;return console.log(`Fetched ${n.length} customers from server`),{customers:n}}return{customers:[]}}catch(t){throw console.error("Error fetching customers from server:",t),t}}),Ao=()=>G(void 0,null,function*(){try{return console.log("Clearing all cache..."),yield be.items.clear(),yield be.customers.clear(),yield be.item_prices.clear(),yield be.stock.clear(),ue.items=[],ue.customers=[],ue.item_prices={},ue.local_stock={},ue.items_last_sync=null,ue.customers_last_sync=null,ue.cache_ready=!1,ue.stock_cache_ready=!1,yield Qe("items_last_sync",null),yield Qe("customers_last_sync",null),yield Qe("cache_ready",!1),yield Qe("stock_cache_ready",!1),console.log("Cache cleared successfully"),!0}catch(e){return console.error("Error clearing cache:",e),!1}});function Mo(e){return G(this,null,function*(){try{const t=yield lt("pos_next.api.pos_profile.get_payment_methods",{pos_profile:e}),n=(t==null?void 0:t.message)||t||[],u=n.map(y=>Ke(Ge({},y),{pos_profile:e}));yield be.payment_methods.bulkPut(u);const D=Date.now();return yield Qe("payment_methods_last_sync",D),ue.payment_methods_last_sync=D,console.log(`Cached ${n.length} payment methods for ${e}`),{payment_methods:n}}catch(t){throw console.error("Error caching payment methods:",t),t}})}Io();function $o(){const e=bo(),t=w([]),n=w(null),u=w([]),D=w([]),y=w(null),N=w(null),q=w(0),I=w(null),L=w([]),W=w(!1),F=w(0),c=w(0),o=w(0),S=w(0),h=Se({url:"pos_next.api.invoices.update_invoice",makeParams(s){return{data:JSON.stringify(s.data)}},auto:!1}),$=Se({url:"pos_next.api.invoices.submit_invoice",makeParams(s){return{invoice:JSON.stringify(s.invoice),data:JSON.stringify(s.data||{})}},auto:!1,onError(s){console.error("submitInvoiceResource onError:",s),$.error&&(s.resourceError=$.error)}}),j=Se({url:"pos_next.api.invoices.validate_cart_items",makeParams({items:s,pos_profile:f}){return{items:JSON.stringify(s),pos_profile:f}},auto:!1}),se=Se({url:"pos_next.api.invoices.apply_offers",makeParams({invoice_data:s,selected_offers:f}){const r={invoice_data:JSON.stringify(s)};return f&&f.length&&(r.selected_offers=JSON.stringify(f)),r},auto:!1}),K=Se({url:"pos_next.api.items.get_item_details",auto:!1}),le=Se({url:"pos_next.api.pos_profile.get_taxes",auto:!1}),ee=Se({url:"pos_next.api.pos_profile.get_default_customer",makeParams({pos_profile:s}){return{pos_profile:s}},auto:!1}),_e=Se({url:"pos_next.api.invoices.cleanup_old_drafts",auto:!1}),Y=m(()=>F.value),oe=m(()=>c.value),pe=m(()=>o.value+(q.value||0)),re=m(()=>{const s=o.value+(q.value||0);return W.value?F.value-s:F.value+c.value-s}),ve=m(()=>S.value),b=m(()=>re.value-ve.value),B=m(()=>t.value.length>0&&b.value<=.01);function O(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}function ne(s,f=1,r=!0){let g=null;if(r&&(g=t.value.find(H=>H.item_code===s.item_code)),g){const H=g.price_list_rate||g.rate,A=g.quantity*H,Z=g.tax_amount||0,ie=g.discount_amount||0;if(g.has_serial_no&&s.serial_no){const x=g.serial_no?g.serial_no.split(`
`).filter(v=>v.trim()):[],U=s.serial_no.split(`
`).filter(v=>v.trim()),l=[...new Set([...x,...U])];g.serial_no=l.join(`
`),g.quantity=l.length}else g.quantity+=f;fe(g);const he=g.price_list_rate||g.rate;F.value+=g.quantity*he-A,c.value+=(g.tax_amount||0)-Z,o.value+=(g.discount_amount||0)-ie}else{const H={row_id:O(),item_code:s.item_code,item_name:s.item_name,rate:s.rate||s.price_list_rate||0,price_list_rate:s.price_list_rate||s.rate||0,quantity:f,discount_amount:0,discount_percentage:0,tax_amount:0,amount:f*(s.rate||s.price_list_rate||0),stock_qty:s.stock_qty||0,image:s.image,uom:s.uom||s.stock_uom,stock_uom:s.stock_uom,conversion_factor:s.conversion_factor||1,warehouse:s.warehouse,actual_batch_qty:s.actual_batch_qty||0,has_batch_no:s.has_batch_no||0,has_serial_no:s.has_serial_no||0,batch_no:s.batch_no,serial_no:s.serial_no,item_uoms:s.item_uoms||[],item_group:s.item_group,brand:s.brand};t.value.push(H),fe(H);const A=H.price_list_rate||H.rate;F.value+=H.quantity*A,c.value+=H.tax_amount||0,o.value+=H.discount_amount||0}}function X(s){const f=t.value.find(r=>r.row_id===s||r.item_code===s);if(f){const r=f.price_list_rate||f.rate;F.value-=f.quantity*r,c.value-=f.tax_amount||0,o.value-=f.discount_amount||0,f.serial_no&&f.has_serial_no&&e.returnSerials(f.item_code,f.serial_no)}t.value=t.value.filter(r=>r.row_id!==s&&r.item_code!==s)}function i(s,f){const r=t.value.find(g=>g.row_id===s||g.item_code===s);if(r){const g=r.price_list_rate||r.rate,H=r.quantity*g,A=r.tax_amount||0,Z=r.discount_amount||0,ie=r.quantity,he=Number.parseFloat(f)||1;if(r.has_serial_no&&r.serial_no){const U=r.serial_no.split(`
`).filter(l=>l.trim());if(he<ie){const l=U.slice(he),v=U.slice(0,he);l.length>0&&(e.returnSerials(r.item_code,l),r.serial_no=v.join(`
`))}}r.quantity=he,fe(r);const x=r.price_list_rate||r.rate;F.value+=r.quantity*x-H,c.value+=(r.tax_amount||0)-A,o.value+=(r.discount_amount||0)-Z}}function C(s,f){const r=t.value.find(g=>g.row_id===s||g.item_code===s);if(r){const g=r.price_list_rate||r.rate,H=r.quantity*g,A=r.tax_amount||0,Z=r.discount_amount||0;r.rate=Number.parseFloat(f)||0,fe(r);const ie=r.price_list_rate||r.rate;F.value+=r.quantity*ie-H,c.value+=(r.tax_amount||0)-A,o.value+=(r.discount_amount||0)-Z}}function P(s,f){const r=t.value.find(g=>g.row_id===s||g.item_code===s);if(r){let g=Number.parseFloat(f)||0;g<0&&(g=0),g>100&&(g=100);const H=r.price_list_rate||r.rate,A=r.quantity*H,Z=r.tax_amount||0,ie=r.discount_amount||0;r.discount_percentage=g,r.discount_amount=0,fe(r);const he=r.price_list_rate||r.rate;F.value+=r.quantity*he-A,c.value+=(r.tax_amount||0)-Z,o.value+=(r.discount_amount||0)-ie}}function V(s,f=null){if(!s)return 0;const r=f!==null?f:Y.value;return s.percentage>0?r*s.percentage/100:s.amount>0?s.amount:0}function te(s){if(!s)return;I.value=s.code||s.name;let f=V(s,Y.value);f>Y.value&&(f=Y.value),f<0&&(f=0),q.value=f,xe()}function Ne(){q.value=0,I.value=null,xe()}let $e=0,ke="";function Le(){const s=JSON.stringify(L.value);if(s===ke&&$e!==0)return $e;let f=0;if(L.value&&L.value.length>0)for(const r of L.value)(r.charge_type==="On Net Total"||r.charge_type==="On Previous Row Total")&&(f+=r.rate||0);return $e=f,ke=s,f}function xe(){F.value=0,c.value=0,o.value=0;for(const s of t.value){const f=s.price_list_rate||s.rate;F.value+=s.quantity*f,c.value+=s.tax_amount||0,o.value+=s.discount_amount||0}S.value=0;for(const s of u.value)S.value+=s.amount||0}function fe(s){const f=s.price_list_rate||s.rate,r=s.quantity*f;let g=0;s.discount_percentage>0?g=r*s.discount_percentage/100:s.discount_amount>0&&(g=s.discount_amount,s.discount_percentage=r>0?g/r*100:0),s.discount_amount=g;const H=Le();let A=0,Z=0;if(W.value&&H>0){const ie=r-g;A=ie/(1+H/100),Z=ie-A}else A=r-g,Z=A*H/100;s.tax_amount=Z,s.rate=f,s.amount=A}function De(s){const f=Number.parseFloat(s.amount)||0;u.value.push({mode_of_payment:s.mode_of_payment,amount:f,type:s.type}),S.value+=f}function Q(s){u.value[s]&&(S.value-=u.value[s].amount||0),u.value.splice(s,1)}function me(s,f){if(u.value[s]){const r=u.value[s].amount||0,g=Number.parseFloat(f)||0;u.value[s].amount=g,S.value+=g-r}}function we(){return G(this,null,function*(){const f=Me(t.value).map(r=>({item_code:r.item_code,qty:r.quantity,warehouse:r.warehouse,conversion_factor:r.conversion_factor||1,stock_qty:r.quantity*(r.conversion_factor||1),is_stock_item:r.is_stock_item!==!1}));try{return(yield j.submit({items:f,pos_profile:y.value}))||[]}catch(r){return console.error("Stock validation error:",r),[]}})}function Ee(){return G(this,null,function*(){var H;const s=Me(t.value),f=Me(u.value),r={doctype:"Sales Invoice",pos_profile:y.value,posa_pos_opening_shift:N.value,customer:((H=n.value)==null?void 0:H.name)||n.value,items:s.map(A=>{let Z=A.item_name||A.item_code;return A.comment&&(Z=`${A.item_name||A.item_code}
ðŸ“ ${A.comment}`),{item_code:A.item_code,item_name:A.item_name,description:Z,qty:A.quantity,rate:W.value?(A.price_list_rate||A.rate)-(A.discount_amount||0)/(A.quantity||1):A.quantity>0?A.amount/A.quantity:A.rate,price_list_rate:A.price_list_rate||A.rate,uom:A.uom,warehouse:A.warehouse,batch_no:A.batch_no,serial_no:A.serial_no,conversion_factor:A.conversion_factor||1,discount_percentage:A.discount_percentage||0,discount_amount:A.discount_amount||0}}),payments:f.map(A=>({mode_of_payment:A.mode_of_payment,amount:A.amount,type:A.type})),discount_amount:q.value||0,coupon_code:I.value,is_pos:1,update_stock:1},g=yield h.submit({data:r});return(g==null?void 0:g.data)||g})}function ge(){return G(this,null,function*(){var s;try{const f=Me(t.value),r=Me(u.value),g=Me(D.value);let H=((s=n.value)==null?void 0:s.name)||n.value;if(!H&&y.value)try{const x=yield ee.submit({pos_profile:y.value});x&&x.customer&&(H=x.customer)}catch(x){console.log("No default customer available in POS Profile")}const A={doctype:"Sales Invoice",pos_profile:y.value,posa_pos_opening_shift:N.value,customer:H,items:f.map(x=>{let U=x.item_name||x.item_code;return x.comment&&(U=`${x.item_name||x.item_code}
ðŸ“ ${x.comment}`),{item_code:x.item_code,item_name:x.item_name,description:U,qty:x.quantity,rate:W.value?(x.price_list_rate||x.rate)-(x.discount_amount||0)/(x.quantity||1):x.quantity>0?x.amount/x.quantity:x.rate,price_list_rate:x.price_list_rate||x.rate,uom:x.uom,warehouse:x.warehouse,batch_no:x.batch_no,serial_no:x.serial_no,conversion_factor:x.conversion_factor||1,discount_percentage:x.discount_percentage||0,discount_amount:x.discount_amount||0}}),payments:r.map(x=>({mode_of_payment:x.mode_of_payment,amount:x.amount,type:x.type})),discount_amount:q.value||0,coupon_code:I.value,is_pos:1,update_stock:1};g&&g.length>0&&(A.sales_team=g.map(x=>({sales_person:x.sales_person,allocated_percentage:x.allocated_percentage||0})));const Z=yield h.submit({data:A});let ie=Z;if(Z&&typeof Z=="object"&&"data"in Z&&(ie=Z.data),!ie||!ie.name)throw new Error("Failed to create draft invoice - no invoice name returned");const he={change_amount:b.value<0?Math.abs(b.value):0};try{const x=yield $.submit({invoice:ie,data:he});if($.error){const U=$.error;console.error("Submit invoice resource error:",U);const l=new Error(U.message||"Invoice submission failed");throw l.exc_type=U.exc_type,l._server_messages=U._server_messages,l.httpStatus=U.httpStatus,l.messages=U.messages,l}return J(),x}catch(x){if(console.error("Submit invoice error:",x),console.log("submitInvoiceResource.error:",$.error),$.error){const U=$.error;console.log("Resource error details:",{exc_type:U.exc_type,_server_messages:U._server_messages,httpStatus:U.httpStatus,messages:U.messages,messagesContent:JSON.stringify(U.messages),data:U.data,exception:U.exception,keys:Object.keys(U)}),U.messages&&U.messages.length>0&&console.log("First message:",U.messages[0]),x.exc_type=U.exc_type||x.exc_type,x._server_messages=U._server_messages,x.httpStatus=U.httpStatus,x.messages=U.messages,x.exception=U.exception,x.data=U.data,console.log("After attaching, error.messages:",x.messages)}throw x}}catch(f){throw console.error("Submit invoice outer error:",f),f}})}function Oe(){return G(this,null,function*(){if(n.value=null,!!y.value)try{const s=yield ee.submit({pos_profile:y.value});s&&s.customer&&(n.value={name:s.customer,customer_name:s.customer_name||s.customer,customer_group:s.customer_group})}catch(s){console.log("No default customer set in POS Profile")}})}function J(){t.value=[],u.value=[],q.value=0,I.value=null,F.value=0,c.value=0,o.value=0,S.value=0,Oe()}function Ie(){return G(this,null,function*(){for(const s of t.value)s.has_serial_no&&s.serial_no&&e.returnSerials(s.item_code,s.serial_no);if(t.value=[],u.value=[],q.value=0,I.value=null,F.value=0,c.value=0,o.value=0,S.value=0,Oe(),!Bt())try{yield _e.submit({pos_profile:y.value,max_age_hours:1})}catch(s){console.warn("Failed to cleanup old drafts:",s)}})}function Be(s,f=null){return G(this,null,function*(){try{const r=yield le.submit({pos_profile:s});return L.value=(r==null?void 0:r.data)||r||[],f&&f.tax_inclusive!==void 0&&(W.value=f.tax_inclusive||!1),t.value.forEach(g=>fe(g)),xe(),L.value}catch(r){return console.error("Error loading tax rules:",r),L.value=[],[]}})}function ze(s){W.value=s,t.value.forEach(f=>fe(f)),xe()}return{invoiceItems:t,customer:n,payments:u,salesTeam:D,posProfile:y,posOpeningShift:N,additionalDiscount:q,couponCode:I,taxRules:L,taxInclusive:W,subtotal:Y,totalTax:oe,totalDiscount:pe,grandTotal:re,totalPaid:ve,remainingAmount:b,canSubmit:B,addItem:ne,removeItem:X,updateItemQuantity:i,updateItemRate:C,updateItemDiscount:P,calculateDiscountAmount:V,applyDiscount:te,removeDiscount:Ne,addPayment:De,removePayment:Q,updatePayment:me,validateStock:we,saveDraft:Ee,submitInvoice:ge,resetInvoice:J,clearCart:Ie,setDefaultCustomer:Oe,loadTaxRules:Be,setTaxInclusive:ze,recalculateItem:fe,rebuildIncrementalCache:xe,updateInvoiceResource:h,submitInvoiceResource:$,validateCartItemsResource:j,applyOffersResource:se,getItemDetailsResource:K,getTaxesResource:le}}const mt=()=>({subtotal:0,itemCount:0,itemCodes:[],itemGroups:[],brands:[]});function pt(e){const t=Number.parseFloat(e==null?void 0:e.discount_percentage)||0;return t||Number.parseFloat(e==null?void 0:e.discount_amount)||0}const Eo=at("posOffers",()=>{const e=w([]),t=w(mt()),n=w(!1);function u(o={}){const S=Number.parseFloat(o.subtotal)||0,h=Number.isFinite(o.itemCount)?o.itemCount:0,$=Array.isArray(o.itemCodes)?o.itemCodes:[],j=Array.isArray(o.itemGroups)?o.itemGroups:[],se=Array.isArray(o.brands)?o.brands:[];t.value={subtotal:S,itemCount:h,itemCodes:$,itemGroups:j,brands:se}}function D(){t.value=mt()}function y(o=[]){Array.isArray(o)?e.value=o:e.value=[],n.value=!0}function N(){e.value=[],n.value=!1}function q(o){const S=t.value.subtotal||0,h=t.value.itemCount||0,$=t.value.itemCodes||[],j=t.value.itemGroups||[],se=t.value.brands||[];if(h===0)return{eligible:!1,reason:"Cart is empty"};if(o!=null&&o.min_qty&&h<o.min_qty)return{eligible:!1,reason:__("At least {0} items required",[o.min_qty])};if(o!=null&&o.max_qty&&h>o.max_qty)return{eligible:!1,reason:__("Maximum {0} items allowed for this offer",[o.max_qty])};if(o!=null&&o.min_amt&&S<o.min_amt)return{eligible:!1,reason:__("Minimum cart value of {0} required",[o.min_amt])};if(o!=null&&o.max_amt&&S>o.max_amt)return{eligible:!1,reason:__("Maximum cart value exceeded ({0})",[o.max_amt])};if((o==null?void 0:o.apply_on)==="Item Code"){const K=o.eligible_items||[];if(K.length>0&&!K.some(ee=>$.includes(ee)))return{eligible:!1,reason:__("Cart does not contain eligible items for this offer")}}else if((o==null?void 0:o.apply_on)==="Item Group"){const K=o.eligible_item_groups||[];if(K.length>0&&!K.some(ee=>j.includes(ee)))return{eligible:!1,reason:__("Cart does not contain items from eligible groups")}}else if((o==null?void 0:o.apply_on)==="Brand"){const K=o.eligible_brands||[];if(K.length>0&&!K.some(ee=>se.includes(ee)))return{eligible:!1,reason:"Cart does not contain items from eligible brands"}}return{eligible:!0,reason:null}}const I=m(()=>e.value.filter(o=>o!=null&&o.coupon_based?!1:q(o).eligible)),L=m(()=>[...I.value].sort((o,S)=>pt(S)-pt(o))),W=m(()=>e.value.filter(o=>!(o!=null&&o.auto)||o!=null&&o.coupon_based?!1:q(o).eligible)),F=m(()=>W.value.length);function c(o){const S=t.value.subtotal||0;return o!=null&&o.min_amt&&S<o.min_amt?o.min_amt-S:0}return{availableOffers:e,cartSnapshot:t,hasFetched:n,allEligibleOffers:I,allEligibleOffersSorted:L,autoEligibleOffers:W,autoEligibleCount:F,updateCartSnapshot:u,resetCartSnapshot:D,setAvailableOffers:y,clearOffers:N,checkOfferEligibility:q,getUnlockAmount:c}});function et(e){if(!e)return"";if(Array.isArray(e))return et(e[0]);if(typeof e=="object"&&e!==null)return et(e.message||e.title||e.value);let t=typeof e=="string"?e:String(e);if(typeof window!="undefined"&&typeof document!="undefined"){const n=document.createElement("div");n.innerHTML=t,t=n.textContent||n.innerText||""}else t=t.replace(/<[^>]*>/g," ");return t.replace(/\s+/g," ").trim()}function qo(e){const t={title:__("Error"),message:__("An unexpected error occurred"),type:"error",retryable:!1,technicalDetails:null},n=[];if(e.exc_type&&n.push(__("Type: {0}",[e.exc_type])),(e.httpStatus||e.status)&&n.push(__("Status: {0}",[e.httpStatus||e.status])),e.exception&&n.push(__("Exception: {0}",[e.exception],"Error")),t.technicalDetails=n.length>0?n.join(" | "):null,e.httpStatus===417||e.status===417?(t.type="validation",t.title=__("Validation Error")):e.httpStatus===403||e.status===403?(t.type="error",t.title=__("Permission Denied")):e.httpStatus===404||e.status===404?(t.type="warning",t.title=__("Not Found")):(e.httpStatus>=500||e.status>=500)&&(t.type="error",t.title=__("Server Error")),e.messages&&Array.isArray(e.messages)&&e.messages.length>0)t.message=et(e.messages[0]);else if(e._server_messages)try{const y=JSON.parse(e._server_messages);if(y&&y.length>0){const N=JSON.parse(y[0]);t.message=et(N.message||N.title),N.title&&(t.title=N.title)}}catch(y){console.error("Error parsing _server_messages:",y)}else e.message&&(t.message=et(e.message));const u=(t.message||"").toLowerCase(),D=(e.exc_type||"").toLowerCase();if(D==="negativestockerror"||u.includes("needed in")||u.includes("insufficient stock")||u.includes("negative stock")){t.type="warning",t.title=__("Insufficient Stock");const y=t.message.match(/(\d+\.?\d*)\s+units?\s+of\s+(?:Item\s+)?(.+?)\s+needed\s+in\s+(?:Warehouse\s+)?(.+?)(?:\s+to complete|$)/i);if(y){const[,N,q,I]=y,L=Number.parseFloat(N),W=L===1?"unit":"units";t.message=`Not enough stock for "${q}".

You need ${L} ${W} but the warehouse "${I}" doesn't have enough available.

Please reduce the quantity or check another warehouse.`}else(!t.message||t.message==="An unexpected error occurred")&&(t.message=__(`Not enough stock available in the warehouse.

Please reduce the quantity or check stock availability.`));t.retryable=!0}else D==="validationerror"||t.type==="validation"?(t.type="validation",t.title=__("Validation Error"),t.retryable=!0):u.includes("price list")||u.includes("price not found")?(t.type="warning",t.title=__("Pricing Error"),t.retryable=!0):u.includes("customer")||u.includes("party")?(t.type="validation",t.title=__("Customer Error"),t.retryable=!0):u.includes("tax")||u.includes("account")?(t.type="warning",t.title=__("Tax Configuration Error"),t.retryable=!1):u.includes("payment")||u.includes("mode of payment")?(t.type="validation",t.title=__("Payment Error"),t.retryable=!0):u.includes("series")||u.includes("naming")?(t.type="error",t.title=__("Naming Series Error"),t.retryable=!1):u.includes("permission")||u.includes("not allowed")?(t.type="error",t.title=__("Permission Denied"),t.retryable=!1):u.includes("network")||u.includes("timeout")||u.includes("connection")||u.includes("fetch")?(t.type="warning",t.title=__("Connection Error"),t.message=__("Unable to connect to server. Check your internet connection."),t.retryable=!0):(u.includes("duplicate")||u.includes("already exists"))&&(t.type="validation",t.title=__("Duplicate Entry"),t.retryable=!1);return t}function Po({itemCode:e,qty:t,warehouse:n,actualQty:u=null}){return u!=null?{available:u>=t,actualQty:u}:{available:!0,actualQty:t}}function jo(e,t){return G(this,null,function*(){try{const n=yield Ft("frappe.client.get_value",{doctype:"Bin",filters:{item_code:e,warehouse:t},fieldname:"actual_qty"});return Number.parseFloat((n==null?void 0:n.actual_qty)||0)}catch(n){return console.warn("Failed to fetch stock:",n),0}})}function To(e,t,n,u){const D=t===1?"unit":"units",y=n===1?"unit":"units";return n===0?`"${e}" is out of stock in warehouse "${u}".

Please check another warehouse or restock this item.`:`Not enough stock for "${e}".

You requested ${t} ${D}, but only ${n} ${y} available in "${u}".

Please reduce the quantity or check another warehouse.`}const zo=at("posCart",()=>{const{invoiceItems:e,customer:t,subtotal:n,totalTax:u,totalDiscount:D,grandTotal:y,posProfile:N,posOpeningShift:q,payments:I,salesTeam:L,additionalDiscount:W,taxInclusive:F,addItem:c,removeItem:o,updateItemQuantity:S,submitInvoice:h,clearCart:$,loadTaxRules:j,setTaxInclusive:se,setDefaultCustomer:K,applyDiscount:le,removeDiscount:ee,applyOffersResource:_e,getItemDetailsResource:Y,recalculateItem:oe,rebuildIncrementalCache:pe}=$o(),re=Eo(),ve=yt(),b=w(null),B=w(1),O=w([]),ne=w(null),X=w("uom"),i=w(!1),C=w(!0),{showSuccess:P,showError:V,showWarning:te}=Vt(),Ne=m(()=>e.value.length),$e=m(()=>e.value.length===0),ke=m(()=>!!t.value);function Le(){C.value=!C.value}function xe(l,v=1,p=!1,R=null){const _=l.actual_qty!==void 0||l.stock_qty!==void 0,E=l.is_stock_item||l.is_bundle||_;if(R&&!p&&ve.shouldEnforceStockValidation()&&E&&!l.has_serial_no&&!l.has_batch_no){const z=l.warehouse||R.warehouse,ce=l.actual_qty!==void 0?l.actual_qty:l.stock_qty||0;if(z&&ce!==void 0&&ce!==null){const qe=Po({itemCode:l.item_code,qty:v,warehouse:z,actualQty:ce});if(!qe.available){const Fe=l.is_bundle?"Bundle":"Item",Ve=To(l.item_name,v,qe.actualQty,z);throw new Error(Ve.replace("Item",Fe))}}}c(l,v,C.value)}function fe(){$(),t.value=null,O.value=[],ne.value=null}function De(l){t.value=l}function Q(l,v=1,p="uom"){b.value=l,B.value=v,X.value=p}function me(){b.value=null,B.value=1,X.value="uom"}function we(l){le(l),ne.value=l,P(__("{0} applied successfully",[l.name]))}function Ee(){i.value=!0,O.value=[],ee(),ne.value=null,P(__("Discount has been removed from cart"))}function ge(l){var p,R;const v=Me(e.value);return{doctype:"Sales Invoice",pos_profile:N.value,customer:((p=t.value)==null?void 0:p.name)||t.value||(l==null?void 0:l.customer),company:l==null?void 0:l.company,selling_price_list:l==null?void 0:l.selling_price_list,currency:l==null?void 0:l.currency,discount_amount:W.value||0,coupon_code:((R=ne.value)==null?void 0:R.name)||"",items:v.map(_=>({item_code:_.item_code,item_name:_.item_name,qty:_.quantity,rate:_.rate,uom:_.uom,warehouse:_.warehouse,conversion_factor:_.conversion_factor||1,price_list_rate:_.price_list_rate||_.rate,discount_percentage:_.discount_percentage||0,discount_amount:_.discount_amount||0}))}}function Oe(l){if(!Array.isArray(l))return!1;let v=!1;return e.value.forEach((p,R)=>{const _=l[R]||{},E=Number.parseFloat(_.discount_percentage)||0,z=Number.parseFloat(_.discount_amount)||0,ce=E>0||z>0;(_.pricing_rules&&Array.isArray(_.pricing_rules)&&_.pricing_rules.length>0||ce)&&(p.discount_percentage=E,p.discount_amount=z,p.pricing_rules=_.pricing_rules,v=ce),oe(p)}),pe(),v}function J(l){if(e.value.forEach(v=>{v.free_qty=0}),!(!Array.isArray(l)||l.length===0))for(const v of l){const p=Number.parseFloat(v.qty)||0;if(p<=0)continue;const R=e.value.find(_=>_.item_code===v.item_code&&(_.uom||_.stock_uom)===(v.uom||v.stock_uom));R&&(R.free_qty=p)}}function Ie(l,v=[]){const p=(l==null?void 0:l.message)||l||{};return{items:Array.isArray(p.items)?p.items:[],freeItems:Array.isArray(p.free_items)?p.free_items:[],appliedRules:Array.isArray(p.applied_pricing_rules)&&p.applied_pricing_rules.length?p.applied_pricing_rules:v}}function Be(){return O.value.map(l=>l.code)}function ze(l=[]){if(!Array.isArray(l)||l.length===0){O.value=[];return}O.value=O.value.filter(v=>l.includes(v.code))}function s(l,v,p=null){return G(this,null,function*(){if(!l)return console.error("No offer provided"),p==null||p.resetApplyingState(),!1;const R=l.name,_=Be();if(_.includes(R))return yield f(R,v,p);if(!N.value||e.value.length===0)return te(__("Add items to the cart before applying an offer.")),p==null||p.resetApplyingState(),!1;try{const z=ge(v),ce=[...new Set([..._,R])],qe=yield _e.submit({invoice_data:z,selected_offers:ce}),{items:Fe,freeItems:Ve,appliedRules:Ue}=Ie(qe,_);if(i.value=!0,Oe(Fe),J(Ve),ze(Ue),!Ue.includes(R)){if(_.length)try{const Re=yield _e.submit({invoice_data:z,selected_offers:_}),{items:xt,freeItems:wt,appliedRules:St}=Ie(Re,_);Oe(xt),J(wt),ze(St)}catch(Re){console.error("Error rolling back offers:",Re)}return te(__("Your cart doesn't meet the requirements for this offer.")),p==null||p.resetApplyingState(),!1}const bt=Ue.includes(R)?Ue.filter(Re=>Re===R):[R],ct=O.value.filter(Re=>Re.code!==R);return ct.push({name:l.title||l.name,code:R,offer:l,source:"manual",applied:!0,rules:bt,min_qty:l.min_qty,max_qty:l.max_qty,min_amt:l.min_amt,max_amt:l.max_amt}),O.value=ct,P(__("{0} applied successfully",[l.title||l.name])),!0}catch(z){return console.error("Error applying offer:",z),V(__("Failed to apply offer. Please try again.")),p==null||p.resetApplyingState(),!1}})}function f(l,v=null,p=null){return G(this,null,function*(){const R=typeof l=="string"?l:(l==null?void 0:l.name)||(l==null?void 0:l.code);if(!R)return i.value=!0,O.value=[],J([]),ee(),P(__("Offer has been removed from cart")),p==null||p.resetApplyingState(),!0;const E=O.value.filter(z=>z.code!==R).map(z=>z.code);if(E.length===0)return i.value=!0,O.value=[],J([]),ee(),P(__("Offer has been removed from cart")),p==null||p.resetApplyingState(),!0;try{const z=ge(v),ce=yield _e.submit({invoice_data:z,selected_offers:E}),{items:qe,freeItems:Fe,appliedRules:Ve}=Ie(ce,E);return i.value=!0,Oe(qe),J(Fe),ze(Ve),O.value=O.value.filter(Ue=>E.includes(Ue.code)),P(__("Offer has been removed from cart")),p==null||p.resetApplyingState(),!0}catch(z){return console.error("Error removing offer:",z),V(__("Failed to update cart after removing offer.")),p==null||p.resetApplyingState(),!1}})}function r(l){return G(this,null,function*(){if(e.value.length===0&&O.value.length){O.value=[],J([]);return}if(i.value){i.value=!1;return}if(!(O.value.length===0||e.value.length===0))try{const v=g(),p=[];for(const R of O.value){const _=R.offer;if(!_)continue;re.updateCartSnapshot(v);const{eligible:E,reason:z}=re.checkOfferEligibility(_);E||p.push(Ke(Ge({},R),{reason:z}))}if(p.length>0){const R=O.value.filter(E=>!p.find(z=>z.code===E.code)).map(E=>E.code),_=p.map(E=>E.name).join(", ");if(te(`Offer removed: ${_}. Cart no longer meets requirements.`),R.length===0)i.value=!0,O.value=[],J([]),e.value.forEach(E=>{E.pricing_rules&&E.pricing_rules.length>0&&(E.discount_percentage=0,E.discount_amount=0,E.pricing_rules=[],oe(E))}),pe();else{const E=ge(l),z=yield _e.submit({invoice_data:E,selected_offers:R}),{items:ce,freeItems:qe,appliedRules:Fe}=Ie(z,R);i.value=!0,Oe(ce),J(qe),ze(Fe),O.value=O.value.filter(Ve=>Fe.includes(Ve.code))}}}catch(v){console.error("Error validating offers:",v)}})}function g(){const l=e.value,v=l.reduce((E,z)=>E+(z.quantity||0),0),p=l.map(E=>E.item_code),R=l.map(E=>E.item_group).filter(Boolean),_=l.map(E=>E.brand).filter(Boolean);return{subtotal:n.value,itemCount:v,itemCodes:[...new Set(p)],itemGroups:[...new Set(R)],brands:[...new Set(_)]}}function H(l,v){return G(this,null,function*(){var p,R;try{const _=e.value.find(ce=>ce.item_code===l);if(!_)return;const E=yield Y.submit({item_code:l,pos_profile:N.value,customer:((p=t.value)==null?void 0:p.name)||t.value,qty:_.quantity,uom:v}),z=(R=_.item_uoms)==null?void 0:R.find(ce=>ce.uom===v);_.uom=v,_.conversion_factor=(z==null?void 0:z.conversion_factor)||E.conversion_factor||1,_.rate=E.price_list_rate||E.rate,_.price_list_rate=E.price_list_rate,oe(_),P(__("Unit changed to {0}",[v]))}catch(_){console.error("Error changing UOM:",_),V(__("Failed to update UOM. Please try again."))}})}function A(l,v){return G(this,null,function*(){var p,R;try{const _=e.value.find(E=>E.row_id===l||E.item_code===l);if(!_)throw new Error("Item not found in cart");if(v.uom&&v.uom!==_.uom)try{const E=yield Y.submit({item_code:_.item_code,pos_profile:N.value,customer:((p=t.value)==null?void 0:p.name)||t.value,qty:v.quantity||_.quantity,uom:v.uom}),z=(R=_.item_uoms)==null?void 0:R.find(ce=>ce.uom===v.uom);_.uom=v.uom,_.conversion_factor=(z==null?void 0:z.conversion_factor)||E.conversion_factor||1,_.rate=E.price_list_rate||E.rate,_.price_list_rate=E.price_list_rate}catch(E){console.warn("Failed to fetch UOM details, using provided rate:",E),_.uom=v.uom}return v.quantity!==void 0&&(_.quantity=v.quantity),v.warehouse!==void 0&&(_.warehouse=v.warehouse),v.discount_percentage!==void 0&&(_.discount_percentage=v.discount_percentage),v.discount_amount!==void 0&&(_.discount_amount=v.discount_amount),v.price_list_rate!==void 0&&(_.price_list_rate=v.price_list_rate),v.serial_no!==void 0&&(_.serial_no=v.serial_no),v.comment!==void 0&&(_.comment=v.comment),v.display_comment_in_ui!==void 0&&(_.display_comment_in_ui=v.display_comment_in_ui),oe(_),pe(),P(__("{0} updated successfully",[_.item_name])),!0}catch(_){return console.error("Error updating item details:",_),V(qo(_)||__("Failed to update item. Please try again.")),!1}})}let Z="",ie=[],he=[],x=[];function U(){if(n.value!==void 0&&e.value){const l=e.value.map(p=>p.item_code).join(",");l!==Z&&(ie=e.value.map(p=>p.item_code),he=[...new Set(e.value.map(p=>p.item_group).filter(Boolean))],x=[...new Set(e.value.map(p=>p.brand).filter(Boolean))],Z=l);const v=e.value.reduce((p,R)=>p+(R.quantity||0),0);re.updateCartSnapshot({subtotal:n.value,itemCount:v,itemCodes:ie,itemGroups:he,brands:x})}}return nt([n,()=>e.value.map(l=>`${l.item_code}:${l.quantity}`).join(",")],()=>G(void 0,null,function*(){var l;if(yield Lt(),U(),O.value.length>0&&N.value){const v={customer:((l=t.value)==null?void 0:l.name)||t.value,company:N.value.company,selling_price_list:N.value.selling_price_list,currency:N.value.currency};yield r(v)}}),{immediate:!0,flush:"post"}),{invoiceItems:e,customer:t,subtotal:n,totalTax:u,totalDiscount:D,grandTotal:y,posProfile:N,posOpeningShift:q,payments:I,salesTeam:L,additionalDiscount:W,taxInclusive:F,pendingItem:b,pendingItemQty:B,appliedOffers:O,appliedCoupon:ne,selectionMode:X,suppressOfferReapply:i,itemCount:Ne,isEmpty:$e,hasCustomer:ke,groupingEnabled:C,toggleGrouping:Le,addItem:xe,removeItem:o,updateItemQuantity:S,clearCart:fe,setCustomer:De,setDefaultCustomer:K,setPendingItem:Q,clearPendingItem:me,loadTaxRules:j,setTaxInclusive:se,submitInvoice:h,applyDiscountToCart:we,removeDiscountFromCart:Ee,applyOffer:s,removeOffer:f,reapplyOffer:r,changeItemUOM:H,updateItemDetails:A,getItemDetailsResource:Y,recalculateItem:oe,rebuildIncrementalCache:pe,applyOffersResource:_e,buildInvoiceDataForOffers:ge}}),tt=w(new Set),Xe=w(0);function de(e){if(!e)throw new Error("useDialog requires a unique dialogId");const t=w(!1),n=y=>{y&&!t.value?(tt.value.add(e),Xe.value++):!y&&t.value&&(tt.value.delete(e),Xe.value--),t.value=y},u=m(()=>Xe.value>0),D=()=>{t.value&&(tt.value.delete(e),Xe.value--)};return{isOpen:m({get:()=>t.value,set:n}),isAnyDialogOpen:ot(u),cleanup:D,open:()=>n(!0),close:()=>n(!1),toggle:()=>n(!t.value)}}function No(){const e=m(()=>Xe.value>0),t=m(()=>tt.value.size);return{isAnyDialogOpen:ot(e),activeCount:ot(t),activeDialogIds:ot(m(()=>Array.from(tt.value)))}}const st=320,vt=360,Uo=at("posUI",()=>{const e=w(!0),{isOpen:t}=de("payment"),{isOpen:n}=de("customer"),{isOpen:u}=de("success"),{isOpen:D}=de("openShift"),{isOpen:y}=de("closeShift"),{isOpen:N}=de("draft"),{isOpen:q}=de("return"),{isOpen:I}=de("coupon"),{isOpen:L}=de("offers"),{isOpen:W}=de("batchSerial"),{isOpen:F}=de("history"),{isOpen:c}=de("offlineInvoices"),{isOpen:o}=de("createCustomer"),{isOpen:S}=de("clearCart"),{isOpen:h}=de("logout"),{isOpen:$}=de("itemSelection"),{isOpen:j}=de("invoiceError"),{isAnyDialogOpen:se}=No(),K=w(""),le=w(""),ee=w(""),_e=w("error"),Y=w(null),oe=w(null),pe=w(""),re=w(0),ve=w(""),b=w("items"),B=w(typeof window!="undefined"?window.innerWidth:1024),O=w(800),ne=w(!1),X=m(()=>B.value>=1024);function i(Q){e.value=Q}function C(Q){B.value=Q}function P(Q){b.value=Q}function V(Q,me,we="",Ee=null,ge=null){K.value=Q,le.value=me,ee.value=we,Y.value=Ee,oe.value=ge,j.value=!0}function te(){K.value="",le.value="",ee.value="",Y.value=null,oe.value=null,j.value=!1}function Ne(Q,me){pe.value=Q,re.value=me,u.value=!0}function $e(Q){ve.value=Q}function ke(Q,me){const we=Number.isFinite(me)&&me>0?me:st+vt,Ee=Math.max(st,we-vt),ge=Math.min(Math.max(Q,st),Ee);return Number.isFinite(ge)?ge:st}function Le(Q,me=null){if(me!==null){const we=ke(Q,me);O.value=we}else O.value=Q}function xe(Q){ne.value=Q}function fe(Q){Q&&(O.value=ke(O.value,Q))}function De(){t.value=!1,n.value=!1,u.value=!1,D.value=!1,y.value=!1,N.value=!1,q.value=!1,I.value=!1,L.value=!1,W.value=!1,F.value=!1,c.value=!1,o.value=!1,S.value=!1,h.value=!1,$.value=!1,j.value=!1,te()}return{isLoading:e,showPaymentDialog:t,showCustomerDialog:n,showSuccessDialog:u,showOpenShiftDialog:D,showCloseShiftDialog:y,showDraftDialog:N,showReturnDialog:q,showCouponDialog:I,showOffersDialog:L,showBatchSerialDialog:W,showHistoryDialog:F,showOfflineInvoicesDialog:c,showCreateCustomerDialog:o,showClearCartDialog:S,showLogoutDialog:h,showItemSelectionDialog:$,showErrorDialog:j,isAnyDialogOpen:se,errorDialogTitle:K,errorDialogMessage:le,errorDetails:ee,errorType:_e,errorRetryAction:Y,errorRetryActionData:oe,lastInvoiceName:pe,lastInvoiceTotal:re,initialCustomerName:ve,mobileActiveTab:b,windowWidth:B,leftPanelWidth:O,isResizing:ne,isDesktop:X,setLoading:i,setWindowWidth:C,setMobileTab:P,showError:V,clearError:te,showSuccess:Ne,setInitialCustomerName:$e,setLeftPanelWidth:Le,setResizing:xe,updateLayoutBounds:fe,clampLeftPanelWidth:ke,resetAllDialogs:De}});export{_t as _,yt as a,ht as b,Uo as c,Vo as d,Ps as e,bo as f,$o as g,jo as h,Eo as i,Mo as j,Ro as k,qo as p,So as s,zo as u};
